<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ãƒªã‚¹ã®ã‚¯ãƒƒã‚­ãƒ¼ã‚„ã•ã‚“</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<style>

/* ===== å±¥æ­´ãƒ»å°ãƒ‡ãƒ¼ã‚¿å…±é€š ===== */
#machineData th, #machineData td,
#recordList th, #recordList td {
  white-space: normal; /* æŠ˜ã‚Šè¿”ã—æœ‰åŠ¹ */
  word-break: break-word;
  text-align: center;
  padding: 4px;
}

/* âœ… è‡ªå‹•å¹…ã«æˆ»ã™ */
table {
  table-layout: auto;
  width: 100%;
}

  .highlight-row {
    background-color: #fff7cc; /* å¥½ããªè‰²ã«å¤‰æ›´OK */
    transition: background-color 0.2s ease;
  }

</style>

<body class="bg-gray-100 p-4 min-h-screen">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-2xl shadow-lg">

    <!-- ã‚¿ãƒ–åˆ‡æ›¿ -->
    <div class="flex border-b mb-4 bg-white sticky top-0 z-50">
      <button class="tab-button px-4 py-2 border-b-2 border-blue-500 font-semibold text-blue-500" data-tab="input">å…¥åŠ›</button>
      <button class="tab-button px-4 py-2 text-gray-500" data-tab="history">å±¥æ­´</button>
      <button class="tab-button px-4 py-2 text-gray-500" data-tab="summary">é›†è¨ˆ</button>
      <button class="tab-button px-4 py-2 text-gray-500" data-tab="machineData">å°ãƒ‡ãƒ¼ã‚¿</button>
    </div>

    <!-- å…¥åŠ›ã‚¿ãƒ– -->
    <div id="input" class="tab-content">
      <form id="recordForm" class="space-y-3">
<!-- 1è¡Œç›®ï¼šæ—¥ä»˜120pxã€åº—åæ®‹ã‚Šã€å°ç•ªå·1/4å¹… -->
<div class="flex gap-2">
  <div class="flex-none w-3/16">
    <input type="date" id="date" class="border rounded w-full p-2" required>
  </div>
  <div class="flex-1">
    <input type="text" id="shop" class="border rounded w-full p-2" placeholder="åº—å" value="ã‚¨ã‚¹ãƒ‘ã‚¹é«˜ç”°é¦¬å ´">
  </div>
  <div class="flex-none w-1/4">
    <input type="number" id="machineNo" class="border rounded w-full p-2" placeholder="å°ç•ªå·" inputmode="numeric" pattern="[0-9]*">
  </div>
</div>

        <!-- 2è¡Œç›® -->
        <div class="grid grid-cols-5 gap-2">
          <div class="col-span-3"><input type="text" id="machineName" class="border rounded w-full p-2" placeholder="æ©Ÿç¨®å"></div>
          <div class="col-span-2">
            <select id="gameType" class="border rounded w-full p-2">
              <option value="slot5">5å††ã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="slot46">46æšã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="pachi1">1å††ãƒ‘ãƒãƒ³ã‚³</option>
              <option value="pachi4">4å††ãƒ‘ãƒãƒ³ã‚³</option>
            </select>
          </div>
        </div>

        <!-- 3è¡Œç›® -->
<div class="grid grid-cols-3 gap-2">
  <!-- é–‹å§‹Gæ•° -->
  <div>
    <label class="block text-sm font-semibold">é–‹å§‹Gæ•°</label>
    <input type="number" id="startGame" class="border rounded w-full p-2" inputmode="numeric" pattern="[0-9]*">
  </div>

  <!-- é–‹å§‹æ™‚ç‰æ•° -->
  <div>
    <label class="block text-sm font-semibold">é–‹å§‹æ™‚ç‰æ•°</label>
    <input type="number" id="startBall" class="border rounded w-full p-2" inputmode="numeric" pattern="[0-9]*">
  </div>

  <!-- ä»–å£åº§æŒ¯æ›¿ + ç¾é‡‘è¿½åŠ ç‰ï¼ˆç¸¦ã«ä¸¦ã¹ã‚‹ï¼‰ -->
  <div class="flex flex-col gap-2">
    <!-- ä»–å£åº§æŒ¯æ›¿ -->
    <div>
      <label class="block text-sm font-semibold">ä»–å£åº§æŒ¯æ›¿</label>
      <input type="number" id="transfarBall" class="border rounded w-full p-2" value="0" inputmode="numeric" pattern="[0-9]*">
      <div class="flex justify-between mt-1">
        <button type="button" id="decTransfar" class="bg-blue-500 text-white rounded px-3 py-1 w-1/2 mr-1">-</button>
        <button type="button" id="incTransfar" class="bg-blue-500 text-white rounded px-3 py-1 w-1/2">+</button>
      </div>
    </div>

    <!-- ç¾é‡‘è¿½åŠ ç‰ -->
    <div>
      <label class="block text-sm font-semibold">ç¾é‡‘è¿½åŠ ç‰</label>
      <input type="number" id="cashBall" class="border rounded w-full p-2" value="0" inputmode="numeric" pattern="[0-9]*">
      <div class="flex justify-between mt-1">
        <button type="button" id="decCash" class="bg-pink-500 text-white rounded px-3 py-1 w-1/2 mr-1">-</button>
        <button type="button" id="incCash" class="bg-pink-500 text-white rounded px-3 py-1 w-1/2">+</button>
      </div>
    </div>
  </div>
</div>

<!-- 5è¡Œç›® -->
        <div class="grid grid-cols-6 gap-2 items-end">
          <div class="col-span-2">
            <label class="block text-sm font-semibold">åˆå½“ã‚Š/ãƒ¤ãƒ¡Gæ•°</label>
            <input type="number" id="firstHitGame" class="border rounded w-full p-2" inputmode="numeric" pattern="[0-9]*">
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-semibold">åˆå½“ã‚Šæ™‚ç‰æ•°<label class="ml-2">
  <input type="checkbox" id="isSingleBonus"> å˜ç™ºBçµ‚äº†
</label></label>
            <input type="text" id="firstHitBall" class="border rounded w-full p-2" inputmode="numeric" pattern="[0-9]*">
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-semibold">çµ‚äº†æ™‚ç‰æ•°</label>
            <input type="number" id="endBall" class="border rounded w-full p-2 bg-pink-50" inputmode="numeric" pattern="[0-9]*">
          </div>
        </div>

<!-- å‚™è€ƒæ¬„ -->
  <div class="flex-1">
    <input type="text" id="remarks" class="border rounded w-full p-2" placeholder="å‚™è€ƒ">
  </div>

<!-- å›è»¢ç‡ãƒ»åæ”¯ + ç™»éŒ²ãƒœã‚¿ãƒ³ -->
<div class="mt-2 text-lg font-bold">
  <div class="flex justify-between">
    <div id="rotationDisplay">å›è»¢ç‡ï¼š<br>0.00</div>
    <div id="incomeDisplay">ç¾åœ¨åæ”¯ï¼š<br>0ï¼ˆ0å††ï¼‰</div>
  </div>
  <div class="flex justify-between mt-2">
    <button type="button" id="clearBtn" class="bg-gray-400 hover:bg-gray-500 text-white rounded w-16 py-1">ã‚¯ãƒªã‚¢</button>
    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white rounded w-16 py-1">ç™»éŒ²</button>
  </div>
</div>

      </form>
    </div>

<!-- å±¥æ­´ã‚¿ãƒ– -->
<div id="history" class="tab-content hidden">
    <div id="historyPagination" class="mb-2 flex justify-center gap-1"></div>
  <div class="overflow-x-auto max-h-[75vh] overflow-y-auto">
    <table class="border text-sm min-w-[800px] table-fixed">
      <colgroup>
        <col style="width: 30px;">  <!-- æ—¥ä»˜ -->
        <col style="width: 45px;"> <!-- åº—å -->
        <col style="width: 30px;">  <!-- å°ç•ª -->
        <col style="width: 80px;"> <!-- æ©Ÿç¨®å -->
        <col style="width: 30px;">  <!-- ç¨®åˆ¥ -->
        <col style="width: 45px;">  <!-- åˆå½“ã‚ŠG -->
        <col style="width: 15px;">  <!-- ãƒœãƒ¼ãƒŠã‚¹ç¨®åˆ¥ -->
        <col style="width: 40px;">  <!-- å›è»¢ç‡ -->
        <col style="width: 30px;">  <!-- æŠ•è³‡ -->
        <col style="width: 30px;">  <!-- å‡ºç‰ -->
        <col style="width: 55px;">  <!-- åæ”¯ -->
        <col style="width: 30px;">  <!-- ç·¨é›† -->
        <col style="width: 15px;">  <!-- å‰Šé™¤ -->
        <col style="width: 80px;">  <!-- å‚™è€ƒ -->
      </colgroup>
      <thead class="bg-gray-200 sticky top-0 z-10">
        <tr>
          <th class="border p-1">æ—¥ä»˜</th>
          <th class="border p-1">åº—å</th>
          <th class="border p-1">å°ç•ª</th>
          <th class="border p-1">æ©Ÿç¨®å</th>
          <th class="border p-1">ç¨®åˆ¥</th>
          <th class="border p-1">åˆå½“ã‚ŠG<br>ï¼ˆè‡ªGï¼‰</th>
          <th class="border p-1">B</th>
          <th class="border p-1">å›è»¢ç‡</th>
          <th class="border p-1">æŠ•è³‡ç‰</th>
          <th class="border p-1">å‡ºç‰</th>
          <th class="border p-1">åæ”¯</th>
          <th class="border p-1">ç·¨é›†</th>
          <th class="border p-1">å‰Šé™¤</th>
          <th class="border p-1">å‚™è€ƒ</th>
        </tr>
      </thead>
      <tbody id="recordList"></tbody>
    </table>
  </div>
</div>



<!-- ç·¨é›†ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editModal" class="fixed inset-0 bg-black/50 hidden justify-center items-center z-50">
  <div class="bg-white p-6 rounded shadow-lg w-96">
    <h2 class="text-lg font-bold mb-4">ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ </h2>
    <form id="editForm" class="space-y-3">

      <!-- æ—¥ä»˜ãƒ»åº—å -->
      <div class="flex gap-2">
        <div class="flex-none w-1/3">
          <input type="date" name="date" class="border p-2 w-full">
        </div>
        <div class="flex-none w-1/3">
          <input type="text" name="shop" class="border p-2 w-full" placeholder="åº—å">
        </div>
       <div class="flex-none w-1/3">
          <select id="gameType" class="border rounded w-full p-2">
              <option value="slot5">5å††ã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="slot46">46æšã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="pachi1">1å††ãƒ‘ãƒãƒ³ã‚³</option>
              <option value="pachi4">4å††ãƒ‘ãƒãƒ³ã‚³</option>
            </select>
        </div>
      </div>

      <!-- å°ç•ªãƒ»æ©Ÿç¨®å -->
      <div class="flex gap-2">
        <div class="flex-none w-1/4">
          <input type="number" name="machineNo" class="border p-1 w-full" placeholder="å°ç•ª" inputmode="numeric" pattern="[0-9]">
        </div>
        <div class="flex-none w-3/4">
          <input type="text" name="machineName" class="border p-1 w-full" placeholder="æ©Ÿç¨®å">
        </div>
      </div>

      <!-- é–‹å§‹Gæ•°ãƒ»é–‹å§‹æ™‚ç‰æ•° -->
      <div class="flex gap-2">
        <div class="flex-none w-1/2">
          <label class="block">é–‹å§‹Gæ•°</label>
          <input type="number" name="startGame" class="border p-1 w-full" inputmode="numeric" pattern="[0-9]">
        </div>
        <div class="flex-none w-1/2">
          <label class="block">é–‹å§‹æ™‚ç‰æ•°</label>
          <input type="number" name="startBall" class="border p-1 w-full" inputmode="numeric" pattern="[0-9]">
        </div>
      </div>


      <!-- ä»–å£åº§æŒ¯æ›¿ãƒ»ç¾é‡‘è¿½åŠ ç‰ -->
      <div class="flex gap-2">
        <div class="flex-none w-1/2">
          <label class="block">ä»–å£åº§æŒ¯æ›¿</label>
          <input id="transfarBall" type="number" name="transfarBall" class="border p-1 w-full" inputmode="numeric" pattern="[0-9]">
        </div>
        <div class="flex-none w-1/2">
          <label class="block">ç¾é‡‘è¿½åŠ ç‰</label>
          <input id="cashBall" type="number" name="cashBall" class="border p-1 w-full" inputmode="numeric" pattern="[0-9]">
        </div>
      </div>

      <!-- åˆå½“ã‚Š/ãƒ¤ãƒ¡Gæ•°ãƒ»åˆå½“ã‚Šæ™‚ç‰æ•° -->
      <div class="flex gap-2">
        <div class="flex-none w-1/2">
          <label class="block">åˆå½“ã‚Š/ãƒ¤ãƒ¡Gæ•°</label>
          <input type="number" name="firstHitGame" class="border p-1 w-full" inputmode="numeric" pattern="[0-9]">
        </div>
        <div class="flex-none w-1/2">
          <label class="block">åˆå½“ã‚Šæ™‚ç‰æ•°</label>
          <input type="number" name="firstHitBall" class="border p-1 w-full" inputmode="numeric" pattern="[0-9]">
        </div>
      </div>

      <!-- å˜ç™ºãƒœãƒ¼ãƒŠã‚¹çµ‚äº† -->
      <div class="flex justify-end">
        <label class="mr-2">å˜ç™ºãƒœãƒ¼ãƒŠã‚¹çµ‚äº†</label>
        <input type="checkbox" name="isSingleBonus" class="border p-1">
      </div>

      <!-- çµ‚äº†æ™‚ç‰æ•° -->
      <div class="flex gap-2">
        <div class="flex-none w-1/2">
          <label class="block">addBall</label>
          <input type="number" name="addBall" class="border p-1 w-full" disabled>
        </div>
        <div class="flex-none w-1/2">
          <label class="block">çµ‚äº†æ™‚ç‰æ•°</label>
          <input type="number" name="endBall" class="border p-1 w-full" inputmode="numeric" pattern="[0-9]">
        </div>
      </div>

      <!-- å‚™è€ƒ -->
      <div class="flex gap-2">
          <input type="text" name="remarks" class="border p-1 w-full" placeholder="å‚™è€ƒ">
      </div>

      <!-- ãƒœã‚¿ãƒ³ -->
      <div class="flex justify-end gap-2 mt-4">
        <button type="button" id="closeModal" class="px-3 py-1 bg-gray-300 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">ä¿å­˜</button>
      </div>

    </form>
  </div>
</div>



    <!-- é›†è¨ˆã‚¿ãƒ– -->
    <div id="summary" class="tab-content hidden">
      <div class="space-y-3">
        <div class="text-lg font-semibold">ç·åæ”¯ï¼ˆå††ï¼‰ï¼š<span id="totalYen" class="font-bold text-blue-600">0</span></div>
<div class="text-lg font-semibold">
  ç¾åœ¨è³‡ç”£æ®‹é«˜ï¼ˆå††ï¼‰ï¼š<span id="totalAssetYen" class="font-bold text-green-600">0å††</span>
</div>

<div class="mb-2">
  <label class="mr-2 text-sm">åº—èˆ—é¸æŠ:</label>
  <select id="shopFilter" class="border rounded p-1 text-sm">
    <option value="all">å…¨åº—èˆ—</option>
  </select>
</div>

        <div class="grid grid-cols-2 gap-2 text-sm">
          <div>46æšã‚¹ãƒ­æ®‹é«˜ï¼š<span id="bal46">0</span></div>
          <div>5å††ã‚¹ãƒ­æ®‹é«˜ï¼š<span id="bal5">0</span></div>
          <div>4å††ãƒ‘ãƒæ®‹é«˜ï¼š<span id="bal4">0</span></div>
          <div>1å††ãƒ‘ãƒæ®‹é«˜ï¼š<span id="bal1">0</span></div>
        </div>

        <div class="flex space-x-2 mt-4">
          <button class="period-btn bg-blue-500 text-white rounded px-3 py-1" data-period="1">ç›´è¿‘1ãƒ¶æœˆ</button>
          <button class="period-btn bg-gray-300 rounded px-3 py-1" data-period="3">ç›´è¿‘3ãƒ¶æœˆ</button>
          <button class="period-btn bg-gray-300 rounded px-3 py-1" data-period="6">ç›´è¿‘åŠå¹´</button>
          <button class="period-btn bg-gray-300 rounded px-3 py-1" data-period="all">å…¨æœŸé–“</button>
        </div>

        <canvas id="chart" height="200"></canvas>
      </div>


<div class="flex gap-2 items-center justify-center mt-2">
<form id="withdrawForm" class="p-2 border rounded bg-gray-50 mt-4">
  <h3 class="font-bold mb-1">å‡ºé‡‘å‡¦ç†</h3>
  <div class="flex flex-wrap gap-2 items-center text-sm">
    <label><input type="date" name="date" class="border p-1 rounded"></label>
    <label>
      <select name="shop" class="border p-1 rounded"></select>
    </label>
    <label>
      <select name="gameType" class="border p-1 rounded">
        <option value="pachi1">1å††ãƒ‘ãƒãƒ³ã‚³</option>
        <option value="pachi4">4å††ãƒ‘ãƒãƒ³ã‚³</option>
        <option value="slot5">5å††ã‚¹ãƒ­ãƒƒãƒˆ</option>
        <option value="slot46">46æšã‚¹ãƒ­ãƒƒãƒˆ</option>
      </select>
    </label>
    <label>ç‰æ•°ï¼æšæ•°ï¼š<input type="number" name="ball" class="border p-1 rounded w-24"></label>
    <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">å‡ºé‡‘</button>
  </div>
</form>
</div>



<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
      <div id="calendarContainer" class="mt-4"></div>

<!-- é›†è¨ˆã‚¿ãƒ–æœ€ä¸‹éƒ¨ã«è¿½åŠ  -->
<div class="flex justify-between items-center mt-4">
  <!-- å·¦å´ï¼šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
  <div class="flex gap-2">
    <button id="exportBtn" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button id="importBtn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    <input type="file" id="importFile" accept=".json" class="hidden">
  </div>

  <!-- å³å´ï¼šå…¨å‰Šé™¤ -->
  <div>
    <button id="clearAllBtn" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">å…¨å‰Šé™¤</button>
  </div>
</div>


    </div>

    <!-- å°ãƒ‡ãƒ¼ã‚¿ã‚¿ãƒ– -->
    <div id="machineData" class="tab-content hidden">
      <div class="space-y-3">
        <form class="grid grid-cols-5 gap-2 items-end">
          <div><input type="text" id="searchShop" class="border rounded w-full p-2" placeholder="åº—å"></div>
          <div><input type="text" id="searchMachineNo" class="border rounded w-full p-2" placeholder="å°ç•ªå·"></div>
          <div><input type="text" id="searchMachineName" class="border rounded w-full p-2" placeholder="æ©Ÿç¨®å"></div>
          <div>
            <select id="searchGameType" class="border rounded w-full p-2">
              <option value="">å…¨ã¦ã®ç¨®åˆ¥</option>
              <option value="slot5">5å††ã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="slot46">46æšã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="pachi1">1å††ãƒ‘ãƒãƒ³ã‚³</option>
              <option value="pachi4">4å††ãƒ‘ãƒãƒ³ã‚³</option>
            </select>
          </div>

          <div>  
          <button id="searchMachineBtn" class="bg-blue-500 text-white rounded px-3 py-1">æ¤œç´¢</button></div>
        </form>

  <div class="overflow-x-auto">
  <div class="overflow-x-auto max-h-[70vh] overflow-y-auto">
    <table class="border text-sm min-w-[800px] table-fixed mt-2">
      <colgroup>
        <col style="width: 45px;"> <!-- åº—å -->
        <col style="width: 30px;">  <!-- å°ç•ª -->
        <col style="width: 80px;"> <!-- æ©Ÿç¨®å -->
        <col style="width: 30px;">  <!-- ç¨®åˆ¥ -->
        <col style="width: 25px;">  <!-- ãƒ—ãƒ¬ã‚¤æ•° -->
        <col style="width: 25px;">  <!-- åˆå½“ã‚Š -->
        <col style="width: 30px;">  <!-- çªå…¥ç‡ -->
        <col style="width: 45px;">  <!-- å¹³å‡å›è»¢ç‡ -->
        <col style="width: 40px;">  <!-- å¹³å‡å½“G -->
        <col style="width: 50px;">  <!-- å¹³å‡å½“æŠ•è³‡ -->
        <col style="width: 55px;">  <!-- åˆè¨ˆåæ”¯ -->
        <col style="width: 40px;">  <!-- æœ€å¤§å‡ºç‰ -->
        <col style="width: 40px;">  <!-- å›åç‡ -->
      </colgroup>
      <thead class="bg-gray-200 sticky top-0 z-10">
        <tr>
<th class="border p-1" data-key="shop">åº—å</th>
<th class="border p-1" data-key="machineNo">å°ç•ª</th>
<th class="border p-1" data-key="machineName">æ©Ÿç¨®å</th>
<th class="border p-1" data-key="gameType">ç¨®åˆ¥</th>
<th class="border p-1" data-key="playCount">ãƒ—ãƒ¬ã‚¤æ•°</th>
<th class="border p-1" data-key="firstHitCount">åˆ<br>å½“ã‚Š</th>
<th class="border p-1" data-key="penetrationRate">çªå…¥ç‡</th>
<th class="border p-1" data-key="avgRotation">å¹³å‡<br>å›è»¢ç‡</th>
<th class="border p-1" data-key="avgFirstHitG">å¹³å‡<br>å½“G</th>
<th class="border p-1" data-key="avgInvest">å¹³å‡<br>å¿…è¦æŠ•è³‡ç‰</th>
<th class="border p-1" data-key="totalIncomeYen">åˆè¨ˆåæ”¯</th>
<th class="border p-1" data-key="maxOutBall">æœ€å¤§<br>å‡ºç‰</th>
<th class="border p-1" data-key="recoveryRate">å›åç‡</th>
        </tr>
      </thead>
      <tbody id="machineDataList"></tbody>
    </table>
  </div>
</div>

<script>
/* ===== JavaScript å®Œå…¨ç‰ˆ ===== */
document.addEventListener('touchstart', function(event) {
  if (event.touches.length > 1) {
    event.preventDefault();
  }
}, { passive: false });

let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
  const now = new Date().getTime();
  if (now - lastTouchEnd <= 300) {
    event.preventDefault();
  }
  lastTouchEnd = now;
}, false);

const fmt1 = v => (isNaN(v) || v === null || v === "") ? "-" : Number(v).toFixed(1);
const key = "pachi_records";
// 1ç‰ãƒ»1æšã‚ãŸã‚Šã®å††æ›ç®—ãƒ¬ãƒ¼ãƒˆ
const rate = {
  pachi1: 0.892,    // 1å††ãƒ‘ãƒãƒ³ã‚³
  pachi4: 3.568,    // 4å††ãƒ‘ãƒãƒ³ã‚³
  slot46: 19.23,    // 46æšã‚¹ãƒ­ãƒƒãƒˆ
  slot5: 4.42       // 5å††ã‚¹ãƒ­ãƒƒãƒˆ
};

const transfarRate = {
  slot5:   { target: "slot46", from: "slot5", rate: 23/100 },   // 5å††ã‚¹ãƒ­ â†’ 46æšã‚¹ãƒ­
  slot46:  { target: "slot5",  from: "slot46", rate: 200/46 },  // 46æšã‚¹ãƒ­ â†’ 5å††ã‚¹ãƒ­
  pachi4:  { target: "pachi1", from: "pachi4", rate: 500/125 }, // 4å††P â†’ 1å††P
  pachi1:  { target: "pachi4", from: "pachi1", rate: 25/100 }   // 1å††P â†’ 4å††P
};

const step = {pachi4:125, pachi1:100, slot46:46, slot5:100};
const investUnit = {pachi4:250, pachi1:200, slot46:46, slot5:50};

const dateInput = document.getElementById("date");
const today = new Date();
dateInput.value = today.toISOString().slice(0,10);

// ã‚¿ãƒ–åˆ‡æ›¿
document.querySelectorAll(".tab-button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    // å…¨ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll(".tab-button").forEach(b=>{
      b.classList.remove("border-blue-500","text-blue-500","font-semibold","bg-blue-100");
      b.classList.add("text-gray-500");
    });
    // é¸æŠä¸­ã‚¿ãƒ–ã‚’å¼·èª¿
    btn.classList.add("border-blue-500","text-blue-500","font-semibold","bg-blue-100");
    btn.classList.remove("text-gray-500");

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ‡æ›¿
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.add("hidden"));
    document.getElementById(btn.dataset.tab).classList.remove("hidden");

    // å„ã‚¿ãƒ–èª­ã¿è¾¼ã¿å‡¦ç†
    if(btn.dataset.tab==="history") loadRecords();
    if(btn.dataset.tab==="summary") updateSummary();
    updateSummaryTab();
    if(btn.dataset.tab==="machineData") loadMachineData();
  });
});


// å…¥åŠ›å‡¦ç†
const form = document.getElementById("recordForm");
const transfarInput = document.getElementById("transfarBall");
const cashInput = document.getElementById("cashBall");
const gameTypeSelect = document.getElementById("gameType");

function updateSelectColor() {
  switch (gameTypeSelect.value) {
    case "slot5":
      gameTypeSelect.classList.remove("bg-blue-200","bg-green-200","bg-yellow-200");
      gameTypeSelect.classList.add("bg-blue-200");
      break;
    case "slot46":
      gameTypeSelect.classList.remove("bg-red-200","bg-green-200","bg-yellow-200");
      gameTypeSelect.classList.add("bg-red-200");
      break;
    case "pachi1":
      gameTypeSelect.classList.remove("bg-red-200","bg-blue-200","bg-yellow-200");
      gameTypeSelect.classList.add("bg-green-200");
      break;
    case "pachi4":
      gameTypeSelect.classList.remove("bg-red-200","bg-blue-200","bg-green-200");
      gameTypeSelect.classList.add("bg-yellow-200");
      break;
    default:
      gameTypeSelect.classList.remove("bg-red-200","bg-blue-200","bg-green-200","bg-yellow-200");
  }
}

// åˆæœŸè¡¨ç¤ºç”¨
updateSelectColor();

// ===== ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢ =====
["incTransfar", "decTransfar", "incCash", "decCash"].forEach(id => {
  const btn = document.getElementById(id);
  if (btn) btn.style.touchAction = "manipulation";
});

// å€¤å¤‰æ›´æ™‚
gameTypeSelect.addEventListener("change", updateSelectColor);

document.getElementById("incTransfar").addEventListener("click",()=>{
  const type = gameTypeSelect.value;
  transfarInput.value = Number(transfarInput.value||0) + (step[type]||0);
  updateIncome();
});
document.getElementById("decTransfar").addEventListener("click",()=>{
  const type = gameTypeSelect.value;
  transfarInput.value = Math.max(0, Number(transfarInput.value||0) - (step[type]||0));
  updateIncome();
});

document.getElementById("incCash").addEventListener("click",()=>{
  const type = gameTypeSelect.value;
  cashInput.value = Number(cashInput.value||0) + (step[type]||0);
  updateIncome();
});
document.getElementById("decCash").addEventListener("click",()=>{
  const type = gameTypeSelect.value;
  cashInput.value = Math.max(0, Number(cashInput.value||0) - (step[type]||0));
  updateIncome();
});

function updateIncome() {
  const startBall = Number(form.startBall.value) || 0;
  const endBall = Number(form.endBall.value) || 0;
  const transfarBall = Number(transfarInput.value) || 0;
const cashBall = Number(cashInput.value) || 0;
const addBall = transfarBall + cashBall;
const isSingleBonus = document.getElementById("isSingleBonus").checked;
  const firstHitBall = form.firstHitBall.value === "" ? null : Number(form.firstHitBall.value);
  const startG = Number(form.startGame.value) || 0;
  const endG = Number(form.firstHitGame.value) || 0;
  const type = form.gameType.value;

  // ä½¿ç”¨ç‰æ•°ï¼ˆåˆå½“ã‚Šç‰æ•°ãŒç©ºæ¬„ â†’ çµ‚äº†æ™‚ç‰æ•°ã‚’ä½¿ã†ï¼‰
  let usedBalls;
  if (firstHitBall === null || isNaN(firstHitBall)) {
    usedBalls = (startBall + addBall) - endBall;
  } else {
    usedBalls = (startBall + addBall) - firstHitBall;
  }
  if (usedBalls < 0) usedBalls = 0;

  // å›è»¢ç‡è¨ˆç®—
  const totalG = endG - startG;
  let rotationRate = 0;
  let rateUnit = "";

  if (usedBalls > 0 && totalG > 0) {
    switch (type) {
      case "slot46":
        rotationRate = (totalG / usedBalls) * 46;
        rateUnit = "/46æš";
        break;
      case "slot5":
        rotationRate = (totalG / usedBalls) * 50;
        rateUnit = "/50æš";
        break;
      case "pachi1":
        rotationRate = (totalG / usedBalls) * 200;
        rateUnit = "/200ç‰";
        break;
      case "pachi4":
        rotationRate = (totalG / usedBalls) * 250;
        rateUnit = "/250ç‰";
        break;
    }
  }

  document.getElementById("rotationDisplay").innerHTML =
  "å›è»¢ç‡ï¼š<br>" + (rotationRate ? rotationRate.toFixed(1) + "å›" + rateUnit : "-");

  // åæ”¯
  const diff = endBall - (startBall + addBall);
  const yen = rate[type] ? Math.round(diff * rate[type]) : 0;
  document.getElementById("incomeDisplay").innerHTML =  "ç¾åœ¨åæ”¯ï¼ˆå††ï¼‰ï¼š<br>" + (diff + "ï¼ˆ" + yen + "å††ï¼‰");
}

["startBall","endBall","transfarBall","cashBall","startGame","gameType","firstHitBall","firstHitGame"].forEach(id=>{
  document.getElementById(id).addEventListener("input",updateIncome);
});



// ===== å…¥åŠ›é€”ä¸­ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ä¿å­˜ =====
const formBackupKey = "recordFormBackup";

// ğŸ”¹ å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
form.addEventListener("input", () => {
  const backup = {
    date: form.date.value,
    shop: form.shop.value,
    machineNo: form.machineNo.value,
    machineName: form.machineName.value,
    gameType: form.gameType.value,
    startGame: form.startGame.value,
    startBall: form.startBall.value,
    transfarBall: transfarInput.value,
    cashBall: cashInput.value,
    firstHitGame: form.firstHitGame.value,
    firstHitBall: form.firstHitBall.value,
    endBall: form.endBall.value,
    remarks: form.remarks.value,
    isSingleBonus: document.getElementById("isSingleBonus").checked
  };
  localStorage.setItem(formBackupKey, JSON.stringify(backup));
});

// ğŸ”¹ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒ
window.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem(formBackupKey);
  if (saved) {
    const b = JSON.parse(saved);
    form.date.value = b.date || new Date().toISOString().slice(0, 10);
    form.shop.value = b.shop || "";
    form.machineNo.value = b.machineNo || "";
    form.machineName.value = b.machineName || "";
    form.gameType.value = b.gameType || "slot5";
    form.startGame.value = b.startGame || "";
    form.startBall.value = b.startBall || "";
    transfarInput.value = b.transfarBall || 0;
    cashInput.value = b.cashBall || 0;
    form.firstHitGame.value = b.firstHitGame || "";
    form.firstHitBall.value = b.firstHitBall || "";
    form.endBall.value = b.endBall || "";
    form.remarks.value = b.remarks || "";
    document.getElementById("isSingleBonus").checked = !!b.isSingleBonus;
    updateSelectColor();
    updateIncome();
  }
});

// ğŸ”¹ ç™»éŒ²å®Œäº†æ™‚ãƒ»ã‚¯ãƒªã‚¢æ™‚ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤
form.addEventListener("submit", () => {
  localStorage.removeItem(formBackupKey);
});
clearBtn.addEventListener("click", () => {
  localStorage.removeItem(formBackupKey);
});



// ç™»éŒ²ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
form.addEventListener("submit", (e) => {
  e.preventDefault();
  const isSingleBonus = document.getElementById("isSingleBonus").checked; // â† ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç›´æ¥å–å¾—


  if (!form.endBall.value) {
    alert("çµ‚äº†æ™‚ç‰æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  if (isSingleBonus && !form.firstHitBall.value) {
    alert("å˜ç™ºãƒœãƒ¼ãƒŠã‚¹åˆå½“ã‚Šæ™‚ç‰æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  if (!confirm("ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) return;

  const record = {
    date: form.date.value,
    shop: form.shop.value || "",
    machineNo: form.machineNo.value || "",
    machineName: form.machineName.value || "",
    gameType: form.gameType.value,
    startGame: Number(form.startGame.value) || 0,
    startBall: Number(form.startBall.value) || 0,
    addBall: (Number(transfarInput.value) || 0) + (Number(cashInput.value) || 0),
    transfarBall: Number(form.transfarBall?.value || 0),
    cashBall: Number(form.cashBall?.value || 0),
    firstHitGame: Number(form.firstHitGame.value) || 0,
    firstHitBall: form.firstHitBall.value === "" ? null : Number(form.firstHitBall.value),
    isSingleBonus: isSingleBonus, // â†è¿½åŠ 
    endBall: Number(form.endBall.value) || 0,
    created: new Date().toISOString(),
    remarks: form.remarks.value || "",
  };




// === å‡ºç‰ãƒ»å›è»¢ç‡ãƒ»åæ”¯ãªã©ã®è¨ˆç®— ===

// åˆå½“ã‚Šç‰æ•°ãŒç©ºæ¬„ãªã‚‰ãƒ¤ãƒ¡æ‰±ã„
const isYame = (form.firstHitBall.value === "" || form.firstHitBall.value === null);
record.firstHitBall = isYame ? null : Number(form.firstHitBall.value);
record.isYame = isYame;

// å‡ºç‰
record.outBall = record.firstHitBall === null
  ? 0
  : Math.max(0, record.endBall - record.firstHitBall);

// æŠ•è³‡ç‰æ•°
const usedBalls = record.firstHitBall === null
  ? (record.startBall + record.addBall - record.endBall)
  : (record.startBall + record.addBall - record.firstHitBall);

// ç·å›è»¢æ•°
const totalG = (record.firstHitGame && record.firstHitGame > 0 ? record.firstHitGame : record.endBall) - record.startGame;

// ç¨®åˆ¥ã«å¿œã˜ãŸå›è»¢ç‡ã®åŸºæº–
const investUnit = {
  slot46: 46,
  slot5: 50,
  pachi1: 200,
  pachi4: 250
};

const base = investUnit[record.gameType] || 0;
record.rotation = (usedBalls > 0 && totalG > 0)
  ? Number(((totalG * base) / usedBalls).toFixed(1))
  : 0;

// åæ”¯ï¼ˆå††æ›ç®—ï¼‰
const rate = {
  slot46: 19.23,
  slot5: 4.42,
  pachi1: 0.892,
  pachi4: 3.568
};

const diff = record.endBall - (record.startBall + record.addBall);
record.incomeYen = rate[record.gameType] ? Math.round(diff * rate[record.gameType]) : 0;
record.incomeText = `${diff}ï¼ˆ${record.incomeYen.toLocaleString()}å††ï¼‰`;


  // === ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ ===
  const data = JSON.parse(localStorage.getItem(key) || "[]");
  data.push(record);
  localStorage.setItem(key, JSON.stringify(data));

  // å‰å›å…¥åŠ›å€¤ã‚’ä¿æŒ
  localStorage.setItem("lastShop", record.shop);
  localStorage.setItem("lastMachineNo", record.machineNo);
  localStorage.setItem("lastModelName", record.machineName);
  localStorage.setItem("lastGameType", record.gameType);
  localStorage.setItem("lastDate", record.date);
  localStorage.setItem("lastEndBall", record.endBall); // æ¬¡å›é–‹å§‹ç‰æ•°ã«è»¢è¨˜ç”¨

  // === ç™»éŒ²å¾Œã®UIæ›´æ–°ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆãªã—ï¼‰ ===
  loadRecords();
  updateSummary();  // ã‚°ãƒ©ãƒ•æ›´æ–°
  updateBalances(); // ç‰æ•°æ®‹é«˜æ›´æ–°

  // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆç›´å‰ã®è¨­å®šã¯ä¿æŒï¼‰
  form.reset();
  form.shop.value = localStorage.getItem("lastShop") || "";
  form.machineNo.value = localStorage.getItem("lastMachineNo") || "";
  form.machineName.value = localStorage.getItem("lastModelName") || "";
  form.gameType.value = localStorage.getItem("lastGameType") || "slot5";
  form.date.value = localStorage.getItem("lastDate") || new Date().toISOString().slice(0,10);
  form.startBall.value = localStorage.getItem("lastEndBall") || 0;
  // ç™»éŒ²å¾Œãƒªã‚»ãƒƒãƒˆæ™‚ã« addBallInput ã‚’å‚ç…§ã—ãªã„
transfarInput.value = 0;
cashInput.value = 0;

  updateIncome();

  // âœ… ã€Œç™»éŒ²ã—ã¾ã—ãŸã€ã‚’ã‚¢ãƒ©ãƒ¼ãƒˆã§ã¯ãªãä¸€æ™‚çš„ãªUIè¡¨ç¤º
  const msg = document.createElement("div");
  msg.textContent = "ç™»éŒ²ã—ã¾ã—ãŸ";
  msg.className = "fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg text-sm";
  document.body.appendChild(msg);
  setTimeout(() => msg.remove(), 1500);
});


// ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
clearBtn.addEventListener("click", () => {
  if (!confirm("å…¥åŠ›å†…å®¹ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;

  localStorage.removeItem("lastShop");
  localStorage.removeItem("lastMachineNo");
  localStorage.removeItem("lastModelName");
  localStorage.removeItem("lastGameType");
  localStorage.removeItem("lastDate");
  localStorage.removeItem("lastEndBall");

  form.reset();

  // âœ… æ—¥ä»˜ã‚’æœ¬æ—¥ã«æˆ»ã™
  const today = new Date().toISOString().slice(0, 10);
  form.date.value = today;

  // âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å†è¨­å®š
  form.shop.value = "ã‚¨ã‚¹ãƒ‘ã‚¹é«˜ç”°é¦¬å ´";
  form.addBall.value = 0;

  // âœ… ç¨®åˆ¥ã‚’5å††ã‚¹ãƒ­ãƒƒãƒˆã«æˆ»ã™ & èƒŒæ™¯è‰²ã‚’blue-200ã«
  const gameTypeSelect = form.gameType;
  gameTypeSelect.value = "slot5";
  gameTypeSelect.classList.remove("bg-red-200", "bg-green-200", "bg-yellow-200");
  gameTypeSelect.classList.add("bg-blue-200");

  // âœ… æ®‹ã‚Šã®UIæ›´æ–°
  updateIncome();
});


// ===== å±¥æ­´ =====
let currentPage = 1;
const pageSize = 200;

// ===== ãƒšãƒ¼ã‚¸ãƒ³ã‚°æç”» =====
function renderPagination(totalPages, currentPage = 1) {
  const pagination = document.getElementById("historyPagination");
  if (!pagination) return;
  pagination.innerHTML = "";

  if (totalPages <= 1) return;

  const createBtn = (text, page, disabled = false) => {
    const btn = document.createElement("button");
    btn.textContent = text;
    btn.disabled = disabled;
    btn.className = `px-2 py-0.5 m-1 rounded ${disabled ? "opacity-50 cursor-not-allowed" : "bg-gray-200"}`;
    if (!disabled) btn.addEventListener("click", () => loadRecords(page));
    return btn;
  };

  pagination.appendChild(createBtn("â—€", currentPage - 1, currentPage === 1));

  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, startPage + 4);
  if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

  if (startPage > 1) {
    pagination.appendChild(createBtn(1, 1));
    if (startPage > 2) {
      const span = document.createElement("span");
      span.textContent = "...";
      span.className = "px-2";
      pagination.appendChild(span);
    }
  }

  for (let i = startPage; i <= endPage; i++) {
    const btn = createBtn(i, i);
    if (i === currentPage) btn.className = "px-2 py-0.5 m-1 rounded bg-gray-400 text-white";
    pagination.appendChild(btn);
  }

  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      const span = document.createElement("span");
      span.textContent = "...";
      span.className = "px-2";
      pagination.appendChild(span);
    }
    pagination.appendChild(createBtn(totalPages, totalPages));
  }

  pagination.appendChild(createBtn("â–¶", currentPage + 1, currentPage === totalPages));
}

// ===== ãƒ¬ã‚³ãƒ¼ãƒ‰æç”» =====
function loadRecords(page = 1) {
  currentPage = page;
  const tbody = document.getElementById("recordList");
  tbody.innerHTML = "";

  const records = JSON.parse(localStorage.getItem(key) || "[]");
  const sorted = records.slice().sort((a, b) => {
    const dateDiff = new Date(b.date) - new Date(a.date);
    if (dateDiff !== 0) return dateDiff;
    return (a.created || 0) < (b.created || 0) ? 1 : -1;
  });

  const totalPages = Math.ceil(sorted.length / pageSize);
  const pageData = sorted.slice((currentPage - 1) * pageSize, currentPage * pageSize);

  const typeColors = { slot5: "bg-blue-200", slot46: "bg-red-200", pachi1: "bg-green-200", pachi4: "bg-yellow-200" };
  const rotationUnit = { slot46: "/46æš", slot5: "/50æš", pachi1: "/200ç‰", pachi4: "/250ç‰" };
  const typeLabelMap = { pachi4: "4å††P", pachi1: "1å††P", slot46: "46æšS", slot5: "5å††S" };

  pageData.forEach(r => {
    const tr = document.createElement("tr");
    const originalIndex = records.findIndex(rec => rec.created === r.created);
    const bonusText = r.isSingleBonus ? "å˜ç™º" : (r.firstHitBall === null ? "-" : "");
    const bonusCellClass = r.isSingleBonus || r.firstHitBall === null ? "bg-gray-300" : "";
    const rotationText = (typeof r.rotation === "number" ? r.rotation.toFixed(1) : "0.0") + "<br>" + (rotationUnit[r.gameType] || "");
    const incomeText = r.incomeText ? r.incomeText.replace('ï¼ˆ', '<br>ï¼ˆ') : "0<br>ï¼ˆ0å††ï¼‰";
    const firstHitDisplay = r.isYame ? "ãƒ¤ãƒ¡" : r.firstHitGame;
    const selfG = r.firstHitGame - r.startGame;

    tr.innerHTML = `
      <td class="border p-1">${r.date?.slice(5) || ""}</td>
      <td class="border p-1">${r.shop || ""}</td>
      <td class="border p-1">${(r.machineNo || "").replace(/\D/g, "")}</td>
      <td class="border p-1">${r.machineName || ""}</td>
      <td class="border p-1 ${typeColors[r.gameType] || ""}">${typeLabelMap[r.gameType] || ""}</td>
      <td class="border p-1 ${r.isYame ? 'bg-gray-300' : ''}">${firstHitDisplay}<br>ï¼ˆ${selfG}ï¼‰</td>
      <td class="border p-1 ${bonusCellClass}">${bonusText}</td>
      <td class="border p-1">${rotationText}</td>
      <td class="border p-1 text-right">${r.firstHitBall != null ? (r.startBall + r.addBall - r.firstHitBall) : (r.startBall + r.addBall - r.endBall)}</td>
      <td class="border p-1 text-right">${r.outBall || 0}</td>
      <td class="border p-1 text-right ${r.incomeYen < 0 ? "text-red-500" : ""}">${incomeText}</td>
      <td class="border p-1 text-center">
        <button class="bg-yellow-300 px-2 py-0.5 rounded text-xs edit-btn" data-index="${originalIndex}">ç·¨é›†</button>
      </td>
      <td class="border p-1 text-center bg-yellow-200">
        <button class="delete-btn text-red-500" data-index="${originalIndex}">å‰Šé™¤</button>
      </td>
      <td class="border p-1 text-xs">${r.remarks || ""}</td>
    `;
    tbody.appendChild(tr);
  });

  renderPagination(totalPages, currentPage);

  // è¡Œãƒã‚¤ãƒ©ã‚¤ãƒˆ
  tbody.querySelectorAll("tr").forEach(tr => {
    tr.addEventListener("click", () => {
      tbody.querySelectorAll(".highlight-row").forEach(row => row.classList.remove("highlight-row"));
      tr.classList.add("highlight-row");
    });
  });

  setupEditDeleteEvents();
}





// ===== ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ =====
function setupEditDeleteEvents() {
  const editModal = document.getElementById("editModal");
  const editForm = document.getElementById("editForm");
  const closeModal = document.getElementById("closeModal");
  const typeColors = { slot5: "bg-blue-200", slot46: "bg-red-200", pachi1: "bg-green-200", pachi4: "bg-yellow-200" };

  if (!editForm) {
    console.error("âŒ editForm ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚HTMLã®idã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  function applyTypeColor() {
    editForm.gameType.classList.remove(...Object.values(typeColors));
    const selectedType = editForm.gameType.value;
    if (typeColors[selectedType]) editForm.gameType.classList.add(typeColors[selectedType]);
  }

  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.removeEventListener("click", btn._editHandler);
    const handler = () => {
      const idx = Number(btn.dataset.index);
      const records = JSON.parse(localStorage.getItem(key) || "[]");
      const r = records[idx];
      if (!r) return;

      // âœ… è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹é€æ¬¡ç¢ºèª
      if (editForm.elements["date"]) editForm.elements["date"].value = r.date || "";
      if (editForm.elements["shop"]) editForm.elements["shop"].value = r.shop || "";
      if (editForm.elements["gameType"]) editForm.elements["gameType"].value = r.gameType || "slot5";
      if (editForm.elements["machineNo"]) editForm.elements["machineNo"].value = r.machineNo || "";
      if (editForm.elements["machineName"]) editForm.elements["machineName"].value = r.machineName || "";
      if (editForm.elements["startGame"]) editForm.elements["startGame"].value = r.startGame || 0;
      if (editForm.elements["startBall"]) editForm.elements["startBall"].value = r.startBall || 0;
      if (editForm.elements["addBall"]) editForm.elements["addBall"].value = r.addBall || 0;

      // âœ… å­˜åœ¨ã—ãªã„å ´åˆã¯0ã§åˆæœŸåŒ–
      if (editForm.elements["transfarBall"]) editForm.elements["transfarBall"].value = Number(r.transfarBall ?? 0);
      if (editForm.elements["cashBall"]) editForm.elements["cashBall"].value = Number(r.cashBall ?? 0);

      if (editForm.elements["firstHitGame"]) editForm.elements["firstHitGame"].value = r.firstHitGame || 0;
      if (editForm.elements["firstHitBall"]) editForm.elements["firstHitBall"].value = r.firstHitBall ?? "";
      if (editForm.elements["isSingleBonus"]) editForm.elements["isSingleBonus"].checked = !!r.isSingleBonus;
      if (editForm.elements["endBall"]) editForm.elements["endBall"].value = r.endBall || 0;
      if (editForm.elements["remarks"]) editForm.elements["remarks"].value = r.remarks || "";

      editForm.dataset.editIndex = idx;
      applyTypeColor();

      editModal.classList.remove("hidden");
      editModal.classList.add("flex");
    };
    btn.addEventListener("click", handler);
    btn._editHandler = handler;
  });

  // å‰Šé™¤ãƒœã‚¿ãƒ³
  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.removeEventListener("click", btn._deleteHandler);
    const handler = () => {
      if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      const idx = Number(btn.dataset.index);
      const data = JSON.parse(localStorage.getItem(key) || "[]");
      if (idx >= 0 && idx < data.length) {
        data.splice(idx, 1);
        localStorage.setItem(key, JSON.stringify(data));
        loadRecords(currentPage);
      }
    };
    btn.addEventListener("click", handler);
    btn._deleteHandler = handler;
  });

  // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
  closeModal.addEventListener("click", () => {
    editModal.classList.add("hidden");
    editModal.classList.remove("flex");
  });

  // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  editForm.addEventListener("submit", e => {
    e.preventDefault();
    const records = JSON.parse(localStorage.getItem(key) || "[]");
    const idx = Number(editForm.dataset.editIndex);
    if (idx < 0 || idx >= records.length) return;

    const updated = {
      date: editForm.date.value,
      shop: editForm.shop.value,
      machineNo: editForm.machineNo.value,
      machineName: editForm.machineName.value,
      gameType: editForm.gameType?.value || records[idx].gameType,
      startGame: Number(editForm.startGame.value) || 0,
      startBall: Number(editForm.startBall.value) || 0,
      addBall: Number(editForm.addBall.value) || 0,
      transfarBall: Number(editForm.transfarBall?.value || 0),
      cashBall: Number(editForm.cashBall?.value || 0),
      firstHitGame: Number(editForm.firstHitGame.value) || 0,
      firstHitBall: editForm.firstHitBall.value === "" ? null : Number(editForm.firstHitBall.value),
      isSingleBonus: editForm.isSingleBonus.checked,
      endBall: Number(editForm.endBall.value) || 0,
      remarks: editForm.remarks.value,
      created: records[idx].created
    };

    const isYame = updated.firstHitBall === null;
    updated.isYame = isYame;
    updated.addBall = updated.transfarBall + updated.cashBall;
    updated.outBall = isYame ? 0 : Math.max(0, updated.endBall - updated.firstHitBall);
    const usedBalls = isYame ? (updated.startBall + updated.addBall - updated.endBall) : (updated.startBall + updated.addBall - updated.firstHitBall);
    const totalG = (updated.firstHitGame && updated.firstHitGame > 0 ? updated.firstHitGame : updated.endBall) - updated.startGame;
    const investUnit = {slot46:46, slot5:50, pachi1:200, pachi4:250};
    const base = investUnit[updated.gameType] || 0;
    updated.rotation = (usedBalls > 0 && totalG > 0) ? Number(((totalG * base)/usedBalls).toFixed(1)) : 0;

    const rate = {slot46:19.23, slot5:4.42, pachi1:0.892, pachi4:3.568};
    const diff = updated.endBall - (updated.startBall + updated.addBall);
    updated.incomeYen = rate[updated.gameType] ? Math.round(diff * rate[updated.gameType]) : 0;
    updated.incomeText = `${diff}ï¼ˆ${updated.incomeYen.toLocaleString()}å††ï¼‰`;

    records[idx] = updated;
    localStorage.setItem(key, JSON.stringify(records));

    editModal.classList.add("hidden");
    editModal.classList.remove("flex");

    updateBalances(document.getElementById("shopFilter").value);
    updateSummary();
  });
}













// ===== æ®‹é«˜è¨ˆç®—ï¼ˆæ•´ç†ç‰ˆï¼‰ =====
function updateBalances(selectedShop = "all") {
  const data = JSON.parse(localStorage.getItem(key) || "[]");

  const balances = { slot46:0, slot5:0, pachi4:0, pachi1:0 };
  const rate = { slot46:19.23, slot5:4.42, pachi4:3.568, pachi1:0.892 };

  data.forEach(r => {
    if (!r.gameType || balances[r.gameType] === undefined) return;
    if (selectedShop !== "all" && r.shop !== selectedShop) return;

    const type = r.gameType;

    // ===== ä»–å£åº§æŒ¯æ›¿ã«ã‚ˆã‚‹æ®‹é«˜èª¿æ•´ =====
    if (r.transfarBall && r.transfarBall > 0) {
      const amount = Number(r.transfarBall);
      let sourceType = null;
      let rate = 1;

      switch(type) {
        case "pachi1": sourceType="pachi4"; rate=1000/250; break;
        case "pachi4": sourceType="pachi1"; rate=250/1000; break;
        case "slot5":  sourceType="slot46"; rate=200/46; break;
        case "slot46": sourceType="slot5";  rate=46/200; break;
      }

      // å…ƒå£åº§ã‚’åŒåº—èˆ—ã§æ¸›ç®—
      if (sourceType && balances[sourceType] !== undefined) {
        balances[sourceType] -= Math.round(amount * rate);
      }

      // æŒ¯æ›¿å…ˆã«åŠ ç®—
      balances[type] += amount;
    }

    // ===== å‡ºé‡‘å‡¦ç† =====
    if (r.machineName === "å‡ºé‡‘") {
      const wBall = Number(r.withdrawBall || 0);
      if (wBall) balances[type] -= wBall;
      return; // å‡ºé‡‘ã¯åæ”¯å·®åˆ†ã‚’åŠ ãˆãªã„
    }

    // ===== é€šå¸¸åæ”¯å‡¦ç† =====
    // diff ã¯ startBall + addBall (æŒ¯æ›¿è¾¼ã¿) ã«å¯¾ã—ã¦ endBall ã®å·®
    const diff = (r.endBall || 0) - ((r.startBall || 0) + (r.addBall || 0));
    balances[type] += diff;
  });

  // ===== DOMåæ˜  =====
  document.getElementById("bal46").textContent = balances.slot46.toLocaleString() + "æš";
  document.getElementById("bal5").textContent  = balances.slot5.toLocaleString() + "æš";
  document.getElementById("bal4").textContent  = balances.pachi4.toLocaleString() + "ç‰";
  document.getElementById("bal1").textContent  = balances.pachi1.toLocaleString() + "ç‰";

  // å††æ›ç®—æ®‹é«˜
  let totalAssetYen = 0;
  for (const t of ["slot46","slot5","pachi4","pachi1"]) {
    totalAssetYen += Math.round((balances[t] || 0) * (rate[t] || 0));
  }
  document.getElementById("totalAssetYen").textContent = totalAssetYen.toLocaleString() + "å††";
}





// ===== é›†è¨ˆï¼ˆã‚°ãƒ©ãƒ•ï¼‹æœŸé–“åˆ¥é›†è¨ˆï¼‰ =====
let chart;
let currentPeriod = "1"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé–“ï¼š1ãƒ¶æœˆ

function updateSummary(period = currentPeriod) {
  currentPeriod = period; // ç¾åœ¨æœŸé–“ã‚’æ›´æ–°
  const data = JSON.parse(localStorage.getItem(key) || "[]");
  const now = new Date();
  const selectedShop = document.getElementById("shopFilter")?.value || "all";

  // åº—èˆ—ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
  const shopSelect = document.getElementById("shopFilter");
  if (shopSelect) {
    const shops = [...new Set(data.map(r => r.shop).filter(s => s && s.trim() !== ""))];
    const current = shopSelect.value;
    shopSelect.innerHTML = `<option value="all">å…¨åº—èˆ—</option>` +
      shops.map(s => `<option value="${s}" ${s === current ? "selected" : ""}>${s}</option>`).join("");
  }

  // ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæœŸé–“ï¼‹åº—èˆ—ï¼‰
  const filtered = data.filter(r => {
    if (period !== "all") {
      const d = new Date(r.date);
      const diffM = (now - d) / (1000 * 60 * 60 * 24 * 30);
      if (diffM > Number(period)) return false;
    }
    if (selectedShop !== "all" && r.shop !== selectedShop) return false;
    return true;
  });

  // æ—¥åˆ¥ç´¯è¨ˆ
  const dailySum = {};
  filtered.forEach(r => {
    const day = r.date;
    if (!dailySum[day]) dailySum[day] = 0;
    dailySum[day] += r.incomeYen || 0;
  });

  // æ—¥ä»˜é †ã«ä¸¦ã¹ã¦ç´¯ç©
  const dates = Object.keys(dailySum).sort();
  let sum = 0;
  const sumArr = [];
  const labels = [];
  dates.forEach(d => {
    sum += dailySum[d];
    sumArr.push(sum);
    const dt = new Date(d);
    labels.push(`${dt.getMonth() + 1}/${dt.getDate()}`);
  });

  // ã‚°ãƒ©ãƒ•æç”»
  const ctx = document.getElementById("chart").getContext("2d");
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "åæ”¯æ¨ç§»",
        data: sumArr,
        borderColor: "blue",
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: { y: { beginAtZero: true } }
    }
  });

  // ===== ç·åæ”¯ï¼ˆå¸¸ã«å…¨æœŸé–“ãƒ»å…¨åº—èˆ—ï¼‰ =====
  const totalAll = data.reduce((acc, r) => acc + (r.incomeYen || 0), 0);
  document.getElementById("totalYen").textContent = totalAll.toLocaleString() + "å††";


  // æ®‹é«˜ã¯å…¨æœŸé–“å¯¾è±¡
  updateBalances(selectedShop);
}


// ===== åº—èˆ—ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¤‰æ›´æ™‚ =====
document.getElementById("shopFilter").addEventListener("change", e => {
  const selectedShop = e.target.value;
  updateBalances(selectedShop);
  updateSummary(currentPeriod); // æœŸé–“ã‚’ä¿æŒã—ãŸã¾ã¾æ›´æ–°
});


// ===== æœŸé–“ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ =====
document.querySelectorAll(".period-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".period-btn").forEach(b =>
      b.classList.replace("bg-blue-500", "bg-gray-300")
    );
    btn.classList.replace("bg-gray-300", "bg-blue-500");
    currentPeriod = btn.dataset.period;
    updateSummary(currentPeriod);
  });
});


// ===== åˆå›ãƒ­ãƒ¼ãƒ‰ =====
document.addEventListener("DOMContentLoaded", () => {
  updateSummary("1"); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼š1ãƒ¶æœˆ
});



// ===== ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã§ã®ä¿å­˜å‡¦ç† =====
editForm.addEventListener("submit", e => {
  e.preventDefault();

  const records = JSON.parse(localStorage.getItem(key) || "[]");
  const idx = Number(editForm.dataset.editIndex);
  if (idx < 0 || idx >= records.length) return;

  const updated = {
    date: editForm.date.value,
    shop: editForm.shop.value,
    machineNo: editForm.machineNo.value,
    machineName: editForm.machineName.value,
    gameType: editForm.gameType?.value || records[idx].gameType,
    startGame: Number(editForm.startGame.value) || 0,
    startBall: Number(editForm.startBall.value) || 0,
    addBall: Number(editForm.addBall.value) || 0,
    transfarBall: Number(editForm.transfarBall.value) || 0,
    transfarSource: editForm.transfarSource?.value || "",
    cashBall: Number(editForm.cashBall.value) || 0,
    firstHitGame: Number(editForm.firstHitGame.value) || 0,
    firstHitBall: editForm.firstHitBall.value === "" ? null : Number(editForm.firstHitBall.value),
    isSingleBonus: editForm.isSingleBonus.checked,
    endBall: Number(editForm.endBall.value) || 0,
    remarks: editForm.remarks.value,
    created: records[idx].created
  };

  // è¨ˆç®—
  const isYame = updated.firstHitBall === null;
  updated.isYame = isYame;
  updated.addBall = updated.transfarBall + updated.cashBall;
  const investUnit = { slot46:46, slot5:50, pachi1:200, pachi4:250 };
  const usedBalls = isYame
    ? (updated.startBall + updated.addBall - updated.endBall)
    : (updated.startBall + updated.addBall - updated.firstHitBall);
  const totalG = (updated.firstHitGame && updated.firstHitGame > 0 ? updated.firstHitGame : updated.endBall) - updated.startGame;
  const base = investUnit[updated.gameType] || 0;
  updated.rotation = (usedBalls > 0 && totalG > 0)
    ? Number(((totalG * base) / usedBalls).toFixed(1))
    : 0;

  const rateMap = { slot46:19.23, slot5:4.42, pachi1:0.892, pachi4:3.568 };
  const diff = updated.endBall - (updated.startBall + updated.addBall);
  updated.incomeYen = Math.round((rateMap[updated.gameType] || 0) * diff);
  updated.incomeText = `${diff}ï¼ˆ${updated.incomeYen.toLocaleString()}å††ï¼‰`;

  records[idx] = updated;
  localStorage.setItem(key, JSON.stringify(records));

  // ãƒ†ãƒ¼ãƒ–ãƒ«è©²å½“è¡Œã ã‘æ›´æ–°
  const row = document.querySelector(`tr[data-index="${idx}"]`);
  if (row) {
    row.querySelector("td:nth-child(1)").textContent = updated.date;
    row.querySelector("td:nth-child(2)").textContent = updated.shop;
    row.querySelector("td:nth-child(3)").textContent = updated.machineNo;
    row.querySelector("td:nth-child(4)").textContent = updated.machineName;
    row.querySelector("td:nth-child(5)").textContent = updated.gameType;
    row.querySelector("td:nth-child(6)").textContent = updated.startBall;
    row.querySelector("td:nth-child(7)").textContent = updated.addBall;
    row.querySelector("td:nth-child(8)").textContent = updated.endBall;
    row.querySelector("td:nth-child(9)").textContent = updated.incomeText;
    row.querySelector("td:nth-child(10)").textContent = updated.rotation;
    row.querySelector("td:nth-child(11)").textContent = updated.remarks || "";
  }

  // é›†è¨ˆæ›´æ–°
  const currentShop = document.getElementById("shopFilter").value || "all";
  updateBalances(currentShop);
  updateSummary(currentPeriod);

  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
  editModal.classList.add("hidden");
});



// ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆç½®æ›ç”¨ï¼‰ =====

// addBall -> å††æ›ç®—ãƒ¬ãƒ¼ãƒˆï¼ˆå®šç¾©ã©ãŠã‚Šï¼‰
const addBallToYen = {
  pachi1: 1000 / 1000,    // 1å††P: 1000ç‰ = 1000å†† => 1ç‰ = 1å††
  pachi4: 1000 / 250,     // 4å††P: 250ç‰ = 1000å†† => 1ç‰ = 4å††
  slot5:  1000 / 200,     // 5å††S: 200æš = 1000å†† => 1æš = 5å††
  slot46: 1000 / 46       // 46æšS: 46æš = 1000å†† => 1æš = 1000/46å††
};

let calYear = (new Date()).getFullYear();
let calMonth = (new Date()).getMonth() + 1; // 1..12

function buildMonthOptions(records) {
  // distinct year-month present in records (plus current month)
  const set = new Set();
  records.forEach(r => {
    if (!r.date) return;
    try {
      const d = new Date(r.date);
      if (isNaN(d)) return;
      set.add(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);
    } catch(e){}
  });
  // always ensure current month exists
  set.add(`${(new Date()).getFullYear()}-${String((new Date()).getMonth()+1).padStart(2,'0')}`);
  const arr = Array.from(set).sort().reverse(); // æ–°ã—ã„é †
  return arr;
}

function renderCalendar(year, month) {
  const container = document.getElementById("calendarContainer");
  const records = JSON.parse(localStorage.getItem(key) || "[]");

  // header with prev/next and select
  const monthLabel = `${year}/${String(month).padStart(2,'0')}`;
  // build select options from records
  const monthOptions = buildMonthOptions(records);

//è¨ˆç®—å‡¦ç†ã‚’å…ˆã«
// filter records for the (year,month)
  const filtered = records.filter(r => {
    if (!r.date) return false;
    const d = new Date(r.date);
    if (isNaN(d)) return false;
    return d.getFullYear() === Number(year) && (d.getMonth()+1) === Number(month);
  });

  // group by yyyy-mm-dd string
  const byDate = {};
  filtered.forEach(r => {
    const dateStr = r.date; // expected "YYYY-MM-DD"
    if (!byDate[dateStr]) byDate[dateStr] = [];
    byDate[dateStr].push(r);
  });

  // compute daily summaries
  const daily = {}; // dateStr -> { income, cash }
  Object.keys(byDate).forEach(dateStr => {
    const recs = byDate[dateStr];
    let incomeSum = 0;
    let cashSum = 0;

    recs.forEach(r => {
      // incomeYen if present; otherwise compute from balls & rate (fallback)
      const incomeYen = (typeof r.incomeYen === "number") ? r.incomeYen
        : (() => {
            // fallback compute: diffBalls * rate (use main rate mapping if exists)
            const rateMap = { pachi1:0.892, pachi4:3.568, slot5:4.42, slot46:19.23 };
            const diffBall = (Number(r.endBall)||0) - ((Number(r.startBall)||0) + (Number(r.addBall)||0));
            const rt = rateMap[r.gameType] || 0;
            return Math.round(diffBall * rt);
          })();

      incomeSum += incomeYen;

// æ–°ã—ã„å‡¦ç†ï¼ˆwithdrawYen ãŒã‚ã‚Œã°ãã‚Œã‚’åŠ ç®—ï¼‰
if (r.machineName === "å‡ºé‡‘") {
  const wy = Number(r.withdrawYen || 0);
  if (wy) cashSum += wy; // å‡ºé‡‘ã¯ç¾é‡‘å¢—ãªã®ã§ cashSum ã«ãƒ—ãƒ©ã‚¹
}

      // ç¾é‡‘è¿½åŠ ç‰(cashBall)ã®ç¾é‡‘æ›ç®—ã‚’ãƒã‚¤ãƒŠã‚¹ï¼ˆç¾é‡‘æ¸›ï¼‰
const cash = Number(r.cashBall || 0);
if (cash && r.gameType && addBallToYen[r.gameType]) {
  const cashYen = Math.round(cash * addBallToYen[r.gameType]);
  cashSum -= cashYen; // ç¾é‡‘â†’ç‰ï¼ˆå‡ºé‡‘æ‰±ã„ï¼‰ãªã®ã§ç¾é‡‘ã‚’æ¸›ç®—
}

    });

    daily[dateStr] = { income: incomeSum, cash: cashSum };
  });


  // monthly totals
  const monthlyIncome = Object.values(daily).reduce((a,b)=>a + (b.income||0), 0);
  const monthlyCash = Object.values(daily).reduce((a,b)=>a + (b.cash||0), 0);



  let headerHtml = `
  <div class="flex items-start justify-between mb-2">
    <!-- å·¦å´ï¼šæœˆç§»å‹• + ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
    <div class="flex items-center gap-2">
      <button id="calPrev" class="px-2 py-1 rounded bg-gray-200">â—€</button>
      <div class="text-lg font-bold" id="calTitle">${monthLabel}</div>
      <button id="calNext" class="px-2 py-1 rounded bg-gray-200">â–¶</button>
      <select id="calMonthSelect" class="border p-1 rounded text-sm ml-2">
        ${monthOptions.map(m => {
          const [y,mo] = m.split("-");
          const sel = (Number(y)===year && Number(mo)===month) ? "selected" : "";
          return `<option value="${y}-${mo}" ${sel}>${y}å¹´${mo}æœˆ</option>`;
        }).join("")}
      </select>
    </div>

    <!-- å³å´ï¼šå½“æœˆé›†è¨ˆï¼ˆç¸¦2è¡Œï¼‰ -->
    <div class="text-right text-sm leading-tight">
      <div>å½“æœˆåæ”¯ï¼š<span class="font-bold text-blue-600">${Object.values(daily).reduce((a,b)=>a+(b.income||0),0).toLocaleString()}å††</span></div>
      <div>ç¾é‡‘å¢—æ¸›ï¼š<span class="font-bold text-green-600">${Object.values(daily).reduce((a,b)=>a+(b.cash||0),0)>=0?'+':''}${Object.values(daily).reduce((a,b)=>a+(b.cash||0),0).toLocaleString()}å††</span></div>
    </div>
  </div>
`;


  

  // calendar grid
  const first = new Date(year, month - 1, 1);
  const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

  const lastDate = new Date(year, month, 0).getDate();
  const firstWeekday = first.getDay(); // 0..6

  let gridHtml = `<div class="grid grid-cols-7 gap-1 text-xs">`;
  ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach(d => gridHtml += `<div class="text-center font-semibold p-1">${d}</div>`);

  // empty leading cells
  for (let i = 0; i < firstWeekday; i++) gridHtml += `<div class="p-2"></div>`;

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ãƒ«ç”Ÿæˆéƒ¨åˆ†
for (let d = 1; d <= lastDate; d++) {
  const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  const stat = daily[dateStr];

  // ä»Šæ—¥ãªã‚‰èƒŒæ™¯è‰²ã‚’ä»˜ä¸
  const todayClass = (dateStr === todayStr) ? "bg-yellow-100 border-yellow-400" : "";

  if (stat) {
    const incomeColor = stat.income < 0 ? "text-red-600" : "text-green-600";
    const cashColor = stat.cash < 0 ? "text-orange-500" : "text-blue-600";
    gridHtml += `
      <div class="border p-1 rounded h-16 overflow-hidden ${todayClass}">
        <div class="font-bold text-left">${d}</div>
        <div class="${incomeColor} text-[11px] text-center">${stat.income.toLocaleString()}å††</div>
        <div class="${cashColor} text-[10px] text-center">ç¾é‡‘${stat.cash>=0?'+':''}${stat.cash.toLocaleString()}å††</div>
      </div>
    `;
  } else {
    gridHtml += `<div class="border p-1 rounded h-16 text-gray-400 ${todayClass}"><div class="font-bold">${d}</div></div>`;
  }
}

  gridHtml += `</div>`;




  container.innerHTML = headerHtml + gridHtml;

  // wire events
  document.getElementById("calPrev").addEventListener("click", () => {
    let y = calYear, m = calMonth - 1;
    if (m === 0) { y--; m = 12; } // prev month
    calYear = y; calMonth = m;
    renderCalendar(calYear, calMonth);
  });
  document.getElementById("calNext").addEventListener("click", () => {
    let y = calYear, m = calMonth + 1;
    if (m === 13) { y++; m = 1; }
    calYear = y; calMonth = m;
    renderCalendar(calYear, calMonth);
  });
  const sel = document.getElementById("calMonthSelect");
  if (sel) {
    sel.addEventListener("change", (e) => {
      const [y,mo] = e.target.value.split("-");
      calYear = Number(y); calMonth = Number(mo);
      renderCalendar(calYear, calMonth);
    });

  


  }
}

// utility to call when summary tab is shown
function updateSummaryTab() {
  // render by current calYear/calMonth
  renderCalendar(calYear, calMonth);
}

// initial call on page load (if summary tab shown by default, or whenever tab clicked calls updateSummaryTab)
renderCalendar(calYear, calMonth);




// ===== å‡ºé‡‘ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ– =====
function initWithdrawForm() {
  const withdrawForm = document.getElementById("withdrawForm");
  if (!withdrawForm) return;

  // æ—¥ä»˜ã‚’ä»Šæ—¥ã«è¨­å®š
  const today = new Date();
  if (withdrawForm.date) withdrawForm.date.value = today.toISOString().slice(0,10);

  // åº—èˆ—ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ shopFilter ã‹ã‚‰æ­£ç¢ºã«å–å¾—ï¼ˆ"å…¨åº—èˆ—" ã‚’é™¤å¤–ï¼‰
  const shopFilter = document.getElementById("shopFilter");
  const shopSelect = withdrawForm.shop;
  if (shopFilter && shopSelect) {
    // build options from shopFilter but exclude the "å…¨åº—èˆ—" option
    const shops = Array.from(shopFilter.options)
      .filter(opt => opt.value && opt.value !== "all")
      .map(opt => `<option value="${opt.value}">${opt.textContent}</option>`)
      .join("");
    shopSelect.innerHTML = shops;
  }
}


// ===== å‡ºé‡‘å‡¦ç† =====
function handleWithdrawSubmit(e) {
  e.preventDefault();
  const form = e.target;
  const shop = (form.shop && form.shop.value) || "";
  const gameType = (form.gameType && form.gameType.value) || "";
  const ball = Number(form.ball && form.ball.value || 0);
  const date = form.date && form.date.value ? form.date.value : new Date().toISOString().slice(0,10);

  if (!shop) { alert("åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
  if (!gameType) { alert("ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
  if (!ball || ball <= 0) { alert("å‡ºé‡‘ã™ã‚‹ç‰æ•°ï¼ˆæšæ•°ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

  // ãƒ¬ãƒ¼ãƒˆæ›ç®—ï¼ˆç¾é‡‘å¢—æ¸›ã«ä½¿ã†ï¼‰
  const rateMap = { slot46:19.23, slot5:4.42, pachi4:3.568, pachi1:0.892 };
  const withdrawYen = Math.round((rateMap[gameType] || 0) * ball);

  // å‡ºé‡‘ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆåæ”¯ã«ã¯å½±éŸ¿ã•ã›ãªã„ -> incomeYen: 0ï¼‰
  const records = JSON.parse(localStorage.getItem(key) || "[]");
  const rec = {
    date,
    shop,
    machineNo: "",
    machineName: "å‡ºé‡‘",
    gameType,
    startGame: 0,
    startBall: 0,
    addBall: 0,
    firstHitGame: 0,
    firstHitBall: null,
    isSingleBonus: false,
    endBall: 0,
    // æ³¨ï¼šåæ”¯ã¯å¤‰ãˆãªã„ï¼ˆã‚°ãƒ©ãƒ•ã«å½±éŸ¿ã•ã›ãªã„ï¼‰
    incomeYen: 0,
    incomeText: `å‡ºé‡‘ ${ball} (${withdrawYen}å††)`,
    // å‡ºé‡‘å°‚ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆæ®‹é«˜æ¸›ç®—ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç¾é‡‘ç”¨ï¼‰
    withdrawBall: ball,
    withdrawYen: withdrawYen,
    remarks: `å‡ºé‡‘ï¼ˆ${ball}ï¼‰`,
    created: new Date().toISOString()
  };
  records.push(rec);
  localStorage.setItem(key, JSON.stringify(records));

  // æ®‹é«˜åæ˜ ï¼ˆselected shop ã‚’æ¸¡ã—ã¦å½“è©²åº—èˆ—ã§ã®è¡¨ç¤ºæ›´æ–°ï¼‰
  updateBalances(shop);

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç­‰ã®é›†è¨ˆæ›´æ–°ï¼ˆåæ”¯ã¯å¤‰ã‚ã‚‰ãªã„ãŒç¾é‡‘å¢—æ¸›è¡¨ç¤ºã‚’æ›´æ–°ï¼‰
  updateSummary(currentPeriod);
  updateSummaryTab();

  // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ˆãŸã ã—æ—¥ä»˜ã¯ä»Šæ—¥ã«æˆ»ã™ï¼‰
  form.reset();
  if (form.date) form.date.value = new Date().toISOString().slice(0,10);

  // ç¢ºèªè¡¨ç¤ºï¼ˆä»»æ„ï¼‰
  const msg = `${shop} ã® ${gameType} ã‹ã‚‰ ${ball} ã‚’å‡ºé‡‘ï¼ˆè³‡ç”£æ¸›ï¼‰ã€‚ç¾é‡‘ +${withdrawYen}å†† ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜ ã—ã¾ã—ãŸã€‚`;
  // å°ã•ã„ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆã‚ˆã‚Šéç ´å£Šï¼‰
  const tmp = document.createElement("div");
  tmp.textContent = msg;
  tmp.className = "fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded shadow text-sm";
  document.body.appendChild(tmp);
  setTimeout(()=>tmp.remove(), 1800);
}


// ===== åˆæœŸåŒ–å‡¦ç† =====
document.addEventListener("DOMContentLoaded", () => {
  initWithdrawForm();

  const withdrawForm = document.getElementById("withdrawForm");
  if (withdrawForm) withdrawForm.addEventListener("submit", handleWithdrawSubmit);
});






// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
document.getElementById("exportBtn").addEventListener("click", () => {
  const data = JSON.parse(localStorage.getItem(key) || "[]");
  if(data.length === 0){
    alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const a = document.createElement("a");
  const today = new Date().toISOString().slice(0,10);
  a.download = `pachi_records_${today}.json`;
  a.href = URL.createObjectURL(blob);
  a.click();
  URL.revokeObjectURL(a.href);
});

// ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const importFileInput = document.getElementById("importFile");
document.getElementById("importBtn").addEventListener("click", () => {
  importFileInput.click();
});

importFileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const imported = JSON.parse(event.target.result);
      const existing = JSON.parse(localStorage.getItem(key) || "[]");

      let added = 0;
      let skipped = 0;

      imported.forEach(r => {
        // é‡è¤‡ãƒã‚§ãƒƒã‚¯: æ—¥ä»˜, åº—å, å°ç•ª, æ©Ÿç¨®å, åˆå½“ã‚ŠG, çµ‚äº†ç‰æ•°
        const duplicate = existing.some(e =>
          e.date === r.date &&
          e.shop === r.shop &&
          e.machineNo === r.machineNo &&
          e.machineName === r.machineName &&
          e.startBall === r.startBall &&
          e.addBall === r.addBall &&
          e.created === r.created &&
          e.firstHitGame === r.firstHitGame &&
          e.endBall === r.endBall
        );
        if(duplicate) skipped++;
        else {
          existing.push(r);
          added++;
        }
      });

      localStorage.setItem(key, JSON.stringify(existing));
      alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\nè¿½åŠ ä»¶æ•°: ${added}\né‡è¤‡ã‚¹ã‚­ãƒƒãƒ—: ${skipped}`);
  loadRecords();
  updateSummary();
  updateBalances();

    } catch(err) {
      alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      console.error(err);
    }
  };
  reader.readAsText(file);
  e.target.value = ""; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒªã‚»ãƒƒãƒˆ
});

// å…¨å‰Šé™¤
document.getElementById("clearAllBtn").addEventListener("click", () => {
  if(!confirm("æœ¬å½“ã«å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  if(!confirm("äºŒé‡ç¢ºèª: å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;

  localStorage.removeItem(key);
  loadRecords();
  updateSummary();
  alert("ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚");
});




// ===== å°ãƒ‡ãƒ¼ã‚¿ =====
let currentSortKey="", currentSortAsc=true;
function loadMachineData(){
  const shop=document.getElementById("searchShop").value.trim();
  const machineName=document.getElementById("searchMachineName").value.trim();
  const gameType=document.getElementById("searchGameType").value;
  const machineNo=document.getElementById("searchMachineNo").value.trim();

  const data=JSON.parse(localStorage.getItem(key)||"[]");
  const filtered=data.filter(r=>{
    if(shop && !r.shop.includes(shop)) return false;
    if(machineName && !r.machineName.includes(machineName)) return false;
    if(gameType && r.gameType!==gameType) return false;
    if(machineNo && r.machineNo!==machineNo) return false;
    return true;
  });

  const tbody=document.getElementById("machineDataList");
  tbody.innerHTML="";

// ğŸ”¹ ã‚°ãƒ«ãƒ¼ãƒ—åŒ–å‡¦ç†
const grouped = {};
filtered.forEach(r => {
  const key = [r.shop, r.machineNo, r.machineName].join("_");
  if (!grouped[key]) {
    grouped[key] = {
      list: [],         // ã“ã®å°ã®å…¨å±¥æ­´
      machineNo: r.machineNo,  // å°ç•ªå·ã ã‘åˆ¥ä¿æŒï¼ˆã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼ï¼‰
    };
  }
  grouped[key].list.push(r);
});


  const rows=[];



 // ===== å€‹åˆ¥å° =====
Object.keys(grouped).sort().forEach(key => {
  const recs = grouped[key].list;
  const machineNo = grouped[key].machineNo; // æ•°å­—ã®ã¿
  if (!recs || recs.length === 0) return;

  // ä¸è¦ãƒ‡ãƒ¼ã‚¿é™¤å¤–
  const validRecs = recs.filter(r =>
    r.machineName !== "èª¿æ•´" &&
    r.machineName !== "å‡ºé‡‘" &&
    r.machineName !== "æŒ¯æ›¿"
  );
  if (validRecs.length === 0) return;

  const shopName = validRecs[0]?.shop || "-";
  const firstHitRecords = validRecs.filter(r => r.firstHitBall != null && r.firstHitGame > 0);
  const firstHitCount = firstHitRecords.length;
  const playCount = validRecs.length;

  // ğŸ”¸çªå…¥ç‡
  const nonSingleCount = firstHitRecords.filter(r => !r.isSingleBonus).length;
  const penetrationRate = firstHitCount > 0
    ? `${((nonSingleCount / firstHitCount) * 100).toFixed(1)}%`
    : "-";

// ğŸ”¸å¹³å‡åˆå½“ã‚ŠGï¼ˆä¸Šæ®µï¼šå¾“æ¥ã®åˆå½“ã‚Šæœ‰ãƒ‡ãƒ¼ã‚¿ã®ã¿ã®å¹³å‡ / ä¸‹æ®µï¼šå…¨ãƒ‡ãƒ¼ã‚¿ã®ç·Gæ•° Ã· åˆå½“ã‚Šå›æ•° ã‚’ 1/XXX.X è¡¨è¨˜ï¼‰
let avgFirstHitG = "-";

// ä¸Šæ®µï¼ˆå¾“æ¥ã©ãŠã‚Šã€‚åˆå½“ã‚ŠãŒã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§ã®å¹³å‡ï¼‰
if (firstHitCount > 0) {
  const totalFirstHitG = firstHitRecords.reduce((a, r) => a + (Number(r.firstHitGame) || 0), 0);
  const avgHitOnly = totalFirstHitG / firstHitCount;
  const upperText = avgHitOnly ? avgHitOnly.toFixed(0) : "-";

  // ä¸‹æ®µï¼šã™ã¹ã¦ã® validRecsï¼ˆåˆå½“ã‚Šæœ‰ç„¡å•ã‚ãšï¼‰ã®ã€Œç·ã‚²ãƒ¼ãƒ æ•°ã€ã‚’ç®—å‡º
  // å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã‚²ãƒ¼ãƒ æ•°ã¯ã€åˆå½“ã‚ŠãŒã‚ã‚‹å ´åˆã¯ firstHitGame - startGameã€
  // ãªã„å ´åˆã¯ endGame - startGameï¼ˆendGame ãŒç„¡ã‘ã‚Œã° 0 ã‚’ä½¿ã†ï¼‰
  const totalGamesAll = validRecs.reduce((acc, r) => {
    const start = Number(r.startGame) || 0;
    const firstG = Number(r.firstHitGame) || 0;
    const endG = Number(r.endGame) || 0;
    let g = 0;
    if (firstG > 0) g = Math.max(firstG - start, 0);
    else if (endG > 0) g = Math.max(endG - start, 0);
    // else g stays 0 (ãƒ‡ãƒ¼ã‚¿ä¸è¶³)
    return acc + g;
  }, 0);

  // ä¸‹æ®µã‚’ 1/XXX.X è¡¨è¨˜ã§ä½œã‚‹ï¼ˆç®—å‡ºä¸èƒ½ãªã‚‰ "-"ï¼‰
  let lowerText = "-";
  if (firstHitCount > 0 && totalGamesAll > 0) {
    const ratio = totalGamesAll / firstHitCount;
    lowerText = `1/${ratio.toFixed(1)}`;
  }

  // è¡¨ç¤ºã¯ã€Œä¸Šæ®µï¼ˆå¾“æ¥è¡¨è¨˜ï¼‰ã€ã€Œæ”¹è¡Œã€ã€Œä¸‹æ®µï¼ˆ1/XXX.Xï¼‰ã€
  avgFirstHitG = `${upperText}<br>${lowerText}`;
} else {
  avgFirstHitG = "-";
}


  // ğŸ”¸å¹³å‡å¿…è¦æŠ•è³‡ç‰
  const avgInvest = firstHitCount > 0
    ? (firstHitRecords.reduce((a, r) => a + ((r.startBall + r.addBall - (r.firstHitBall || 0)) || 0), 0) / firstHitCount).toFixed(0)
    : "-";

  // ğŸ”¸å¹³å‡å›è»¢ç‡
  let totalRotation = 0, validCount = 0;
  validRecs.forEach(r => {
    const usedBalls = r.firstHitBall == null
      ? (r.startBall + r.addBall - r.endBall)
      : (r.startBall + r.addBall - r.firstHitBall);
    const totalG = (r.firstHitGame && r.firstHitGame > 0)
      ? (r.firstHitGame - r.startGame)
      : (r.endGame - r.startGame);
    const base = investUnit[r.gameType] || 0;
    if (usedBalls > 0 && totalG > 0) {
      totalRotation += totalG * base / usedBalls;
      validCount++;
    }
  });
  const avgRotation = validCount > 0 ? (totalRotation / validCount).toFixed(1) : "-";

  // ğŸ”¸åæ”¯ï¼ˆç‰ãƒ»å††ï¼‰
const totalIncomeBall = Math.round(validRecs.reduce((a, r) => a + ((r.endBall || 0) - ((r.startBall || 0) + (r.addBall || 0))), 0));
const totalIncomeYen = Math.round(validRecs.reduce((a, r) => {
  const diff = (r.endBall || 0) - ((r.startBall || 0) + (r.addBall || 0));
  return a + diff * (rate[r.gameType] || 0);
}, 0));


// ğŸ”¸æŠ•è³‡ç‰ãƒ»å‡ºç‰ç‰ã®åˆè¨ˆ
const totalInvestBall = validRecs.reduce((a, r) => a + ((r.startBall || 0) + (r.addBall || 0)), 0);
const totalOutBall = validRecs.reduce((a, r) => a + (r.endBall || 0), 0);

// ğŸ”¸å›åç‡ï¼ˆ%è¡¨ç¤ºã€100%åŸºæº–ã§ãƒ—ãƒ©ã‚¹ãƒ»ãƒã‚¤ãƒŠã‚¹ï¼‰
let recoveryRateValue = totalInvestBall > 0 ? totalOutBall / totalInvestBall : null;
let recoveryText = "-";
let recoveryClass = "";

if (recoveryRateValue !== null) {
  const diff = (recoveryRateValue - 1) * 100;  // 100%åŸºæº–ã¨ã®å·®
  recoveryText = (diff >= 0 ? "+" : "") + diff.toFixed(1) + "%"; // å°æ•°ç‚¹ä»¥ä¸‹åˆ‡æ¨ã¦
  if (diff < 0) recoveryClass = "text-red-500";
}


  const maxOutBall = validRecs.reduce((a, r) => Math.max(a, r.outBall || 0), 0);

  rows.push({
    shop: shopName,
    machineNo,
    machineName: validRecs[0]?.machineName || "-",
    gameType: { pachi4: "4å††P", pachi1: "1å††P", slot46: "46æšS", slot5: "5å††S" }[validRecs[0]?.gameType] || "-",
    playCount,
    firstHitCount,
    penetrationRate,
    avgFirstHitG,
    avgInvest,
    avgRotation,
    totalIncomeBall,
    totalIncomeYen,
    maxOutBall,
    recoveryRate: recoveryText,
    recoveryClass,
    isAll: false
  });
});


  // ã‚½ãƒ¼ãƒˆ
if (currentSortKey) {
  rows.sort((a, b) => {
    if (a.isAll) return -1;
    if (b.isAll) return 1;

    // åˆè¨ˆåæ”¯ã‚½ãƒ¼ãƒˆå°‚ç”¨ï¼šå††æ›ç®—ã®æ•°å€¤ã‚’ä½¿ã†
    if (currentSortKey === "totalIncomeYen") {
      const valA = a.totalIncomeYen || 0;
      const valB = b.totalIncomeYen || 0;
      return currentSortAsc ? valA - valB : valB - valA;
    }

    // é€šå¸¸ã®ã‚½ãƒ¼ãƒˆ
    const valA = isNaN(a[currentSortKey]) ? a[currentSortKey] : Number(a[currentSortKey]);
    const valB = isNaN(b[currentSortKey]) ? b[currentSortKey] : Number(b[currentSortKey]);
    if (valA < valB) return currentSortAsc ? -1 : 1;
    if (valA > valB) return currentSortAsc ? 1 : -1;
    return 0;
  });
}

// ===== å…¨å°åˆç®—ï¼ˆå¹³å‡ãƒ»å®Ÿè³ªå›åç‡ãƒ»å˜ä½å¯¾å¿œï¼‰ =====
if (!machineNo && rows.length > 0) {
  const indiv = rows.filter(r => !r.isAll);

  if (indiv.length > 0) {
    let totalPlayCount = 0;
    let totalFirstHitCount = 0;
    let totalRotation = 0;
    let totalFirstHitG = 0;
    let totalInvestBall = 0;
    let totalOutBall = 0;
    let totalInvestYen = 0;
    let totalOutYen = 0;

    indiv.forEach(r => {
      const rRate = rateKeyFromLabel(r.gameType);
      const yenPerBall = rate[rRate] || 1;

      totalPlayCount += r.playCount || 0;
      totalFirstHitCount += r.firstHitCount || 0;
      totalRotation += parseFloat(r.avgRotation) || 0;
      totalFirstHitG += parseFloat(r.avgFirstHitG) || 0;

      const investBall = r.firstHitCount > 0 ? parseFloat(r.avgInvest) * r.firstHitCount : 0;
      totalInvestBall += investBall;

      totalInvestYen += investBall * yenPerBall;
      totalOutYen += (r.totalIncomeBall + investBall) * yenPerBall;
      totalOutBall += r.totalIncomeBall;
    });

    // å›åç‡ï¼ˆå††æ›ç®—ï¼‰
    let recoveryRateValue = totalInvestYen > 0 ? (totalOutYen / totalInvestYen) * 100 : 100;
    const diff = recoveryRateValue - 100;
    const recoveryText = (diff >= 0 ? "+" : "") + diff.toFixed(1) + "%";

// å¹³å‡åˆå½“ã‚ŠGï¼ˆä¸Šæ®µï¼šå¾“æ¥ / ä¸‹æ®µï¼š1/XXX.Xï¼‰
let upperAvg = totalFirstHitG / totalFirstHitCount || "-"; // ä¸Šæ®µã¯å¾“æ¥é€šã‚Š
upperAvg = upperAvg !== "-" ? upperAvg.toFixed(0) : "-";

// ä¸‹æ®µï¼šselfGã®ç·å’Œ Ã· åˆå½“ã‚Šå›æ•°
let totalSelfG = 0;
indiv.forEach(r => {
  if (r.isAll) return;
  // validRecsã”ã¨ã«selfGã‚’åŠ ç®—
  const validRecs = JSON.parse(localStorage.getItem(key) || "[]").filter(d =>
    d.shop === r.shop &&
    d.machineNo === r.machineNo &&
    d.machineName === r.machineName
  );
  validRecs.forEach(r => {
    const selfG = r.firstHitGame - r.startGame;
    totalSelfG += selfG;
  });
});

let lowerText = "-";
if (totalFirstHitCount > 0 && totalSelfG > 0) {
  const ratio = totalSelfG / totalFirstHitCount;
  lowerText = `1/${ratio.toFixed(1)}`;
}

const avgFirstHitGText = `${upperAvg}<br>${lowerText}`;


    // å˜ä½æ±ºå®šï¼ˆå¤šæ•°æ´¾ã® gameType ã‹ã‚‰é¸æŠï¼‰
    const modeCount = {};
    indiv.forEach(r => { modeCount[r.gameType] = (modeCount[r.gameType] || 0) + 1; });
    const dominantType = Object.keys(modeCount).sort((a, b) => modeCount[b] - modeCount[a])[0];
    const unitLabel = { "5å††S": "/50æš", "46æšS": "/46æš", "1å††P": "/200ç‰", "4å††P": "/250ç‰" }[dominantType] || "";

    const avgRotation = indiv.length > 0 ? totalRotation / indiv.length : 0;
    const avgInvest = totalInvestBall / Math.max(totalFirstHitCount, 1);

    // çªå…¥ç‡
    const penetrationRate = totalFirstHitCount > 0
      ? ((totalFirstHitCount / totalPlayCount) * 100).toFixed(1) + "%"
      : "-";

    rows.unshift({
      shop: "å…¨å°åˆç®—",
      machineNo: "-",
      machineName: "-",
      gameType: "-",
      playCount: totalPlayCount,
      firstHitCount: totalFirstHitCount,
      penetrationRate,
      avgFirstHitG: avgFirstHitGText,
      avgInvest: avgInvest ? avgInvest.toFixed(0) : "-",
      avgRotation: avgRotation ? avgRotation.toFixed(1) + "<br>" + unitLabel : "-",
      totalIncomeBall: Math.round(totalOutBall),
      totalIncomeYen: Math.round(totalOutYen - totalInvestYen),
      maxOutBall: Math.max(...indiv.map(r => r.maxOutBall || 0)),
      recoveryRate: recoveryText,
      recoveryClass: diff < 0 ? "text-red-500" : "",
      isAll: true
    });
  }
}



// ===== ãƒ¬ãƒ¼ãƒˆãƒ©ãƒ™ãƒ«â†’rateã‚­ãƒ¼å¤‰æ›é–¢æ•° =====
function rateKeyFromLabel(label) {
  switch (label) {
    case "4å††P": return "pachi4";
    case "1å††P": return "pachi1";
    case "46æšS": return "slot46";
    case "5å††S": return "slot5";
    default: return "pachi4";
  }
}




  // æç”»
  rows.forEach(r=>{
  const typeColors = { 
    "5å††S": "bg-blue-200", 
    "46æšS": "bg-red-200", 
    "1å††P": "bg-green-200", 
    "4å††P": "bg-yellow-200" 
  };

  const recoveryText = r.recoveryRate != null
    ? ((r.recoveryRate - 100) >= 0 ? "+" : "") + (r.recoveryRate - 100).toFixed(1) + "%"
    : "-";

  const recoveryClass = (r.recoveryRate - 100) < 0 ? "text-red-500" : "";
  const totalIncomeClass = r.totalIncome < 0 ? "text-red-500" : "";

  // å€‹åˆ¥å°ã®å¹³å‡å›è»¢ç‡ã«æ”¹è¡Œã¨å˜ä½è¿½åŠ 
  const avgRotationText = r.avgRotation !== "-" && r.gameType && !r.isAll
    ? r.avgRotation + "<br>" + { "5å††S": "/50æš", "46æšS": "/46æš", "1å††P": "/200ç‰", "4å††P": "/250ç‰" }[r.gameType]
    : r.avgRotation;

  const tr = document.createElement("tr");
  if(r.isAll) tr.classList.add("bg-pink-100");
  tr.innerHTML = `
    <td class="border p-1">${r.shop}</td>
    <td class="border p-1">${r.machineNo}</td>
    <td class="border p-1">${r.machineName}</td>
    <td class="border p-1 ${typeColors[r.gameType] || ""}">${r.gameType}</td>
    <td class="border p-1">${r.playCount}</td>
    <td class="border p-1">${r.firstHitCount}</td>
    <td class="border p-1">${r.penetrationRate}</td>
    <td class="border p-1">${avgRotationText}</td>
    <td class="border p-1">${r.avgFirstHitG}</td>
    <td class="border p-1">${r.avgInvest}</td>
    <td class="border p-1 ${r.totalIncomeBall < 0 ? 'text-red-500' : ''}">
  ${Number(r.totalIncomeBall).toLocaleString()}<br>(${Number(r.totalIncomeYen).toLocaleString()}å††)
</td>

    <td class="border p-1">${r.maxOutBall}</td>
    <td class="border p-1 ${r.recoveryClass}">${r.recoveryRate}</td>
  `;
  tbody.appendChild(tr);
});
}

document.querySelectorAll("#machineData th[data-key]").forEach(th=>{
  th.addEventListener("click",()=>{
    const k=th.dataset.key;
    if(currentSortKey===k) currentSortAsc=!currentSortAsc;
    else{currentSortKey=k;currentSortAsc=true;}
    loadMachineData();
  });
});

// ===== å°ç•ªå·æ¬„ï¼šåŠè§’æ•°å­—ã®ã¿è¨±å¯ =====
const machineNoInput = document.getElementById("searchMachineNo");
if (machineNoInput) {
  // IMEå…¥åŠ›ã‚’é˜²ãã€æ•°å­—ã¨åˆ¶å¾¡ã‚­ãƒ¼ã®ã¿è¨±å¯
  machineNoInput.addEventListener("keydown", (e) => {
    const allowedKeys = [
      "Backspace", "Delete", "ArrowLeft", "ArrowRight", "Tab"
    ];
    if (!/[0-9]/.test(e.key) && !allowedKeys.includes(e.key)) {
      e.preventDefault();
    }
  });
  // è²¼ã‚Šä»˜ã‘ãªã©ã®å…¨è§’å‰Šé™¤
  machineNoInput.addEventListener("input", (e) => {
    e.target.value = e.target.value.replace(/[^0-9]/g, "");
  });
}

// ===== Enterã‚­ãƒ¼ã§æ¤œç´¢å®Ÿè¡Œ =====
const searchInputs = [
  "searchShop",
  "searchMachineName",
  "searchGameType",
  "searchMachineNo"
].map(id => document.getElementById(id));

searchInputs.forEach(el => {
  if (el) {
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("searchMachineBtn").click();
      }
    });
  }
});


document.getElementById("searchMachineBtn").addEventListener("click",e=>{
  e.preventDefault();
  loadMachineData();
});
</script>

</body>
</html>
