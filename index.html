<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éŠæŠ€è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<style>
/* ===== å±¥æ­´ãƒ»å°ãƒ‡ãƒ¼ã‚¿å…±é€š ===== */
#machineData th, #machineData td,
#recordList th, #recordList td {
  white-space: normal; /* æŠ˜ã‚Šè¿”ã—æœ‰åŠ¹ */
  word-break: break-word;
  text-align: center;
  padding: 4px;
}

/* âœ… è‡ªå‹•å¹…ã«æˆ»ã™ */
table {
  table-layout: auto;
  width: 100%;
}

</style>

<body class="bg-gray-100 p-4 min-h-screen">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-2xl shadow-lg">
    <h1 class="text-xl font-bold mb-4">ğŸ° éŠæŠ€è¨˜éŒ²ã‚¢ãƒ—ãƒª</h1>

    <!-- ã‚¿ãƒ–åˆ‡æ›¿ -->
    <div class="flex border-b mb-4">
      <button class="tab-button px-4 py-2 border-b-2 border-blue-500 font-semibold text-blue-500" data-tab="input">å…¥åŠ›</button>
      <button class="tab-button px-4 py-2 text-gray-500" data-tab="history">å±¥æ­´</button>
      <button class="tab-button px-4 py-2 text-gray-500" data-tab="summary">é›†è¨ˆ</button>
      <button class="tab-button px-4 py-2 text-gray-500" data-tab="machineData">å°ãƒ‡ãƒ¼ã‚¿</button>
    </div>

    <!-- å…¥åŠ›ã‚¿ãƒ– -->
    <div id="input" class="tab-content">
      <form id="recordForm" class="space-y-3">
<!-- 1è¡Œç›®ï¼šæ—¥ä»˜120pxã€åº—åæ®‹ã‚Šã€å°ç•ªå·1/4å¹… -->
<div class="flex gap-2">
  <div class="flex-none w-3/16">
    <input type="date" id="date" class="border rounded w-full p-2" required>
  </div>
  <div class="flex-1">
    <input type="text" id="shop" class="border rounded w-full p-2" placeholder="åº—å" value="ã‚¨ã‚¹ãƒ‘ã‚¹é«˜ç”°é¦¬å ´">
  </div>
  <div class="flex-none w-1/4">
    <input type="text" id="machineNo" class="border rounded w-full p-2" placeholder="å°ç•ªå·" inputmode="numeric" pattern="[0-9]*">
  </div>
</div>

        <!-- 2è¡Œç›® -->
        <div class="grid grid-cols-5 gap-2">
          <div class="col-span-3"><input type="text" id="machineName" class="border rounded w-full p-2" placeholder="æ©Ÿç¨®å"></div>
          <div class="col-span-2">
            <select id="gameType" class="border rounded w-full p-2">
              <option value="slot5">5å††ã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="slot46">46æšã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="pachi1">1å††ãƒ‘ãƒãƒ³ã‚³</option>
              <option value="pachi4">4å††ãƒ‘ãƒãƒ³ã‚³</option>
            </select>
          </div>
        </div>

        <!-- 3è¡Œç›® -->
        <div class="grid grid-cols-3 gap-2">
          <div>
            <label class="block text-sm font-semibold">é–‹å§‹Gæ•°</label>
            <input type="text" id="startGame" class="border rounded w-full p-2" inputmode="numeric" pattern="[0-9]*">
          </div>
          <div>
            <label class="block text-sm font-semibold">é–‹å§‹æ™‚ç‰æ•°</label>
            <input type="text" id="startBall" class="border rounded w-full p-2" inputmode="numeric" pattern="[0-9]*">
          </div>
          <div>
            <label class="block text-sm font-semibold">è¿½åŠ ç‰</label>
            <input type="text" id="addBall" class="border rounded w-full p-2 bg-gray-100" value="0" inputmode="numeric" pattern="[0-9]*">
            <div class="flex justify-between mt-1">
              <button type="button" id="decBall" class="bg-blue-500 text-white rounded px-3 py-1 w-1/2 mr-1">-</button>
              <button type="button" id="incBall" class="bg-blue-500 text-white rounded px-3 py-1 w-1/2">+</button>
            </div>
          </div>
        </div>

        <!-- 4è¡Œç›® -->
        <div class="grid grid-cols-6 gap-2 items-end">
          <div class="col-span-2">
            <label class="block text-sm font-semibold">åˆå½“ã‚Š/ãƒ¤ãƒ¡Gæ•°</label>
            <input type="text" id="firstHitGame" class="border rounded w-full p-2" inputmode="numeric" pattern="[0-9]*">
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-semibold">åˆå½“ã‚Šæ™‚ç‰æ•°</label>
            <input type="text" id="firstHitBall" class="border rounded w-full p-2" inputmode="numeric" pattern="[0-9]*">
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-semibold">çµ‚äº†æ™‚ç‰æ•°</label>
            <input type="text" id="endBall" class="border rounded w-full p-2 bg-pink-50" inputmode="numeric" pattern="[0-9]*">
          </div>
        </div>

<!-- å›è»¢ç‡ãƒ»åæ”¯ + ç™»éŒ²ãƒœã‚¿ãƒ³ -->
<div class="mt-2 text-lg font-bold">
  <div class="flex justify-between">
    <div id="rotationDisplay">å›è»¢ç‡ï¼š0.00</div>
    <div id="incomeDisplay">ç‰æ•°ï¼ˆå††ï¼‰ï¼š0ï¼ˆ0å††ï¼‰</div>
  </div>
  <div class="flex justify-between mt-2">
    <button type="button" id="clearBtn" class="bg-gray-400 hover:bg-gray-500 text-white rounded w-16 py-1">ã‚¯ãƒªã‚¢</button>
    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white rounded w-16 py-1">ç™»éŒ²</button>
  </div>
</div>

      </form>
    </div>

<!-- å±¥æ­´ã‚¿ãƒ– -->
<div id="history" class="tab-content hidden">
  <div class="overflow-x-auto">
<table class="border text-sm min-w-[900px] table-fixed">
  <colgroup>
    <col style="width: 40px;">  <!-- æ—¥ä»˜ -->
    <col style="width: 60px;"> <!-- åº—å -->
    <col style="width: 30px;">  <!-- å°ç•ª -->
    <col style="width: 120px;"> <!-- æ©Ÿç¨®å -->
    <col style="width: 40px;">  <!-- ç¨®åˆ¥ -->
    <col style="width: 50px;">  <!-- åˆå½“ã‚ŠG -->
    <col style="width: 50px;">  <!-- å›è»¢ç‡ -->
    <col style="width: 60px;">  <!-- æŠ•è³‡ -->
    <col style="width: 60px;">  <!-- å‡ºç‰ -->
    <col style="width: 110px;">  <!-- åæ”¯ -->
    <col style="width: 40px;">  <!-- å‰Šé™¤ -->
  </colgroup>
  <thead class="bg-gray-200">
    <tr>
      <th class="border p-1">æ—¥ä»˜</th>
      <th class="border p-1">åº—å</th>
      <th class="border p-1">å°ç•ª</th>
      <th class="border p-1">æ©Ÿç¨®å</th>
      <th class="border p-1">ç¨®åˆ¥</th>
      <th class="border p-1">åˆå½“ã‚ŠGï¼ˆè‡ªGï¼‰</th>
      <th class="border p-1">å›è»¢ç‡</th>
      <th class="border p-1">æŠ•è³‡ç‰</th>
      <th class="border p-1">å‡ºç‰</th>
      <th class="border p-1">åæ”¯</th>
      <th class="border p-1">å‰Šé™¤</th>
    </tr>
  </thead>
  <tbody id="recordList"></tbody>
</table>
  </div>
</div>

    <!-- é›†è¨ˆã‚¿ãƒ– -->
    <div id="summary" class="tab-content hidden">
      <div class="space-y-3">
        <div class="text-lg font-semibold">ç·åæ”¯ï¼ˆå††ï¼‰ï¼š<span id="totalYen" class="font-bold text-blue-600">0</span></div>
<div class="text-lg font-semibold">
  ç¾åœ¨è³‡ç”£æ®‹é«˜ï¼ˆå††ï¼‰ï¼š<span id="totalAssetYen" class="font-bold text-green-600">0å††</span>
</div>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div>46æšã‚¹ãƒ­ãƒƒãƒˆæ®‹é«˜ï¼š<span id="bal46">0</span></div>
          <div>5å††ã‚¹ãƒ­ãƒƒãƒˆæ®‹é«˜ï¼š<span id="bal5">0</span></div>
          <div>4å††ãƒ‘ãƒãƒ³ã‚³æ®‹é«˜ï¼š<span id="bal4">0</span></div>
          <div>1å††ãƒ‘ãƒãƒ³ã‚³æ®‹é«˜ï¼š<span id="bal1">0</span></div>
        </div>

        <div class="flex space-x-2 mt-4">
          <button class="period-btn bg-blue-500 text-white rounded px-3 py-1" data-period="1">ç›´è¿‘1ãƒ¶æœˆ</button>
          <button class="period-btn bg-gray-300 rounded px-3 py-1" data-period="3">ç›´è¿‘3ãƒ¶æœˆ</button>
          <button class="period-btn bg-gray-300 rounded px-3 py-1" data-period="6">ç›´è¿‘åŠå¹´</button>
          <button class="period-btn bg-gray-300 rounded px-3 py-1" data-period="all">å…¨æœŸé–“</button>
        </div>

        <canvas id="chart" height="200"></canvas>
      </div>
    </div>

    <!-- å°ãƒ‡ãƒ¼ã‚¿ã‚¿ãƒ– -->
    <div id="machineData" class="tab-content hidden">
      <div class="space-y-3">
        <form class="grid grid-cols-5 gap-2 items-end">
          <div><input type="text" id="searchShop" class="border rounded w-full p-2" placeholder="åº—å"></div>
          <div><input type="text" id="searchMachineNo" class="border rounded w-full p-2" placeholder="å°ç•ªå·"></div>
          <div><input type="text" id="searchMachineName" class="border rounded w-full p-2" placeholder="æ©Ÿç¨®å"></div>
          <div>
            <select id="searchGameType" class="border rounded w-full p-2">
              <option value="">å…¨ã¦ã®ç¨®åˆ¥</option>
              <option value="slot5">5å††ã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="slot46">46æšã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="pachi1">1å††ãƒ‘ãƒãƒ³ã‚³</option>
              <option value="pachi4">4å††ãƒ‘ãƒãƒ³ã‚³</option>
            </select>
          </div>

          <div><button id="searchMachineBtn" class="bg-blue-500 text-white rounded px-3 py-1">æ¤œç´¢</button></div>
        </form>

  <div class="overflow-x-auto">
    <table class="border text-sm min-w-[900px] table-fixed mt-2">
      <colgroup>
        <col style="width: 60px;"> <!-- åº—å -->
        <col style="width: 30px;">  <!-- å°ç•ª -->
        <col style="width: 120px;"> <!-- æ©Ÿç¨®å -->
        <col style="width: 40px;">  <!-- ç¨®åˆ¥ -->
        <col style="width: 30px;">  <!-- ãƒ—ãƒ¬ã‚¤æ•° -->
        <col style="width: 30px;">  <!-- åˆå½“ã‚Š -->
        <col style="width: 60px;">  <!-- å¹³å‡å½“G -->
        <col style="width: 70px;">  <!-- å¹³å‡å½“æŠ•è³‡ -->
        <col style="width: 80px;">  <!-- åˆè¨ˆåæ”¯ -->
        <col style="width: 80px;">  <!-- æœ€å¤§å‡ºç‰ -->
        <col style="width: 60px;">  <!-- å›åç‡ -->
      </colgroup>
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-1">åº—å</th>
          <th class="border p-1">å°ç•ª</th>
          <th class="border p-1">æ©Ÿç¨®å</th>
          <th class="border p-1">ç¨®åˆ¥</th>
          <th class="border p-1">ãƒ—ãƒ¬ã‚¤æ•°</th>
          <th class="border p-1">åˆå½“ã‚Š</th>
          <th class="border p-1">å¹³å‡å½“G</th>
          <th class="border p-1">å¹³å‡å¿…è¦æŠ•è³‡ç‰</th>
          <th class="border p-1">åˆè¨ˆç‰åæ”¯</th>
          <th class="border p-1">æœ€å¤§å‡ºç‰</th>
          <th class="border p-1">å›åç‡</th>
        </tr>
      </thead>
      <tbody id="machineDataList"></tbody>
    </table>
  </div>
</div>

<script>
/* ===== JavaScript å®Œå…¨ç‰ˆ ===== */
const fmt1 = v => (isNaN(v) || v === null || v === "") ? "-" : Number(v).toFixed(1);
const key = "pachi_records";
// 1ç‰ãƒ»1æšã‚ãŸã‚Šã®å††æ›ç®—ãƒ¬ãƒ¼ãƒˆ
const rate = {
  pachi1: 0.892,    // 1å††ãƒ‘ãƒãƒ³ã‚³
  pachi4: 3.568,    // 4å††ãƒ‘ãƒãƒ³ã‚³
  slot46: 19.23,    // 46æšã‚¹ãƒ­ãƒƒãƒˆ
  slot5: 4.42       // 5å††ã‚¹ãƒ­ãƒƒãƒˆ
};
const step = {pachi4:125, pachi1:100, slot46:46, slot5:100};
const investUnit = {pachi4:250, pachi1:200, slot46:46, slot5:200};

const dateInput = document.getElementById("date");
const today = new Date();
dateInput.value = today.toISOString().slice(0,10);

// ã‚¿ãƒ–åˆ‡æ›¿
document.querySelectorAll(".tab-button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    // å…¨ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll(".tab-button").forEach(b=>{
      b.classList.remove("border-blue-500","text-blue-500","font-semibold","bg-blue-100");
      b.classList.add("text-gray-500");
    });
    // é¸æŠä¸­ã‚¿ãƒ–ã‚’å¼·èª¿
    btn.classList.add("border-blue-500","text-blue-500","font-semibold","bg-blue-100");
    btn.classList.remove("text-gray-500");

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ‡æ›¿
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.add("hidden"));
    document.getElementById(btn.dataset.tab).classList.remove("hidden");

    // å„ã‚¿ãƒ–èª­ã¿è¾¼ã¿å‡¦ç†
    if(btn.dataset.tab==="history") loadRecords();
    if(btn.dataset.tab==="summary") updateSummary();
    if(btn.dataset.tab==="machineData") loadMachineData();
  });
});


// å…¥åŠ›å‡¦ç†
const form = document.getElementById("recordForm");
const addBallInput = document.getElementById("addBall");
const gameTypeSelect = document.getElementById("gameType");

document.getElementById("incBall").addEventListener("click",()=>{
  const type=gameTypeSelect.value;
  addBallInput.value=Number(addBallInput.value||0)+(step[type]||0);
  updateIncome();
});
document.getElementById("decBall").addEventListener("click",()=>{
  const type=gameTypeSelect.value;
  addBallInput.value=Math.max(0,Number(addBallInput.value||0)-(step[type]||0));
  updateIncome();
});

function updateIncome() {
  const startBall = Number(form.startBall.value) || 0;
  const endBall = Number(form.endBall.value) || 0;
  const addBall = Number(form.addBall.value) || 0;
  const firstHitBall = form.firstHitBall.value === "" ? null : Number(form.firstHitBall.value);
  const startG = Number(form.startGame.value) || 0;
  const endG = Number(form.firstHitGame.value) || 0;
  const type = form.gameType.value;

  // ä½¿ç”¨ç‰æ•°ï¼ˆåˆå½“ã‚Šç‰æ•°ãŒç©ºæ¬„ â†’ çµ‚äº†æ™‚ç‰æ•°ã‚’ä½¿ã†ï¼‰
  let usedBalls;
  if (firstHitBall === null || isNaN(firstHitBall)) {
    usedBalls = (startBall + addBall) - endBall;
  } else {
    usedBalls = (startBall + addBall) - firstHitBall;
  }
  if (usedBalls < 0) usedBalls = 0;

  // å›è»¢ç‡è¨ˆç®—
  const totalG = endG - startG;
  let rotationRate = 0;
  let rateUnit = "";

  if (usedBalls > 0 && totalG > 0) {
    switch (type) {
      case "slot46":
        rotationRate = (totalG / usedBalls) * 46;
        rateUnit = "/46æš";
        break;
      case "slot5":
        rotationRate = (totalG / usedBalls) * 50;
        rateUnit = "/50æš";
        break;
      case "pachi1":
        rotationRate = (totalG / usedBalls) * 200;
        rateUnit = "/200ç‰";
        break;
      case "pachi4":
        rotationRate = (totalG / usedBalls) * 250;
        rateUnit = "/250ç‰";
        break;
    }
  }

  document.getElementById("rotationDisplay").textContent =
    "å›è»¢ç‡ï¼š" + (rotationRate ? rotationRate.toFixed(1) + "å›" + rateUnit : "-");

  // åæ”¯
  const diff = endBall - (startBall + addBall);
  const yen = rate[type] ? Math.round(diff * rate[type]) : 0;
  document.getElementById("incomeDisplay").textContent = `ç‰æ•°ï¼ˆå††ï¼‰ï¼š${diff}ï¼ˆ${yen}å††ï¼‰`;
}

["startBall","endBall","addBall","startGame","gameType","firstHitBall","firstHitGame"].forEach(id=>{
  document.getElementById(id).addEventListener("input",updateIncome);
});

// ç™»éŒ²ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
form.addEventListener("submit", (e) => {
  e.preventDefault();

  if (!form.endBall.value) {
    alert("çµ‚äº†æ™‚ç‰æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  if (!confirm("ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) return;

  const record = {
    date: form.date.value,
    shop: form.shop.value || "",
    machineNo: form.machineNo.value || "",
    machineName: form.machineName.value || "",
    gameType: form.gameType.value,
    startGame: Number(form.startGame.value) || 0,
    startBall: Number(form.startBall.value) || 0,
    addBall: Number(form.addBall.value) || 0,
    firstHitGame: Number(form.firstHitGame.value) || 0,
    firstHitBall: form.firstHitBall.value === "" ? null : Number(form.firstHitBall.value),
    endBall: Number(form.endBall.value) || 0,
    created: new Date().toISOString()
  };

  // outBall è¨ˆç®—
  if (record.firstHitBall === null) record.outBall = 0;
  else record.outBall = Math.max(0, record.endBall - record.firstHitBall);

  // rotation è¨ˆç®—
  const totalG = (record.firstHitGame && record.firstHitGame > 0 ? record.firstHitGame : record.endBall) - record.startGame;
  const type = record.gameType;
  const base = investUnit[type] || 0;
  const usedBalls = (record.startBall + record.addBall) - (record.firstHitBall || record.endBall);
  record.rotation = (usedBalls > 0 && totalG > 0) ? Number(((totalG * base) / usedBalls).toFixed(1)) : 0;

  // åæ”¯
  const diff = record.endBall - (record.startBall + record.addBall);
  record.incomeYen = rate[type] ? Math.round(diff * rate[type]) : 0;
  record.incomeText = `${diff}ï¼ˆ${record.incomeYen}å††ï¼‰`;

  // ä¿å­˜
  const data = JSON.parse(localStorage.getItem(key) || "[]");
  data.push(record);
  localStorage.setItem(key, JSON.stringify(data));

  // å‰å›å€¤ä¿æŒ
  localStorage.setItem("lastShop", record.shop);
  localStorage.setItem("lastMachineNo", record.machineNo);
  localStorage.setItem("lastModelName", record.machineName);
  localStorage.setItem("lastGameType", record.gameType);

  // ãƒªã‚»ãƒƒãƒˆ
  form.reset();
  form.shop.value = localStorage.getItem("lastShop") || "ã‚¨ã‚¹ãƒ‘ã‚¹é«˜ç”°é¦¬å ´";
  form.machineNo.value = localStorage.getItem("lastMachineNo") || "";
  form.machineName.value = localStorage.getItem("lastModelName") || "";
  form.gameType.value = localStorage.getItem("lastGameType") || "slot5";
  addBallInput.value = 0;
  dateInput.value = today.toISOString().slice(0,10);
  updateIncome();

  loadRecords();
  updateSummary();
});


// ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
document.getElementById("clearBtn").addEventListener("click", () => {
  if (!confirm("å…¥åŠ›å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
  form.reset();
  form.shop.value = "ã‚¨ã‚¹ãƒ‘ã‚¹é«˜ç”°é¦¬å ´";
  addBallInput.value = 0;
  dateInput.value = today.toISOString().slice(0, 10);
  updateIncome();

  // ä¿å­˜ã—ã¦ã„ãŸå‰å›å€¤ã‚’å‰Šé™¤
  localStorage.removeItem("lastShop");
  localStorage.removeItem("lastMachineNo");
  localStorage.removeItem("lastModelName");
  localStorage.removeItem("lastGameType");
});


// ===== å±¥æ­´ =====
function loadRecords(){
  const tbody=document.getElementById("recordList");
  tbody.innerHTML="";
  const data=JSON.parse(localStorage.getItem(key)||"[]").slice(-100).reverse();

  data.forEach((r,i)=>{
    const selfG = (r.firstHitGame || r.endBall || 0) - (r.startGame || 0); // è‡ªGæ•°è¨ˆç®—
    const firstHitDisplay = r.firstHitGame
  ? r.firstHitGame // åˆå½“ã‚Šã‚ã‚Š
  : "ãƒ¤ãƒ¡";        // åˆå½“ã‚Šãªã—
    const shopShort=r.shop?.length>6?r.shop.slice(0,10):r.shop||"";
    const invest=(r.startBall||0)+(r.addBall||0)-(r.firstHitBall||0);

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="border p-1">${r.date?.slice(5)||""}</td>
      <td class="border p-1">${shopShort}</td>
      <td class="border p-1">${r.machineNo||""}</td>
      <td class="border p-1">${r.machineName||""}</td>
      <td class="border p-1">${{pachi4:"4å††P",pachi1:"1å††P",slot46:"46æšS",slot5:"5å††S"}[r.gameType]||""}</td>
      <td class="border p-1">${firstHitDisplay}ï¼ˆ${selfG}ï¼‰</td>
      <td class="border p-1">${(typeof r.rotation==="number"?r.rotation.toFixed(1):"0.00")}</td>
      <td class="border p-1 text-right">${invest}</td>
      <td class="border p-1 text-right">${r.outBall||0}</td>
      <td class="border p-1 text-right">${r.incomeText||"0ï¼ˆ0å††ï¼‰"}</td>
      <td class="border p-1 text-center"><button data-index="${i}" class="delete-btn text-red-500">å‰Šé™¤</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll(".delete-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      if(!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      const index=Number(btn.dataset.index);
      const data=JSON.parse(localStorage.getItem(key)||"[]");
      const reversedIndex=data.length-1-index;
      if(reversedIndex>=0 && reversedIndex<data.length){
        data.splice(reversedIndex,1);
        localStorage.setItem(key,JSON.stringify(data));
        loadRecords();
      }
    });
  });
}

// ===== é›†è¨ˆ =====
let chart;
function updateSummary(period="all"){
  const data = JSON.parse(localStorage.getItem(key)||"[]");
  const now = new Date();

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  const filtered = data.filter(r=>{
    if(period==="all") return true;
    const d = new Date(r.date);
    const diffM = (now - d) / (1000*60*60*24*30);
    return diffM <= Number(period);
  });

  // æ—¥ä»˜ã”ã¨ã«åˆç®—
  const dailySum = {};
  filtered.forEach(r=>{
    const day = r.date; // yyyy-mm-dd
    if(!dailySum[day]) dailySum[day] = 0;
    dailySum[day] += r.incomeYen || 0;
  });

  // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
  const dates = Object.keys(dailySum).sort();
  let sum = 0;
  const sumArr = [];
  const labels = [];

  dates.forEach(d => {
    sum += dailySum[d];
    sumArr.push(sum);

    const dt = new Date(d);
    const mm = String(dt.getMonth() + 1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    labels.push(`${mm}/${dd}`);
  });

  // ã‚°ãƒ©ãƒ•æç”»
  const ctx = document.getElementById("chart").getContext("2d");
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets:[{label:"åæ”¯æ¨ç§»", data:sumArr, borderColor:"blue", tension:0.1}] },
    options: { responsive:true, plugins:{legend:{display:true}}, scales:{y:{beginAtZero:true}} }
  });

  document.getElementById("totalYen").textContent = sum;

// ç¨®åˆ¥ã”ã¨ã®ç‰æ•°æ®‹é«˜è¨ˆç®—ï¼ˆè¿½åŠ ç‰ + åæ”¯ã®ç´¯ç©ï¼‰
const balances = {slot46:0, slot5:0, pachi4:0, pachi1:0};
filtered.forEach(r => {
  if (!r.gameType || balances[r.gameType] === undefined) return;
  // ç‰æ•°åæ”¯ = endBall - (startBall + addBall)
  const diff = (r.endBall || 0) - ((r.startBall || 0) + (r.addBall || 0));
  balances[r.gameType] += (r.addBall || 0) + diff;
});

  document.getElementById("bal46").textContent = balances.slot46;
  document.getElementById("bal5").textContent = balances.slot5;
  document.getElementById("bal4").textContent = balances.pachi4;
  document.getElementById("bal1").textContent = balances.pachi1;

  // ç¾åœ¨è³‡ç”£æ®‹é«˜ï¼ˆå††ï¼‰ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
  let totalAssetYen = 0;
  for(const type of ["slot46","slot5","pachi4","pachi1"]){
  const ball = balances[type]; // æ®‹é«˜ï¼ˆç‰æ•°ï¼‰
  const yen = rate[type] ? Math.round(ball * rate[type]) : 0; // ã“ã“ãŒé‡è¦ï¼
  totalAssetYen += yen;
}
document.getElementById("totalAssetYen").textContent = totalAssetYen.toLocaleString() + "å††";


  document.getElementById("totalYen").textContent = sum;
}

document.querySelectorAll(".period-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".period-btn").forEach(b=>b.classList.replace("bg-blue-500","bg-gray-300"));
    btn.classList.replace("bg-gray-300","bg-blue-500");
    updateSummary(btn.dataset.period);
  });
});

// ===== å°ãƒ‡ãƒ¼ã‚¿ =====
let currentSortKey="", currentSortAsc=true;
function loadMachineData(){
  const shop=document.getElementById("searchShop").value.trim();
  const machineName=document.getElementById("searchMachineName").value.trim();
  const gameType=document.getElementById("searchGameType").value;
  const machineNo=document.getElementById("searchMachineNo").value.trim();

  const data=JSON.parse(localStorage.getItem(key)||"[]");
  const filtered=data.filter(r=>{
    if(shop && !r.shop.includes(shop)) return false;
    if(machineName && !r.machineName.includes(machineName)) return false;
    if(gameType && r.gameType!==gameType) return false;
    if(machineNo && r.machineNo!==machineNo) return false;
    return true;
  });

  const tbody=document.getElementById("machineDataList");
  tbody.innerHTML="";

  const grouped={};
  filtered.forEach(r=>{
    const k=r.machineNo||"__ALL__";
    if(!grouped[k]) grouped[k]=[];
    grouped[k].push(r);
  });

  const rows=[];

  // å…¨å°åˆç®—
  if(!machineNo && filtered.length>0){
    const allRecords=filtered;
    const playCount=allRecords.length;
    const firstHitRecords=allRecords.filter(r=>r.firstHitGame>0);
    const firstHitCount=firstHitRecords.length;
    const avgFirstHitG=firstHitCount>0?(firstHitRecords.reduce((a,r)=>a+r.firstHitGame,0)/firstHitCount).toFixed(1):"-";
    const avgInvest=firstHitCount>0?(firstHitRecords.reduce((a,r)=>a+(r.startBall+r.addBall-r.firstHitBall),0)/firstHitCount).toFixed(1):"-";
    const totalIncome=allRecords.reduce((a,r)=>a+r.incomeYen||0,0);
    const maxOutBall=allRecords.reduce((a,r)=>Math.max(a,r.outBall||0),0);
    const totalInvest=allRecords.reduce((a,r)=>a+(r.startBall+r.addBall-r.firstHitBall),0);
    const recoveryRateValue=totalInvest>0?((allRecords.reduce((a,r)=>a+(r.outBall||0),0)/totalInvest)*100):null;

    rows.push({
      shop:"å…¨å°åˆç®—",
      machineNo:"-",
      machineName:"-",
      gameType:"-",
      playCount,
      firstHitCount,
      avgFirstHitG,
      avgInvest,
      totalIncome,
      maxOutBall,
      recoveryRate: recoveryRateValue, // æ•°å€¤ã§ä¿æŒ
      isAll:true
    });
  }

  // å€‹åˆ¥å°
  Object.keys(grouped).sort().forEach(no=>{
    if(no==="__ALL__") return;
    const recs=grouped[no];
    const shopName=recs[0]?.shop||"-";
    const playCount=recs.length;
    const firstHitRecords=recs.filter(r=>r.firstHitGame>0);
    const firstHitCount=firstHitRecords.length;
    const avgFirstHitG=firstHitCount>0?(firstHitRecords.reduce((a,r)=>a+r.firstHitGame,0)/firstHitCount).toFixed(1):"-";
    const avgInvest=firstHitCount>0?(firstHitRecords.reduce((a,r)=>a+(r.startBall+r.addBall-r.firstHitBall),0)/firstHitCount).toFixed(1):"-";
    const totalIncome=recs.reduce((a,r)=>a+r.incomeYen||0,0);
    const maxOutBall=recs.reduce((a,r)=>Math.max(a,r.outBall||0),0);
    const totalInvest=recs.reduce((a,r)=>a+(r.startBall+r.addBall-r.firstHitBall),0);
    const recoveryRateValue=totalInvest>0?((recs.reduce((a,r)=>a+(r.outBall||0),0)/totalInvest)*100):null;

    rows.push({
      shop:shopName,
      machineNo:no,
      machineName:recs[0]?.machineName||"-",
      gameType:{pachi4:"4å††P",pachi1:"1å††P",slot46:"46æšS",slot5:"5å††S"}[recs[0]?.gameType]||"-",
      playCount,
      firstHitCount,
      avgFirstHitG,
      avgInvest,
      totalIncome,
      maxOutBall,
      recoveryRate: recoveryRateValue,
      isAll:false
    });
  });

  // ã‚½ãƒ¼ãƒˆ
  if(currentSortKey) rows.sort((a,b)=>{
    if(a.isAll) return -1;
    if(b.isAll) return 1;
    const valA=isNaN(a[currentSortKey])?a[currentSortKey]:Number(a[currentSortKey]);
    const valB=isNaN(b[currentSortKey])?b[currentSortKey]:Number(b[currentSortKey]);
    return valA<valB?(currentSortAsc?-1:1):valA>valB?(currentSortAsc?1:-1):0;
  });

  // æç”»
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    if(r.isAll) tr.classList.add("bg-pink-100");
    const recoveryText=r.recoveryRate!=null
      ? ((r.recoveryRate-100)>=0?"+":"") + (r.recoveryRate-100).toFixed(1) + "%"
      : "-";
    tr.innerHTML=`
      <td class="border p-1">${r.shop}</td>
      <td class="border p-1">${r.machineNo}</td>
      <td class="border p-1">${r.machineName}</td>
      <td class="border p-1">${r.gameType}</td>
      <td class="border p-1">${r.playCount}</td>
      <td class="border p-1">${r.firstHitCount}</td>
      <td class="border p-1">${r.avgFirstHitG}</td>
      <td class="border p-1">${r.avgInvest}</td>
      <td class="border p-1">${r.totalIncome}</td>
      <td class="border p-1">${r.maxOutBall}</td>
      <td class="border p-1">${recoveryText}</td>
    `;
    tbody.appendChild(tr);
  });
}

document.querySelectorAll("#machineData th[data-key]").forEach(th=>{
  th.addEventListener("click",()=>{
    const k=th.dataset.key;
    if(currentSortKey===k) currentSortAsc=!currentSortAsc;
    else{currentSortKey=k;currentSortAsc=true;}
    loadMachineData();
  });
});

document.getElementById("searchMachineBtn").addEventListener("click",e=>{
  e.preventDefault();
  loadMachineData();
});
</script>

</body>
</html>
