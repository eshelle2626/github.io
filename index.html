<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>éŠæŠ€è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<style>

/* ===== å±¥æ­´ãƒ»å°ãƒ‡ãƒ¼ã‚¿å…±é€š ===== */
#machineData th, #machineData td,
#recordList th, #recordList td {
  white-space: normal; /* æŠ˜ã‚Šè¿”ã—æœ‰åŠ¹ */
  word-break: break-word;
  text-align: center;
  padding: 4px;
}

/* âœ… è‡ªå‹•å¹…ã«æˆ»ã™ */
table {
  table-layout: auto;
  width: 100%;
}

</style>

<body class="bg-gray-100 p-4 min-h-screen">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-2xl shadow-lg">
    <h1 class="text-xl font-bold mb-4">çŒ«ã®ã‚¯ãƒƒã‚­ãƒ¼å±‹ã•ã‚“</h1>

    <!-- ã‚¿ãƒ–åˆ‡æ›¿ -->
    <div class="flex border-b mb-4">
      <button class="tab-button px-4 py-2 border-b-2 border-blue-500 font-semibold text-blue-500" data-tab="input">å…¥åŠ›</button>
      <button class="tab-button px-4 py-2 text-gray-500" data-tab="history">å±¥æ­´</button>
      <button class="tab-button px-4 py-2 text-gray-500" data-tab="summary">é›†è¨ˆ</button>
      <button class="tab-button px-4 py-2 text-gray-500" data-tab="machineData">å°ãƒ‡ãƒ¼ã‚¿</button>
    </div>

    <!-- å…¥åŠ›ã‚¿ãƒ– -->
    <div id="input" class="tab-content">
      <form id="recordForm" class="space-y-3">
<!-- 1è¡Œç›®ï¼šæ—¥ä»˜120pxã€åº—åæ®‹ã‚Šã€å°ç•ªå·1/4å¹… -->
<div class="flex gap-2">
  <div class="flex-none w-3/16">
    <input type="date" id="date" class="border rounded w-full p-2" required>
  </div>
  <div class="flex-1">
    <input type="text" id="shop" class="border rounded w-full p-2" placeholder="åº—å" value="ã‚¨ã‚¹ãƒ‘ã‚¹é«˜ç”°é¦¬å ´">
  </div>
  <div class="flex-none w-1/4">
    <input type="text" id="machineNo" class="border rounded w-full p-2" placeholder="å°ç•ªå·" inputmode="numeric" pattern="[0-9]*">
  </div>
</div>

        <!-- 2è¡Œç›® -->
        <div class="grid grid-cols-5 gap-2">
          <div class="col-span-3"><input type="text" id="machineName" class="border rounded w-full p-2" placeholder="æ©Ÿç¨®å"></div>
          <div class="col-span-2">
            <select id="gameType" class="border rounded w-full p-2">
              <option value="slot5">5å††ã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="slot46">46æšã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="pachi1">1å††ãƒ‘ãƒãƒ³ã‚³</option>
              <option value="pachi4">4å††ãƒ‘ãƒãƒ³ã‚³</option>
            </select>
          </div>
        </div>

        <!-- 3è¡Œç›® -->
<div class="grid grid-cols-3 gap-2">
  <!-- é–‹å§‹Gæ•° -->
  <div>
    <label class="block text-sm font-semibold">é–‹å§‹Gæ•°</label>
    <input type="text" id="startGame" class="border rounded w-full p-2" inputmode="numeric" pattern="[0-9]*">
  </div>

  <!-- é–‹å§‹æ™‚ç‰æ•° -->
  <div>
    <label class="block text-sm font-semibold">é–‹å§‹æ™‚ç‰æ•°</label>
    <input type="text" id="startBall" class="border rounded w-full p-2" inputmode="numeric" pattern="[0-9]*">
  </div>

  <!-- ä»–å£åº§æŒ¯æ›¿ + ç¾é‡‘è¿½åŠ ç‰ï¼ˆç¸¦ã«ä¸¦ã¹ã‚‹ï¼‰ -->
  <div class="flex flex-col gap-2">
    <!-- ä»–å£åº§æŒ¯æ›¿ -->
    <div>
      <label class="block text-sm font-semibold">ä»–å£åº§æŒ¯æ›¿</label>
      <input type="text" id="transfarBall" class="border rounded w-full p-2" value="0" inputmode="numeric" pattern="[0-9]*">
      <div class="flex justify-between mt-1">
        <button type="button" id="decTransfar" class="bg-blue-500 text-white rounded px-3 py-1 w-1/2 mr-1">-</button>
        <button type="button" id="incTransfar" class="bg-blue-500 text-white rounded px-3 py-1 w-1/2">+</button>
      </div>
    </div>

    <!-- ç¾é‡‘è¿½åŠ ç‰ -->
    <div>
      <label class="block text-sm font-semibold">ç¾é‡‘è¿½åŠ ç‰</label>
      <input type="text" id="cashBall" class="border rounded w-full p-2" value="0" inputmode="numeric" pattern="[0-9]*">
      <div class="flex justify-between mt-1">
        <button type="button" id="decCash" class="bg-pink-500 text-white rounded px-3 py-1 w-1/2 mr-1">-</button>
        <button type="button" id="incCash" class="bg-pink-500 text-white rounded px-3 py-1 w-1/2">+</button>
      </div>
    </div>
  </div>
</div>

<!-- 5è¡Œç›® -->
        <div class="grid grid-cols-6 gap-2 items-end">
          <div class="col-span-2">
            <label class="block text-sm font-semibold">åˆå½“ã‚Š/ãƒ¤ãƒ¡Gæ•°</label>
            <input type="text" id="firstHitGame" class="border rounded w-full p-2" inputmode="numeric" pattern="[0-9]*">
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-semibold">åˆå½“ã‚Šæ™‚ç‰æ•°<label class="ml-2">
  <input type="checkbox" id="isSingleBonus"> å˜ç™ºBçµ‚äº†
</label></label>
            <input type="text" id="firstHitBall" class="border rounded w-full p-2" inputmode="numeric" pattern="[0-9]*">
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-semibold">çµ‚äº†æ™‚ç‰æ•°</label>
            <input type="text" id="endBall" class="border rounded w-full p-2 bg-pink-50" inputmode="numeric" pattern="[0-9]*">
          </div>
        </div>

<!-- å›è»¢ç‡ãƒ»åæ”¯ + ç™»éŒ²ãƒœã‚¿ãƒ³ -->
<div class="mt-2 text-lg font-bold">
  <div class="flex justify-between">
    <div id="rotationDisplay">å›è»¢ç‡ï¼š<br>0.00</div>
    <div id="incomeDisplay">ç¾åœ¨åæ”¯ï¼š<br>0ï¼ˆ0å††ï¼‰</div>
  </div>
  <div class="flex justify-between mt-2">
    <button type="button" id="clearBtn" class="bg-gray-400 hover:bg-gray-500 text-white rounded w-16 py-1">ã‚¯ãƒªã‚¢</button>
    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white rounded w-16 py-1">ç™»éŒ²</button>
  </div>
</div>

      </form>
    </div>

<!-- å±¥æ­´ã‚¿ãƒ– -->
<div id="history" class="tab-content hidden">
  <div class="overflow-x-auto max-h-[80vh] overflow-y-auto">
    <table class="border text-sm min-w-[900px] table-fixed">
      <colgroup>
        <col style="width: 30px;">  <!-- æ—¥ä»˜ -->
        <col style="width: 45px;"> <!-- åº—å -->
        <col style="width: 30px;">  <!-- å°ç•ª -->
        <col style="width: 80px;"> <!-- æ©Ÿç¨®å -->
        <col style="width: 30px;">  <!-- ç¨®åˆ¥ -->
        <col style="width: 45px;">  <!-- åˆå½“ã‚ŠG -->
        <col style="width: 15px;">  <!-- ãƒœãƒ¼ãƒŠã‚¹ç¨®åˆ¥ -->
        <col style="width: 40px;">  <!-- å›è»¢ç‡ -->
        <col style="width: 30px;">  <!-- æŠ•è³‡ -->
        <col style="width: 30px;">  <!-- å‡ºç‰ -->
        <col style="width: 50px;">  <!-- åæ”¯ -->
        <col style="width: 30px;">  <!-- ç·¨é›† -->
        <col style="width: 15px;">  <!-- å‰Šé™¤ -->
      </colgroup>
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-1">æ—¥ä»˜</th>
          <th class="border p-1">åº—å</th>
          <th class="border p-1">å°ç•ª</th>
          <th class="border p-1">æ©Ÿç¨®å</th>
          <th class="border p-1">ç¨®åˆ¥</th>
          <th class="border p-1">åˆå½“ã‚ŠG<br>ï¼ˆè‡ªGï¼‰</th>
          <th class="border p-1">B</th>
          <th class="border p-1">å›è»¢ç‡</th>
          <th class="border p-1">æŠ•è³‡ç‰</th>
          <th class="border p-1">å‡ºç‰</th>
          <th class="border p-1">åæ”¯</th>
          <th class="border p-1">ç·¨é›†</th>
          <th class="border p-1">å‰Šé™¤</th>
        </tr>
      </thead>
      <tbody id="recordList"></tbody>
    </table>
  </div>
</div>


<!-- ç·¨é›†ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editModal" class="fixed inset-0 bg-black/50 hidden justify-center items-center z-50">
  <div class="bg-white p-6 rounded shadow-lg w-96">
    <h2 class="text-lg font-bold mb-4">ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ </h2>
    <form id="editForm" class="space-y-3">

      <!-- æ—¥ä»˜ãƒ»åº—å -->
      <div class="flex gap-2">
        <div class="flex-none w-1/3">
          <input type="date" name="date" class="border p-2 w-full">
        </div>
        <div class="flex-none w-1/3">
          <input type="text" name="shop" class="border p-2 w-full" placeholder="åº—å">
        </div>
       <div class="flex-none w-1/3">
          <select id="gameType" class="border rounded w-full p-2">
              <option value="slot5">5å††ã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="slot46">46æšã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="pachi1">1å††ãƒ‘ãƒãƒ³ã‚³</option>
              <option value="pachi4">4å††ãƒ‘ãƒãƒ³ã‚³</option>
            </select>
        </div>
      </div>

      <!-- å°ç•ªãƒ»æ©Ÿç¨®å -->
      <div class="flex gap-2">
        <div class="flex-none w-1/4">
          <input type="text" name="machineNo" class="border p-1 w-full" placeholder="å°ç•ª">
        </div>
        <div class="flex-none w-3/4">
          <input type="text" name="machineName" class="border p-1 w-full" placeholder="æ©Ÿç¨®å">
        </div>
      </div>

      <!-- é–‹å§‹Gæ•°ãƒ»é–‹å§‹æ™‚ç‰æ•° -->
      <div class="flex gap-2">
        <div class="flex-none w-1/2">
          <label class="block">é–‹å§‹Gæ•°</label>
          <input type="text" name="startGame" class="border p-1 w-full">
        </div>
        <div class="flex-none w-1/2">
          <label class="block">é–‹å§‹æ™‚ç‰æ•°</label>
          <input type="text" name="startBall" class="border p-1 w-full">
        </div>
      </div>

      <!-- è¿½åŠ ç‰ï¼ˆç·¨é›†éæ¨å¥¨ï¼‰ -->
      <div class="flex gap-2">
        <div class="flex-none w-1/2">
        </div>
        <div class="flex-none w-1/2">
          <label class="block">è¿½åŠ ç‰ï¼ˆç·¨é›†éæ¨å¥¨ï¼‰</label>
          <input type="text" name="addBall" class="border p-1 w-full">
        </div>
      </div>

      <!-- åˆå½“ã‚Š/ãƒ¤ãƒ¡Gæ•°ãƒ»åˆå½“ã‚Šæ™‚ç‰æ•° -->
      <div class="flex gap-2">
        <div class="flex-none w-1/2">
          <label class="block">åˆå½“ã‚Š/ãƒ¤ãƒ¡Gæ•°</label>
          <input type="text" name="firstHitGame" class="border p-1 w-full">
        </div>
        <div class="flex-none w-1/2">
          <label class="block">åˆå½“ã‚Šæ™‚ç‰æ•°</label>
          <input type="text" name="firstHitBall" class="border p-1 w-full">
        </div>
      </div>

      <!-- å˜ç™ºãƒœãƒ¼ãƒŠã‚¹çµ‚äº† -->
      <div class="flex justify-end">
        <label class="mr-2">å˜ç™ºãƒœãƒ¼ãƒŠã‚¹çµ‚äº†</label>
        <input type="checkbox" name="isSingleBonus" class="border p-1">
      </div>

      <!-- çµ‚äº†æ™‚ç‰æ•° -->
      <div class="flex gap-2">
        <div class="flex-none w-1/2">
        </div>
        <div class="flex-none w-1/2">
          <label class="block">çµ‚äº†æ™‚ç‰æ•°</label>
          <input type="text" name="endBall" class="border p-1 w-full">
        </div>
      </div>

      <!-- ãƒœã‚¿ãƒ³ -->
      <div class="flex justify-end gap-2 mt-4">
        <button type="button" id="closeModal" class="px-3 py-1 bg-gray-300 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">ä¿å­˜</button>
      </div>

    </form>
  </div>
</div>



    <!-- é›†è¨ˆã‚¿ãƒ– -->
    <div id="summary" class="tab-content hidden">
      <div class="space-y-3">
        <div class="text-lg font-semibold">ç·åæ”¯ï¼ˆå††ï¼‰ï¼š<span id="totalYen" class="font-bold text-blue-600">0</span></div>
<div class="text-lg font-semibold">
  ç¾åœ¨è³‡ç”£æ®‹é«˜ï¼ˆå††ï¼‰ï¼š<span id="totalAssetYen" class="font-bold text-green-600">0å††</span>
</div>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div>46æšã‚¹ãƒ­æ®‹é«˜ï¼š<span id="bal46">0</span></div>
          <div>5å††ã‚¹ãƒ­æ®‹é«˜ï¼š<span id="bal5">0</span></div>
          <div>4å††ãƒ‘ãƒæ®‹é«˜ï¼š<span id="bal4">0</span></div>
          <div>1å††ãƒ‘ãƒæ®‹é«˜ï¼š<span id="bal1">0</span></div>
        </div>

        <div class="flex space-x-2 mt-4">
          <button class="period-btn bg-blue-500 text-white rounded px-3 py-1" data-period="1">ç›´è¿‘1ãƒ¶æœˆ</button>
          <button class="period-btn bg-gray-300 rounded px-3 py-1" data-period="3">ç›´è¿‘3ãƒ¶æœˆ</button>
          <button class="period-btn bg-gray-300 rounded px-3 py-1" data-period="6">ç›´è¿‘åŠå¹´</button>
          <button class="period-btn bg-gray-300 rounded px-3 py-1" data-period="all">å…¨æœŸé–“</button>
        </div>

        <canvas id="chart" height="200"></canvas>
      </div>

<!-- é›†è¨ˆã‚¿ãƒ–æœ€ä¸‹éƒ¨ã«è¿½åŠ  -->
<div class="flex justify-between items-center mt-4">
  <!-- å·¦å´ï¼šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
  <div class="flex gap-2">
    <button id="exportBtn" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button id="importBtn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    <input type="file" id="importFile" accept=".json" class="hidden">
  </div>

  <!-- å³å´ï¼šå…¨å‰Šé™¤ -->
  <div>
    <button id="clearAllBtn" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">å…¨å‰Šé™¤</button>
  </div>
</div>


    </div>

    <!-- å°ãƒ‡ãƒ¼ã‚¿ã‚¿ãƒ– -->
    <div id="machineData" class="tab-content hidden">
      <div class="space-y-3">
        <form class="grid grid-cols-5 gap-2 items-end">
          <div><input type="text" id="searchShop" class="border rounded w-full p-2" placeholder="åº—å"></div>
          <div><input type="text" id="searchMachineNo" class="border rounded w-full p-2" placeholder="å°ç•ªå·"></div>
          <div><input type="text" id="searchMachineName" class="border rounded w-full p-2" placeholder="æ©Ÿç¨®å"></div>
          <div>
            <select id="searchGameType" class="border rounded w-full p-2">
              <option value="">å…¨ã¦ã®ç¨®åˆ¥</option>
              <option value="slot5">5å††ã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="slot46">46æšã‚¹ãƒ­ãƒƒãƒˆ</option>
              <option value="pachi1">1å††ãƒ‘ãƒãƒ³ã‚³</option>
              <option value="pachi4">4å††ãƒ‘ãƒãƒ³ã‚³</option>
            </select>
          </div>

          <div><button id="searchMachineBtn" class="bg-blue-500 text-white rounded px-3 py-1">æ¤œç´¢</button></div>
        </form>

  <div class="overflow-x-auto">
  <div class="overflow-x-auto max-h-[80vh] overflow-y-auto">
    <table class="border text-sm min-w-[900px] table-fixed mt-2">
      <colgroup>
        <col style="width: 45px;"> <!-- åº—å -->
        <col style="width: 30px;">  <!-- å°ç•ª -->
        <col style="width: 80px;"> <!-- æ©Ÿç¨®å -->
        <col style="width: 30px;">  <!-- ç¨®åˆ¥ -->
        <col style="width: 25px;">  <!-- ãƒ—ãƒ¬ã‚¤æ•° -->
        <col style="width: 25px;">  <!-- åˆå½“ã‚Š -->
        <col style="width: 30px;">  <!-- çªå…¥ç‡ -->
        <col style="width: 45px;">  <!-- å¹³å‡å›è»¢ç‡ -->
        <col style="width: 40px;">  <!-- å¹³å‡å½“G -->
        <col style="width: 50px;">  <!-- å¹³å‡å½“æŠ•è³‡ -->
        <col style="width: 55px;">  <!-- åˆè¨ˆåæ”¯ -->
        <col style="width: 40px;">  <!-- æœ€å¤§å‡ºç‰ -->
        <col style="width: 40px;">  <!-- å›åç‡ -->
      </colgroup>
      <thead class="bg-gray-200">
        <tr>
<th class="border p-1" data-key="shop">åº—å</th>
<th class="border p-1" data-key="machineNo">å°ç•ª</th>
<th class="border p-1" data-key="machineName">æ©Ÿç¨®å</th>
<th class="border p-1" data-key="gameType">ç¨®åˆ¥</th>
<th class="border p-1" data-key="playCount">ãƒ—ãƒ¬ã‚¤æ•°</th>
<th class="border p-1" data-key="firstHitCount">åˆ<br>å½“ã‚Š</th>
<th class="border p-1" data-key="penetrationRate">çªå…¥ç‡</th>
<th class="border p-1" data-key="avgRotation">å¹³å‡<br>å›è»¢ç‡</th>
<th class="border p-1" data-key="avgFirstHitG">å¹³å‡<br>å½“G</th>
<th class="border p-1" data-key="avgInvest">å¹³å‡<br>å¿…è¦æŠ•è³‡ç‰</th>
<th class="border p-1" data-key="totalIncome">åˆè¨ˆåæ”¯</th>
<th class="border p-1" data-key="maxOutBall">æœ€å¤§<br>å‡ºç‰</th>
<th class="border p-1" data-key="recoveryRate">å›åç‡</th>
        </tr>
      </thead>
      <tbody id="machineDataList"></tbody>
    </table>
  </div>
</div>

<script>
/* ===== JavaScript å®Œå…¨ç‰ˆ ===== */
document.addEventListener('touchstart', function(event) {
  if (event.touches.length > 1) {
    event.preventDefault();
  }
}, { passive: false });

let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
  const now = new Date().getTime();
  if (now - lastTouchEnd <= 300) {
    event.preventDefault();
  }
  lastTouchEnd = now;
}, false);

const fmt1 = v => (isNaN(v) || v === null || v === "") ? "-" : Number(v).toFixed(1);
const key = "pachi_records";
// 1ç‰ãƒ»1æšã‚ãŸã‚Šã®å††æ›ç®—ãƒ¬ãƒ¼ãƒˆ
const rate = {
  pachi1: 0.892,    // 1å††ãƒ‘ãƒãƒ³ã‚³
  pachi4: 3.568,    // 4å††ãƒ‘ãƒãƒ³ã‚³
  slot46: 19.23,    // 46æšã‚¹ãƒ­ãƒƒãƒˆ
  slot5: 4.42       // 5å††ã‚¹ãƒ­ãƒƒãƒˆ
};

const transfarRate = {
  slot5:   { target: "slot46", from: "slot5", rate: 23/100 },   // 5å††ã‚¹ãƒ­ â†’ 46æšã‚¹ãƒ­
  slot46:  { target: "slot5",  from: "slot46", rate: 200/46 },  // 46æšã‚¹ãƒ­ â†’ 5å††ã‚¹ãƒ­
  pachi4:  { target: "pachi1", from: "pachi4", rate: 500/125 }, // 4å††P â†’ 1å††P
  pachi1:  { target: "pachi4", from: "pachi1", rate: 25/100 }   // 1å††P â†’ 4å††P
};

const step = {pachi4:125, pachi1:100, slot46:46, slot5:100};
const investUnit = {pachi4:250, pachi1:200, slot46:46, slot5:50};

const dateInput = document.getElementById("date");
const today = new Date();
dateInput.value = today.toISOString().slice(0,10);

// ã‚¿ãƒ–åˆ‡æ›¿
document.querySelectorAll(".tab-button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    // å…¨ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll(".tab-button").forEach(b=>{
      b.classList.remove("border-blue-500","text-blue-500","font-semibold","bg-blue-100");
      b.classList.add("text-gray-500");
    });
    // é¸æŠä¸­ã‚¿ãƒ–ã‚’å¼·èª¿
    btn.classList.add("border-blue-500","text-blue-500","font-semibold","bg-blue-100");
    btn.classList.remove("text-gray-500");

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ‡æ›¿
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.add("hidden"));
    document.getElementById(btn.dataset.tab).classList.remove("hidden");

    // å„ã‚¿ãƒ–èª­ã¿è¾¼ã¿å‡¦ç†
    if(btn.dataset.tab==="history") loadRecords();
    if(btn.dataset.tab==="summary") updateSummary();
    if(btn.dataset.tab==="machineData") loadMachineData();
  });
});


// å…¥åŠ›å‡¦ç†
const form = document.getElementById("recordForm");
const transfarInput = document.getElementById("transfarBall");
const cashInput = document.getElementById("cashBall");
const gameTypeSelect = document.getElementById("gameType");

function updateSelectColor() {
  switch (gameTypeSelect.value) {
    case "slot5":
      gameTypeSelect.classList.remove("bg-blue-200","bg-green-200","bg-yellow-200");
      gameTypeSelect.classList.add("bg-blue-200");
      break;
    case "slot46":
      gameTypeSelect.classList.remove("bg-red-200","bg-green-200","bg-yellow-200");
      gameTypeSelect.classList.add("bg-red-200");
      break;
    case "pachi1":
      gameTypeSelect.classList.remove("bg-red-200","bg-blue-200","bg-yellow-200");
      gameTypeSelect.classList.add("bg-green-200");
      break;
    case "pachi4":
      gameTypeSelect.classList.remove("bg-red-200","bg-blue-200","bg-green-200");
      gameTypeSelect.classList.add("bg-yellow-200");
      break;
    default:
      gameTypeSelect.classList.remove("bg-red-200","bg-blue-200","bg-green-200","bg-yellow-200");
  }
}

// åˆæœŸè¡¨ç¤ºç”¨
updateSelectColor();

// å€¤å¤‰æ›´æ™‚
gameTypeSelect.addEventListener("change", updateSelectColor);

document.getElementById("incTransfar").addEventListener("click",()=>{
  const type = gameTypeSelect.value;
  transfarInput.value = Number(transfarInput.value||0) + (step[type]||0);
  updateIncome();
});
document.getElementById("decTransfar").addEventListener("click",()=>{
  const type = gameTypeSelect.value;
  transfarInput.value = Math.max(0, Number(transfarInput.value||0) - (step[type]||0));
  updateIncome();
});

document.getElementById("incCash").addEventListener("click",()=>{
  const type = gameTypeSelect.value;
  cashInput.value = Number(cashInput.value||0) + (step[type]||0);
  updateIncome();
});
document.getElementById("decCash").addEventListener("click",()=>{
  const type = gameTypeSelect.value;
  cashInput.value = Math.max(0, Number(cashInput.value||0) - (step[type]||0));
  updateIncome();
});

function updateIncome() {
  const startBall = Number(form.startBall.value) || 0;
  const endBall = Number(form.endBall.value) || 0;
  const transfarBall = Number(transfarInput.value) || 0;
const cashBall = Number(cashInput.value) || 0;
const addBall = transfarBall + cashBall;
const isSingleBonus = document.getElementById("isSingleBonus").checked;
  const firstHitBall = form.firstHitBall.value === "" ? null : Number(form.firstHitBall.value);
  const startG = Number(form.startGame.value) || 0;
  const endG = Number(form.firstHitGame.value) || 0;
  const type = form.gameType.value;

  // ä½¿ç”¨ç‰æ•°ï¼ˆåˆå½“ã‚Šç‰æ•°ãŒç©ºæ¬„ â†’ çµ‚äº†æ™‚ç‰æ•°ã‚’ä½¿ã†ï¼‰
  let usedBalls;
  if (firstHitBall === null || isNaN(firstHitBall)) {
    usedBalls = (startBall + addBall) - endBall;
  } else {
    usedBalls = (startBall + addBall) - firstHitBall;
  }
  if (usedBalls < 0) usedBalls = 0;

  // å›è»¢ç‡è¨ˆç®—
  const totalG = endG - startG;
  let rotationRate = 0;
  let rateUnit = "";

  if (usedBalls > 0 && totalG > 0) {
    switch (type) {
      case "slot46":
        rotationRate = (totalG / usedBalls) * 46;
        rateUnit = "/46æš";
        break;
      case "slot5":
        rotationRate = (totalG / usedBalls) * 50;
        rateUnit = "/50æš";
        break;
      case "pachi1":
        rotationRate = (totalG / usedBalls) * 200;
        rateUnit = "/200ç‰";
        break;
      case "pachi4":
        rotationRate = (totalG / usedBalls) * 250;
        rateUnit = "/250ç‰";
        break;
    }
  }

  document.getElementById("rotationDisplay").innerHTML =
  "å›è»¢ç‡ï¼š<br>" + (rotationRate ? rotationRate.toFixed(1) + "å›" + rateUnit : "-");

  // åæ”¯
  const diff = endBall - (startBall + addBall);
  const yen = rate[type] ? Math.round(diff * rate[type]) : 0;
  document.getElementById("incomeDisplay").innerHTML =  "ç¾åœ¨åæ”¯ï¼ˆå††ï¼‰ï¼š<br>" + (diff + "ï¼ˆ" + yen + "å††ï¼‰");
}

["startBall","endBall","transfarBall","cashBall","startGame","gameType","firstHitBall","firstHitGame"].forEach(id=>{
  document.getElementById(id).addEventListener("input",updateIncome);
});


// ç™»éŒ²ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
form.addEventListener("submit", (e) => {
  e.preventDefault();
  const isSingleBonus = document.getElementById("isSingleBonus").checked; // â† ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç›´æ¥å–å¾—


  if (!form.endBall.value) {
    alert("çµ‚äº†æ™‚ç‰æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  if (isSingleBonus && !form.firstHitBall.value) {
    alert("å˜ç™ºãƒœãƒ¼ãƒŠã‚¹åˆå½“ã‚Šæ™‚ç‰æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  if (!confirm("ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) return;

  const record = {
    date: form.date.value,
    shop: form.shop.value || "",
    machineNo: form.machineNo.value || "",
    machineName: form.machineName.value || "",
    gameType: form.gameType.value,
    startGame: Number(form.startGame.value) || 0,
    startBall: Number(form.startBall.value) || 0,
    addBall: (Number(transfarInput.value) || 0) + (Number(cashInput.value) || 0),
    firstHitGame: Number(form.firstHitGame.value) || 0,
    firstHitBall: form.firstHitBall.value === "" ? null : Number(form.firstHitBall.value),
    isSingleBonus: isSingleBonus, // â†è¿½åŠ 
    endBall: Number(form.endBall.value) || 0,
    created: new Date().toISOString()
  };

// ===== ä»–å£åº§æŒ¯æ›¿ã«ã‚ˆã‚‹æ®‹é«˜ãƒã‚¤ãƒŠã‚¹å‡¦ç† =====
const transfarValue = Number(transfarInput.value) || 0;

// ã“ã“ã§recordã«è£œæ­£å€¤ã‚’è¿½åŠ 
record.transfarDeduct = 0;

if(transfarValue > 0){
 const type = record.gameType;
const rateInfo = transfarRate[type];

if(rateInfo){
  const deduct = Math.round(transfarValue * rateInfo.rate);
  record.transfarDeduct = deduct;
}

}



// === å‡ºç‰ãƒ»å›è»¢ç‡ãƒ»åæ”¯ãªã©ã®è¨ˆç®— ===

// åˆå½“ã‚Šç‰æ•°ãŒç©ºæ¬„ãªã‚‰ãƒ¤ãƒ¡æ‰±ã„
const isYame = (form.firstHitBall.value === "" || form.firstHitBall.value === null);
record.firstHitBall = isYame ? null : Number(form.firstHitBall.value);
record.isYame = isYame;

// å‡ºç‰
record.outBall = record.firstHitBall === null
  ? 0
  : Math.max(0, record.endBall - record.firstHitBall);

// æŠ•è³‡ç‰æ•°
const usedBalls = record.firstHitBall === null
  ? (record.startBall + record.addBall - record.endBall)
  : (record.startBall + record.addBall - record.firstHitBall);

// ç·å›è»¢æ•°
const totalG = (record.firstHitGame && record.firstHitGame > 0 ? record.firstHitGame : record.endBall) - record.startGame;

// ç¨®åˆ¥ã«å¿œã˜ãŸå›è»¢ç‡ã®åŸºæº–
const investUnit = {
  slot46: 46,
  slot5: 50,
  pachi1: 200,
  pachi4: 250
};

const base = investUnit[record.gameType] || 0;
record.rotation = (usedBalls > 0 && totalG > 0)
  ? Number(((totalG * base) / usedBalls).toFixed(1))
  : 0;

// åæ”¯ï¼ˆå††æ›ç®—ï¼‰
const rate = {
  slot46: 19.23,
  slot5: 4.42,
  pachi1: 0.892,
  pachi4: 3.568
};

const diff = record.endBall - (record.startBall + record.addBall);
record.incomeYen = rate[record.gameType] ? Math.round(diff * rate[record.gameType]) : 0;
record.incomeText = `${diff}ï¼ˆ${record.incomeYen.toLocaleString()}å††ï¼‰`;


  // === ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ ===
  const data = JSON.parse(localStorage.getItem(key) || "[]");
  data.push(record);
  localStorage.setItem(key, JSON.stringify(data));

  // å‰å›å…¥åŠ›å€¤ã‚’ä¿æŒ
  localStorage.setItem("lastShop", record.shop);
  localStorage.setItem("lastMachineNo", record.machineNo);
  localStorage.setItem("lastModelName", record.machineName);
  localStorage.setItem("lastGameType", record.gameType);
  localStorage.setItem("lastDate", record.date);
  localStorage.setItem("lastEndBall", record.endBall); // æ¬¡å›é–‹å§‹ç‰æ•°ã«è»¢è¨˜ç”¨

  // === ç™»éŒ²å¾Œã®UIæ›´æ–°ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆãªã—ï¼‰ ===
  loadRecords();
  updateSummary();

  // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆç›´å‰ã®è¨­å®šã¯ä¿æŒï¼‰
  form.reset();
  form.shop.value = localStorage.getItem("lastShop") || "";
  form.machineNo.value = localStorage.getItem("lastMachineNo") || "";
  form.machineName.value = localStorage.getItem("lastModelName") || "";
  form.gameType.value = localStorage.getItem("lastGameType") || "slot5";
  form.date.value = localStorage.getItem("lastDate") || new Date().toISOString().slice(0,10);
  form.startBall.value = localStorage.getItem("lastEndBall") || 0;
  // ç™»éŒ²å¾Œãƒªã‚»ãƒƒãƒˆæ™‚ã« addBallInput ã‚’å‚ç…§ã—ãªã„
transfarInput.value = 0;
cashInput.value = 0;

  updateIncome();

  // âœ… ã€Œç™»éŒ²ã—ã¾ã—ãŸã€ã‚’ã‚¢ãƒ©ãƒ¼ãƒˆã§ã¯ãªãä¸€æ™‚çš„ãªUIè¡¨ç¤º
  const msg = document.createElement("div");
  msg.textContent = "ç™»éŒ²ã—ã¾ã—ãŸ";
  msg.className = "fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg text-sm";
  document.body.appendChild(msg);
  setTimeout(() => msg.remove(), 1500);
});


// ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
clearBtn.addEventListener("click", () => {
  if (!confirm("å…¥åŠ›å†…å®¹ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;

  localStorage.removeItem("lastShop");
  localStorage.removeItem("lastMachineNo");
  localStorage.removeItem("lastModelName");
  localStorage.removeItem("lastGameType");
  localStorage.removeItem("lastDate");
  localStorage.removeItem("lastEndBall");

  form.reset();

  // âœ… æ—¥ä»˜ã‚’æœ¬æ—¥ã«æˆ»ã™
  const today = new Date().toISOString().slice(0, 10);
  form.date.value = today;

  // âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å†è¨­å®š
  form.shop.value = "ã‚¨ã‚¹ãƒ‘ã‚¹é«˜ç”°é¦¬å ´";
  form.addBall.value = 0;

  // âœ… ç¨®åˆ¥ã‚’5å††ã‚¹ãƒ­ãƒƒãƒˆã«æˆ»ã™ & èƒŒæ™¯è‰²ã‚’blue-200ã«
  const gameTypeSelect = form.gameType;
  gameTypeSelect.value = "slot5";
  gameTypeSelect.classList.remove("bg-red-200", "bg-green-200", "bg-yellow-200");
  gameTypeSelect.classList.add("bg-blue-200");

  // âœ… æ®‹ã‚Šã®UIæ›´æ–°
  updateIncome();
});


// ===== å±¥æ­´ =====
function loadRecords() {
  const tbody = document.getElementById("recordList");
  tbody.innerHTML = "";

  const records = JSON.parse(localStorage.getItem(key) || "[]");
  const data = records.slice(-100).reverse(); // è¡¨ç¤ºç”¨ã«é€†é †

  data.forEach((r) => {
    const typeColors = { 
      slot5: "bg-blue-200", 
      slot46: "bg-red-200", 
      pachi1: "bg-green-200", 
      pachi4: "bg-yellow-200" 
    };

    const typeLabel = { 
      pachi4: "4å††P", 
      pachi1: "1å††P", 
      slot46: "46æšS", 
      slot5: "5å††S" 
    }[r.gameType] || "";

    const rotationUnit = { 
      slot46: "/46æš", 
      slot5: "/50æš", 
      pachi1: "/200ç‰", 
      pachi4: "/250ç‰" 
    };
    const rotationText = (typeof r.rotation === "number" ? r.rotation.toFixed(1) : "0.00") + "<br>" + (rotationUnit[r.gameType] || "");

    const incomeText = r.incomeText ? r.incomeText.replace('ï¼ˆ', '<br>ï¼ˆ') : "0<br>ï¼ˆ0å††ï¼‰";

    const firstHitDisplay = r.isYame ? "ãƒ¤ãƒ¡" : r.firstHitGame;
    const selfG = r.isYame ? r.endBall - r.startGame : (r.firstHitGame || r.endBall || 0) - (r.startGame || 0);

    // ===== ãƒœãƒ¼ãƒŠã‚¹ç¨®åˆ¥ã‚»ãƒ« =====
    let bonusText = "";
    let bonusCellClass = "";
    if (r.isSingleBonus) {
      bonusText = "å˜ç™º";
      bonusCellClass = "bg-gray-300";
    } else if (r.firstHitBall === null) {
      bonusText = "-";
      bonusCellClass = "bg-gray-300";
    }

    const tr = document.createElement("tr");

    // å…ƒé…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ï¼ˆcreatedãŒãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã¨ã—ã¦åˆ©ç”¨ï¼‰
    const originalIndex = records.findIndex(rec => rec.created === r.created);

    tr.innerHTML = `
      <td class="border p-1">${r.date?.slice(5) || ""}</td>
      <td class="border p-1">${r.shop || ""}</td>
      <td class="border p-1">${r.machineNo || ""}</td>
      <td class="border p-1">${r.machineName || ""}</td>
      <td class="border p-1 ${typeColors[r.gameType] || ""}">${typeLabel}</td>
      <td class="border p-1 ${r.isYame ? 'bg-gray-300' : ''}">
        ${firstHitDisplay}<br>ï¼ˆ${selfG}ï¼‰
      </td>
      <td class="border p-1 ${bonusCellClass}">${bonusText}</td>
      <td class="border p-1">${rotationText}</td>
      <td class="border p-1 text-right">${r.startBall + r.addBall - (r.firstHitBall || 0)}</td>
      <td class="border p-1 text-right">${r.outBall || 0}</td>
      <td class="border p-1 text-right ${r.incomeYen < 0 ? "text-red-500" : ""}">${incomeText}</td>
      <td class="border p-1 text-center">
        <button class="bg-yellow-300 px-2 py-1 rounded text-xs edit-btn" data-index="${originalIndex}">ç·¨é›†</button>
      </td>
      <td class="border p-1 text-center bg-yellow-200">
        <button data-index="${originalIndex}" class="delete-btn text-red-500">å‰Šé™¤</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // ç·¨é›†ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚å‡¦ç†
  const editModal = document.getElementById("editModal");
  const editForm = document.getElementById("editForm");
  const closeModal = document.getElementById("closeModal");
const typeColors = { slot5: "bg-blue-200", slot46: "bg-red-200", pachi1: "bg-green-200", pachi4: "bg-yellow-200" };

  function applyTypeColor() {
    editForm.gameType.classList.remove(...Object.values(typeColors));
    const selectedType = editForm.gameType.value;
    if (typeColors[selectedType]) editForm.gameType.classList.add(typeColors[selectedType]);
  }

// ğŸ”¹åŠè§’æ•°å­—ã®ã¿è¨±å¯ã™ã‚‹å¯¾è±¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
[
  "machineNo",
  "startGame",
  "startBall",
  "addBall",
  "firstHitGame",
  "firstHitBall",
  "endBall"
].forEach(name => {
  const input = editForm.querySelector(`[name="${name}"]`);
  if (input) {
    input.addEventListener("input", () => {
      input.value = input.value.replace(/[^\d]/g, ""); // æ•°å­—ä»¥å¤–å‰Šé™¤
    });
  }
});

  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const idx = Number(btn.dataset.index);
      const records = JSON.parse(localStorage.getItem(key)) || [];
      const r = records[idx];
      if (!r) return;

      editForm.date.value = r.date;
      editForm.shop.value = r.shop;
      editForm.gameType.value = r.gameType || "slot5";
      editForm.machineNo.value = r.machineNo;
      editForm.machineName.value = r.machineName;
      editForm.startGame.value = r.startGame || 0;
      editForm.startBall.value = r.startBall || 0;
      editForm.addBall.value = r.addBall || 0;
      editForm.firstHitGame.value = r.firstHitGame || 0;
      editForm.firstHitBall.value = r.firstHitBall || "";
      editForm.isSingleBonus.checked = r.isSingleBonus || false;
      editForm.endBall.value = r.endBall || 0;

      editForm.dataset.editIndex = idx;
      applyTypeColor(); // è‰²é©ç”¨

      editModal.classList.remove("hidden");
      editModal.classList.add("flex");
    });
  });

  closeModal.addEventListener("click", () => {
    editModal.classList.add("hidden");
    editModal.classList.remove("flex");
  });

  editForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const records = JSON.parse(localStorage.getItem(key)) || [];
    const idx = Number(editForm.dataset.editIndex);
    if (idx < 0 || idx >= records.length) return;

    const isSingleBonus = editForm.isSingleBonus.checked;
    const addBall = Number(editForm.addBall.value) || 0;

    const updated = {
      date: editForm.date.value,
      shop: editForm.shop.value,
      machineNo: editForm.machineNo.value,
      machineName: editForm.machineName.value,
      gameType: editForm.gameType?.value || records[idx].gameType,
      startGame: Number(editForm.startGame.value) || 0,
      startBall: Number(editForm.startBall.value) || 0,
      addBall: addBall,
      firstHitGame: Number(editForm.firstHitGame.value) || 0,
      firstHitBall: editForm.firstHitBall.value === "" ? null : Number(editForm.firstHitBall.value),
      isSingleBonus: isSingleBonus,
      endBall: Number(editForm.endBall.value) || 0,
      created: records[idx].created
    };

    // å‡ºç‰ãƒ»æŠ•è³‡ç‰ãƒ»å›è»¢ç‡ãƒ»åæ”¯ã®å†è¨ˆç®—
    const isYame = updated.firstHitBall === null;
    updated.isYame = isYame;
    updated.outBall = isYame ? 0 : Math.max(0, updated.endBall - updated.firstHitBall);
    const usedBalls = isYame ? (updated.startBall + updated.addBall - updated.endBall) 
                              : (updated.startBall + updated.addBall - updated.firstHitBall);
    const totalG = (updated.firstHitGame && updated.firstHitGame > 0 ? updated.firstHitGame : updated.endBall) - updated.startGame;
    const investUnit = {slot46:46, slot5:50, pachi1:200, pachi4:250};
    const base = investUnit[updated.gameType] || 0;
    updated.rotation = (usedBalls > 0 && totalG > 0) ? Number(((totalG * base)/usedBalls).toFixed(1)) : 0;

    const rate = {slot46:19.23, slot5:4.42, pachi1:0.892, pachi4:3.568};
    const diff = updated.endBall - (updated.startBall + updated.addBall);
    updated.incomeYen = rate[updated.gameType] ? Math.round(diff * rate[updated.gameType]) : 0;
    updated.incomeText = `${diff}ï¼ˆ${updated.incomeYen.toLocaleString()}å††ï¼‰`;

    records[idx] = updated;
    localStorage.setItem(key, JSON.stringify(records));

    editModal.classList.add("hidden");
    editModal.classList.remove("flex");
    loadRecords();
    updateSummary();
  });

  // å‰Šé™¤ãƒœã‚¿ãƒ³
  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      const idx = Number(btn.dataset.index);
      const data = JSON.parse(localStorage.getItem(key) || "[]");
      if (idx >= 0 && idx < data.length) {
        data.splice(idx, 1);
        localStorage.setItem(key, JSON.stringify(data));
        loadRecords();
      }
    });
  });
}


// ===== é›†è¨ˆ =====
let chart;
function updateSummary(period="all"){
  const data = JSON.parse(localStorage.getItem(key)||"[]");
  const now = new Date();

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  const filtered = data.filter(r=>{
    if(period==="all") return true;
    const d = new Date(r.date);
    const diffM = (now - d) / (1000*60*60*24*30);
    return diffM <= Number(period);
  });

  // æ—¥ä»˜ã”ã¨ã«åˆç®—
  const dailySum = {};
  filtered.forEach(r=>{
    const day = r.date; // yyyy-mm-dd
    if(!dailySum[day]) dailySum[day] = 0;
    dailySum[day] += r.incomeYen || 0;
  });

  // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
  const dates = Object.keys(dailySum).sort();
  let sum = 0;
  const sumArr = [];
  const labels = [];

  dates.forEach(d => {
    sum += dailySum[d];
    sumArr.push(sum);

    const dt = new Date(d);
    const mm = String(dt.getMonth() + 1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    labels.push(`${mm}/${dd}`);
  });

  // ã‚°ãƒ©ãƒ•æç”»
  const ctx = document.getElementById("chart").getContext("2d");
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets:[{label:"åæ”¯æ¨ç§»", data:sumArr, borderColor:"blue", tension:0.1}] },
    options: { responsive:true, plugins:{legend:{display:true}}, scales:{y:{beginAtZero:true}} }
  });

  document.getElementById("totalYen").textContent = sum.toLocaleString() + "å††";

// ç¨®åˆ¥ã”ã¨ã®ç‰æ•°æ®‹é«˜è¨ˆç®—ï¼ˆè¿½åŠ ç‰ + åæ”¯ã®ç´¯ç©ï¼‰
const balances = {slot46:0, slot5:0, pachi4:0, pachi1:0};

filtered.forEach(r => {
  if (!r.gameType || balances[r.gameType] === undefined) return;

  const diff = (r.endBall || 0) - ((r.startBall || 0) + (r.addBall || 0));

  // æŒ¯æ›¿ãŒã‚ã‚‹å ´åˆã¯ target ã«åŠ ç®—/æ¸›ç®—
  if(r.transfarDeduct && transfarRate[r.gameType]){
    const target = transfarRate[r.gameType].target;
    balances[target] -= r.transfarDeduct; // æŒ¯æ›¿åˆ†ã‚’ç›¸æ‰‹å£åº§ã§æ¸›ç®—
  }

  balances[r.gameType] += (r.addBall || 0) + diff;
});


document.getElementById("bal46").textContent = balances.slot46.toLocaleString() + "æš";
document.getElementById("bal5").textContent = balances.slot5.toLocaleString() + "æš";
document.getElementById("bal4").textContent = balances.pachi4.toLocaleString() + "ç‰";
document.getElementById("bal1").textContent = balances.pachi1.toLocaleString() + "ç‰";

  // ç¾åœ¨è³‡ç”£æ®‹é«˜ï¼ˆå††ï¼‰ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
  let totalAssetYen = 0;
  for(const type of ["slot46","slot5","pachi4","pachi1"]){
  const ball = balances[type]; // æ®‹é«˜ï¼ˆç‰æ•°ï¼‰
  const yen = rate[type] ? Math.round(ball * rate[type]) : 0; // ã“ã“ãŒé‡è¦ï¼
  totalAssetYen += yen;
}
document.getElementById("totalAssetYen").textContent = totalAssetYen.toLocaleString() + "å††";


  document.getElementById("totalYen").textContent = sum.toLocaleString() + "å††";
}

document.querySelectorAll(".period-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".period-btn").forEach(b=>b.classList.replace("bg-blue-500","bg-gray-300"));
    btn.classList.replace("bg-gray-300","bg-blue-500");
    updateSummary(btn.dataset.period);
  });
});

// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
document.getElementById("exportBtn").addEventListener("click", () => {
  const data = JSON.parse(localStorage.getItem(key) || "[]");
  if(data.length === 0){
    alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const a = document.createElement("a");
  const today = new Date().toISOString().slice(0,10);
  a.download = `pachi_records_${today}.json`;
  a.href = URL.createObjectURL(blob);
  a.click();
  URL.revokeObjectURL(a.href);
});

// ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const importFileInput = document.getElementById("importFile");
document.getElementById("importBtn").addEventListener("click", () => {
  importFileInput.click();
});

importFileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const imported = JSON.parse(event.target.result);
      const existing = JSON.parse(localStorage.getItem(key) || "[]");

      let added = 0;
      let skipped = 0;

      imported.forEach(r => {
        // é‡è¤‡ãƒã‚§ãƒƒã‚¯: æ—¥ä»˜, åº—å, å°ç•ª, æ©Ÿç¨®å, åˆå½“ã‚ŠG, çµ‚äº†ç‰æ•°
        const duplicate = existing.some(e =>
          e.date === r.date &&
          e.shop === r.shop &&
          e.machineNo === r.machineNo &&
          e.machineName === r.machineName &&
          e.firstHitGame === r.firstHitGame &&
          e.endBall === r.endBall
        );
        if(duplicate) skipped++;
        else {
          existing.push(r);
          added++;
        }
      });

      localStorage.setItem(key, JSON.stringify(existing));
      alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\nè¿½åŠ ä»¶æ•°: ${added}\né‡è¤‡ã‚¹ã‚­ãƒƒãƒ—: ${skipped}`);
      loadRecords();
      updateSummary();

    } catch(err) {
      alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      console.error(err);
    }
  };
  reader.readAsText(file);
  e.target.value = ""; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒªã‚»ãƒƒãƒˆ
});

// å…¨å‰Šé™¤
document.getElementById("clearAllBtn").addEventListener("click", () => {
  if(!confirm("æœ¬å½“ã«å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  if(!confirm("äºŒé‡ç¢ºèª: å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;

  localStorage.removeItem(key);
  loadRecords();
  updateSummary();
  alert("ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚");
});


// ===== å°ãƒ‡ãƒ¼ã‚¿ =====
let currentSortKey="", currentSortAsc=true;
function loadMachineData(){
  const shop=document.getElementById("searchShop").value.trim();
  const machineName=document.getElementById("searchMachineName").value.trim();
  const gameType=document.getElementById("searchGameType").value;
  const machineNo=document.getElementById("searchMachineNo").value.trim();

  const data=JSON.parse(localStorage.getItem(key)||"[]");
  const filtered=data.filter(r=>{
    if(shop && !r.shop.includes(shop)) return false;
    if(machineName && !r.machineName.includes(machineName)) return false;
    if(gameType && r.gameType!==gameType) return false;
    if(machineNo && r.machineNo!==machineNo) return false;
    return true;
  });

  const tbody=document.getElementById("machineDataList");
  tbody.innerHTML="";

  const grouped={};
  filtered.forEach(r=>{
    const k=r.machineNo||"__ALL__";
    if(!grouped[k]) grouped[k]=[];
    grouped[k].push(r);
  });

  const rows=[];

// å…¨å°åˆç®—
if(!machineNo && filtered.length>0){
  // ã€Œèª¿æ•´ã€ã€Œå‡ºé‡‘ã€ã€ŒæŒ¯æ›¿ã€ã¯é›†è¨ˆå¯¾è±¡å¤–
const allRecords = filtered.filter(r => r.machineName !== "èª¿æ•´" && r.machineName !== "å‡ºé‡‘" && r.machineName !== "æŒ¯æ›¿");

  const playCount = allRecords.length;

  // åˆå½“ã‚Šç‰æ•°ãŒã‚ã‚‹ã‚‚ã®ã®ã¿ã§å¹³å‡è¨ˆç®—
  const firstHitRecords = allRecords.filter(r => r.firstHitBall !== null && !r.isYame);
  const firstHitCount = firstHitRecords.length;

    // === çªå…¥ç‡ ===
  const nonSingleCount = firstHitRecords.filter(r => !r.isSingleBonus).length;
  const penetrationRate = firstHitCount > 0
    ? `${((nonSingleCount / firstHitCount) * 100).toFixed(0)}%`
    : "-";

  let avgRotation = "-";
  let avgFirstHitG = "-";
  let avgInvest = "-";

  if(firstHitCount > 0){
    const sumRotation = firstHitRecords.reduce((a,r)=>a+(r.rotation||0),0);
    const unitMap = { slot46:"/46æš", slot5:"/50æš", pachi1:"/200ç‰", pachi4:"/250ç‰" };
    const unit = unitMap[firstHitRecords[0].gameType] || "";
    avgRotation = (sumRotation / firstHitCount).toFixed(1) + "<br>" + unit;

    avgFirstHitG = (firstHitRecords.reduce((a,r)=>a+r.firstHitGame,0)/firstHitCount).toFixed(1);
    avgInvest = (firstHitRecords.reduce((a,r)=>a+(r.startBall+r.addBall-r.firstHitBall),0)/firstHitCount).toFixed(1);
  }

  // åˆè¨ˆï¼šç‰åæ”¯ï¼ˆç‰ï¼‰ã¨å††åæ”¯ï¼ˆå††ï¼‰ã‚’åˆ¥ã§è¨ˆç®—
const totalIncomeBall = allRecords.reduce((a,r) => {
  const diffBall = (r.endBall || 0) - ((r.startBall || 0) + (r.addBall || 0));
  return a + diffBall;
}, 0);

const totalIncomeYen = allRecords.reduce((a,r) => {
  const diffBall = (r.endBall || 0) - ((r.startBall || 0) + (r.addBall || 0));
  const rrate = rate[r.gameType] || 0; // rate ã¯ãƒ•ã‚¡ã‚¤ãƒ«ä¸Šéƒ¨ã§å®šç¾©æ¸ˆã¿
  return a + Math.round(diffBall * rrate);
}, 0);

  const maxOutBall = allRecords.reduce((a,r)=>Math.max(a,r.outBall||0),0);
  const totalInvest = allRecords.reduce((a,r)=>a + ((r.startBall + r.addBall - (r.firstHitBall||0)) || 0), 0);
  const totalOutBall = allRecords.reduce((a,r)=>a + (r.outBall||0), 0);
  let recoveryRateValue = totalInvest > 0 ? (totalOutBall / totalInvest) * 100 : null;

// Â±è¡¨ç¤ºç”¨
let recoveryText = "-";
let recoveryClass = "";
if(recoveryRateValue !== null){
  const diff = recoveryRateValue - 100;
  recoveryText = (diff >= 0 ? "+" : "") + diff.toFixed(1) + "%";
  if(diff < 0) recoveryClass = "text-red-500"; // ãƒã‚¤ãƒŠã‚¹ãªã‚‰èµ¤å­—
}

// rows.pushå†…ã§ä½¿ç”¨
rows.push({
  shop: "å…¨å°åˆç®—",
  machineNo: "-",
  machineName: "-",
  gameType: "-",
  playCount,
  firstHitCount,
  penetrationRate,
  avgFirstHitG,
  avgInvest,
  avgRotation,
  totalIncomeBall,    // ç‰åæ”¯ï¼ˆç‰ï¼‰
  totalIncomeYen,     // å††åæ”¯ï¼ˆå††ï¼‰
  maxOutBall,
  recoveryRate: recoveryText,
  recoveryClass: recoveryClass,
  isAll: true
});

}

 // ===== å€‹åˆ¥å° =====
  Object.keys(grouped).sort().forEach(no=>{
    if(no==="__ALL__") return;

  // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãŸãƒ‡ãƒ¼ã‚¿å–å¾—
  const recs = grouped[no].filter(r =>
    r.machineName !== "èª¿æ•´" &&
    r.machineName !== "å‡ºé‡‘" &&
    r.machineName !== "æŒ¯æ›¿"
  );

  // é™¤å¤–å¾Œã«ãƒ‡ãƒ¼ã‚¿ãŒç©ºãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
  if (recs.length === 0) return;

  const shopName = recs[0]?.shop || "-";
  const playCount = recs.length;
  const firstHitRecords = recs.filter(r => r.firstHitBall != null && r.firstHitGame > 0);
  const firstHitCount = firstHitRecords.length;

  // === çªå…¥ç‡ ===
  const nonSingleCount = firstHitRecords.filter(r => !r.isSingleBonus).length; // å˜ç™ºãƒœãƒ¼ãƒŠã‚¹ãŒ false ã®ä»¶æ•°
  const penetrationRate = firstHitCount > 0
    ? `${((nonSingleCount / firstHitCount) * 100).toFixed(0)}%`
    : "-";


   // å¹³å‡å›è»¢ç‡ï¼ˆä»¶æ•°ã§å‰²ã‚‹ã‚ˆã†ä¿®æ­£ï¼‰
let totalRotation = 0;
let validCount = 0;

recs.forEach(r => {
  const usedBalls = r.firstHitBall === null
    ? (r.startBall + r.addBall - r.endBall)  // åˆå½“ã‚Šãªã—â†’ãƒ¤ãƒ¡æ™‚æŠ•è³‡
    : (r.startBall + r.addBall - r.firstHitBall); // åˆå½“ã‚Šã‚ã‚Šâ†’åˆå½“ã‚Šã¾ã§ã®æŠ•è³‡
  const totalG = (r.firstHitGame && r.firstHitGame > 0)
    ? (r.firstHitGame - r.startGame)
    : (r.endGame - r.startGame); // åˆå½“ã‚Šãªã—â†’ãƒ¤ãƒ¡æ™‚ã¾ã§ã®Gæ•°

  const base = investUnit[r.gameType] || 0;
  if (usedBalls > 0 && totalG > 0) {
    const rotation = (totalG * base / usedBalls);
    totalRotation += rotation;
    validCount++;
  }
});

avgRotation = validCount > 0 ? (totalRotation / validCount).toFixed(1) : "-";


    const avgFirstHitG=firstHitCount>0?(firstHitRecords.reduce((a,r)=>a+r.firstHitGame,0)/firstHitCount).toFixed(1):"-";
    const avgInvest=firstHitCount>0?(firstHitRecords.reduce((a,r)=>a+(r.startBall+r.addBall-r.firstHitBall),0)/firstHitCount).toFixed(1):"-";
    // å€‹åˆ¥å°ï¼šç‰åæ”¯ï¼ˆç‰ï¼‰ã¨å††åæ”¯ï¼ˆå††ï¼‰ã‚’åˆ¥ã§è¨ˆç®—
const totalIncomeBall = recs.reduce((a, r) => {
  const diffBall = (r.endBall || 0) - ((r.startBall || 0) + (r.addBall || 0));
  return a + diffBall;
}, 0);

const totalIncomeYen = recs.reduce((a, r) => {
  const diffBall = (r.endBall || 0) - ((r.startBall || 0) + (r.addBall || 0));
  const rrate = rate[r.gameType] || 0;
  return a + Math.round(diffBall * rrate);
}, 0);

    const maxOutBall=recs.reduce((a,r)=>Math.max(a,r.outBall||0),0);

    const totalInvest = recs.reduce((a,r)=>a + ((r.startBall + r.addBall - (r.firstHitBall||0)) || 0), 0);
const totalOutBall = recs.reduce((a,r)=>a + (r.outBall||0), 0);
let recoveryRateValue = totalInvest > 0 ? (totalOutBall / totalInvest) * 100 : null;

let recoveryText = "-";
let recoveryClass = "";
if(recoveryRateValue !== null){
  const diff = recoveryRateValue - 100;
  recoveryText = (diff >= 0 ? "+" : "") + diff.toFixed(1) + "%";
  if(diff < 0) recoveryClass = "text-red-500";
}

rows.push({
  shop: shopName,
  machineNo: no,
  machineName: recs[0]?.machineName || "-",
  gameType: {pachi4:"4å††P",pachi1:"1å††P",slot46:"46æšS",slot5:"5å††S"}[recs[0]?.gameType] || "-",
  playCount,
  firstHitCount,
  penetrationRate,
  avgFirstHitG,
  avgInvest,
  avgRotation,
  totalIncomeBall,
  totalIncomeYen,
  maxOutBall,
  recoveryRate: recoveryText,
  recoveryClass: recoveryClass,
  isAll: false
});
  });

  // ã‚½ãƒ¼ãƒˆ
  if(currentSortKey) rows.sort((a,b)=>{
    if(a.isAll) return -1;
    if(b.isAll) return 1;
    const valA=isNaN(a[currentSortKey])?a[currentSortKey]:Number(a[currentSortKey]);
    const valB=isNaN(b[currentSortKey])?b[currentSortKey]:Number(b[currentSortKey]);
    return valA<valB?(currentSortAsc?-1:1):valA>valB?(currentSortAsc?1:-1):0;
  });

  // æç”»
  rows.forEach(r=>{
  const typeColors = { 
    "5å††S": "bg-blue-200", 
    "46æšS": "bg-red-200", 
    "1å††P": "bg-green-200", 
    "4å††P": "bg-yellow-200" 
  };

  const recoveryText = r.recoveryRate != null
    ? ((r.recoveryRate - 100) >= 0 ? "+" : "") + (r.recoveryRate - 100).toFixed(1) + "%"
    : "-";

  const recoveryClass = (r.recoveryRate - 100) < 0 ? "text-red-500" : "";
  const totalIncomeClass = r.totalIncome < 0 ? "text-red-500" : "";

  // å€‹åˆ¥å°ã®å¹³å‡å›è»¢ç‡ã«æ”¹è¡Œã¨å˜ä½è¿½åŠ 
  const avgRotationText = r.avgRotation !== "-" && r.gameType && !r.isAll
    ? r.avgRotation + "<br>" + { "5å††S": "/50æš", "46æšS": "/46æš", "1å††P": "/200ç‰", "4å††P": "/250ç‰" }[r.gameType]
    : r.avgRotation;

  const tr = document.createElement("tr");
  if(r.isAll) tr.classList.add("bg-pink-100");
  tr.innerHTML = `
    <td class="border p-1">${r.shop}</td>
    <td class="border p-1">${r.machineNo}</td>
    <td class="border p-1">${r.machineName}</td>
    <td class="border p-1 ${typeColors[r.gameType] || ""}">${r.gameType}</td>
    <td class="border p-1">${r.playCount}</td>
    <td class="border p-1">${r.firstHitCount}</td>
    <td class="border p-1">${r.penetrationRate}</td>
    <td class="border p-1">${avgRotationText}</td>
    <td class="border p-1">${r.avgFirstHitG}</td>
    <td class="border p-1">${r.avgInvest}</td>
    <td class="border p-1 ${r.totalIncomeBall < 0 ? 'text-red-500' : ''}">
  ${r.totalIncomeBall.toLocaleString()}<br>
  (${r.totalIncomeYen.toLocaleString()}å††)
</td>

    <td class="border p-1">${r.maxOutBall}</td>
    <td class="border p-1 ${r.recoveryClass}">${r.recoveryRate}</td>
  `;
  tbody.appendChild(tr);
});
}

document.querySelectorAll("#machineData th[data-key]").forEach(th=>{
  th.addEventListener("click",()=>{
    const k=th.dataset.key;
    if(currentSortKey===k) currentSortAsc=!currentSortAsc;
    else{currentSortKey=k;currentSortAsc=true;}
    loadMachineData();
  });
});

document.getElementById("searchMachineBtn").addEventListener("click",e=>{
  e.preventDefault();
  loadMachineData();
});
</script>

</body>
</html>
