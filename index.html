<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>リスのクッキーやさん</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<style>
/* ===== 共通設定 ===== */
#machineData th, #machineData td,
#recordList th, #recordList td {
  white-space: normal;
  word-break: break-word;
  text-align: center;
  padding: 4px;
}
table { table-layout: auto; width: 100%; }
.highlight-row { background-color: #fff7cc; transition: background-color 0.2s ease; }

/* 機種名タップ用のスタイル */
.clickable-name { 
  color: #2563eb; 
  text-decoration: underline; 
  cursor: pointer; 
  font-weight: bold;
}
</style>

<body class="bg-gray-100 p-4 min-h-screen">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-2xl shadow-lg">

    <div class="flex border-b mb-4 bg-white sticky top-0 z-50">
      <button class="tab-button px-4 py-2 border-b-2 border-blue-500 font-semibold text-blue-500 bg-blue-100" data-tab="input">入力</button>
      <button class="tab-button px-4 py-2 text-gray-500" data-tab="history">履歴</button>
      <button class="tab-button px-4 py-2 text-gray-500" data-tab="summary">集計</button>
      <button class="tab-button px-4 py-2 text-gray-500" data-tab="machineData">台データ</button>
    </div>

    <div id="input" class="tab-content">
      <form id="recordForm" class="space-y-3">
        <div class="flex gap-2">
          <div class="flex-none w-3/16"><input type="date" id="date" class="border rounded w-full p-2" required></div>
          <div class="flex-1"><input type="text" id="shop" class="border rounded w-full p-2" placeholder="店名" value="エスパス高田馬場"></div>
          <div class="flex-none w-1/4"><input type="number" id="machineNo" class="border rounded w-full p-2" placeholder="台番" inputmode="numeric"></div>
        </div>

        <div class="grid grid-cols-5 gap-2">
          <div class="col-span-3"><input type="text" id="machineName" class="border rounded w-full p-2" placeholder="機種名"></div>
          <div class="col-span-2">
            <select id="gameType" class="border rounded w-full p-2 font-bold">
              <option value="slot625" selected>6.25円スロット</option>
              <option value="slot46">46枚スロット</option>
              <option value="slot5">5円スロット</option>
              <option value="pachi1">1円パチンコ</option>
              <option value="pachi4">4円パチンコ</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-2">
          <div><label class="block text-sm font-semibold">開始G数</label><input type="number" id="startGame" class="border rounded w-full p-2" inputmode="numeric"></div>
          <div><label class="block text-sm font-semibold">開始時玉数</label><input type="number" id="startBall" class="border rounded w-full p-2" inputmode="numeric"></div>
          <div class="flex flex-col gap-2">
            <div>
              <label class="block text-sm font-semibold">他口座振替</label>
              <input type="number" id="transfarBall" class="border rounded w-full p-2" value="0" inputmode="numeric">
              <div class="flex justify-between mt-1">
                <button type="button" id="decTransfar" class="bg-blue-500 text-white rounded px-3 py-1 w-1/2 mr-1">-</button>
                <button type="button" id="incTransfar" class="bg-blue-500 text-white rounded px-3 py-1 w-1/2">+</button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-semibold">現金追加玉</label>
              <input type="number" id="cashBall" class="border rounded w-full p-2" value="0" inputmode="numeric">
              <div class="flex justify-between mt-1">
                <button type="button" id="decCash" class="bg-pink-500 text-white rounded px-3 py-1 w-1/2 mr-1">-</button>
                <button type="button" id="incCash" class="bg-pink-500 text-white rounded px-3 py-1 w-1/2">+</button>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-6 gap-2 items-end">
          <div class="col-span-2"><label class="block text-sm font-semibold">初当り/ヤメG</label><input type="number" id="firstHitGame" class="border rounded w-full p-2" inputmode="numeric"></div>
          <div class="col-span-2"><label class="block text-sm font-semibold">初当り時玉数 <label class="ml-2"><input type="checkbox" id="isSingleBonus"> 単発</label></label><input type="text" id="firstHitBall" class="border rounded w-full p-2" inputmode="numeric"></div>
          <div class="col-span-2"><label class="block text-sm font-semibold">終了時玉数</label><input type="number" id="endBall" class="border rounded w-full p-2 bg-pink-50" inputmode="numeric"></div>
        </div>

        <input type="text" id="remarks" class="border rounded w-full p-2" placeholder="備考">

        <div class="mt-2 text-lg font-bold">
          <div class="flex justify-between"><div id="rotationDisplay">回転率：<br>0.00</div><div id="incomeDisplay">現在収支：<br>0（0円）</div></div>
          <div class="flex justify-between mt-2">
            <button type="button" id="clearBtn" class="bg-gray-400 text-white rounded w-16 py-1">クリア</button>
            <button type="submit" class="bg-green-500 text-white rounded w-16 py-1">登録</button>
          </div>
        </div>
      </form>
    </div>

    <div id="history" class="tab-content hidden">
      <div id="historyPagination" class="mb-2 flex justify-center gap-1"></div>
      <div class="overflow-x-auto max-h-[75vh] overflow-y-auto">
        <table class="border text-sm min-w-[800px] table-fixed">
          <thead class="bg-gray-200 sticky top-0 z-10">
            <tr>
              <th class="border p-1">日付</th><th class="border p-1">店名</th><th class="border p-1">台番</th><th class="border p-1">機種名</th><th class="border p-1">種別</th><th class="border p-1">初当り</th><th class="border p-1">B</th><th class="border p-1">回転率</th><th class="border p-1">投資</th><th class="border p-1">出玉</th><th class="border p-1">収支</th><th class="border p-1">編集</th><th class="border p-1">削</th><th class="border p-1">備考</th>
            </tr>
          </thead>
          <tbody id="recordList"></tbody>
        </table>
      </div>
    </div>

    <div id="summary" class="tab-content hidden">
      <div class="space-y-3">
        <div class="text-lg font-semibold">全期間総収支：<span id="totalYen" class="font-bold text-blue-600">0</span></div>
        <div class="text-lg font-semibold">資産残高：<span id="totalAssetYen" class="font-bold text-green-600">0円</span></div>
        <div class="mb-2">
          <label class="text-sm">店舗切替:</label>
          <select id="shopFilter" class="border rounded p-1 text-sm"><option value="all">全店舗</option></select>
        </div>
        <div class="grid grid-cols-3 gap-2 text-[11px] bg-gray-50 p-2 rounded border">
          <div>46枚スロ：<span id="bal46">0</span></div>
          <div>6.25スロ：<span id="bal625">0</span></div>
          <div>5円スロ：<span id="bal5">0</span></div>
          <div>4円パチ：<span id="bal4">0</span></div>
          <div>1円パチ：<span id="bal1">0</span></div>
        </div>
        <div class="flex space-x-2 mt-2">
          <button class="period-btn bg-blue-500 text-white rounded px-3 py-1 text-sm" data-period="1">1ヶ月</button>
          <button class="period-btn bg-gray-300 rounded px-3 py-1 text-sm" data-period="3">3ヶ月</button>
          <button class="period-btn bg-gray-300 rounded px-3 py-1 text-sm" data-period="all">全期間</button>
        </div>
        <canvas id="chart" height="200"></canvas>
      </div>
      <form id="withdrawForm" class="p-2 border rounded bg-gray-50 mt-4">
        <h3 class="font-bold mb-1">出金処理</h3>
        <div class="flex flex-wrap gap-2 items-center text-sm">
          <input type="date" name="date" class="border p-1 rounded">
          <select name="shop" class="border p-1 rounded"></select>
          <select name="gameType" class="border p-1 rounded">
            <option value="slot625">6.25円スロット</option><option value="slot46">46枚スロット</option><option value="slot5">5円スロット</option><option value="pachi1">1円パチンコ</option><option value="pachi4">4円パチンコ</option>
          </select>
          <input type="number" name="ball" class="border p-1 rounded w-24" placeholder="玉/枚">
          <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">出金</button>
        </div>
      </form>
      <div id="calendarContainer" class="mt-4"></div>
      <div class="flex justify-between items-center mt-4">
        <div class="flex gap-2"><button id="exportBtn" class="bg-blue-500 text-white px-3 py-1 rounded">エクスポート</button><button id="importBtn" class="bg-green-500 text-white px-3 py-1 rounded">インポート</button><input type="file" id="importFile" accept=".json" class="hidden"></div>
        <button id="clearAllBtn" class="bg-red-500 text-white px-2 py-1 rounded text-sm">全削除</button>
      </div>
    </div>

    <div id="machineData" class="tab-content hidden">
      <form class="grid grid-cols-5 gap-2 items-end mb-2">
        <input type="text" id="searchShop" class="border p-2 rounded" placeholder="店名">
        <input type="text" id="searchMachineNo" class="border p-2 rounded" placeholder="台番">
        <input type="text" id="searchMachineName" class="border p-2 rounded" placeholder="機種名">
        <select id="searchGameType" class="border p-2 rounded">
          <option value="">全ての種別</option><option value="slot625">6.25円スロ</option><option value="slot46">46枚スロ</option><option value="slot5">5円スロ</option><option value="pachi1">1円パチ</option><option value="pachi4">4円パチ</option>
        </select>
        <button id="searchMachineBtn" class="bg-blue-500 text-white rounded p-2">検索</button>
      </form>
      <div class="overflow-x-auto max-h-[70vh] overflow-y-auto"><table class="border text-[11px] min-w-[850px] table-fixed"><thead class="bg-gray-200 sticky top-0 z-10"><tr><th class="border p-1">店名</th><th class="border p-1">台番</th><th class="border p-1">機種名</th><th class="border p-1">種別</th><th class="border p-1">プレイ</th><th class="border p-1">初当</th><th class="border p-1">突入</th><th class="border p-1">平均回率</th><th class="border p-1">平均当G</th><th class="border p-1">平均投資</th><th class="border p-1">合計収支</th><th class="border p-1">最大出玉</th><th class="border p-1">回収率</th></tr></thead><tbody id="machineDataList"></tbody></table></div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black/50 hidden justify-center items-center z-50">
      <div class="bg-white p-4 rounded shadow-lg w-96 max-h-[90vh] overflow-y-auto">
        <h2 class="font-bold mb-2 border-b">記録編集</h2>
        <form id="editForm" class="space-y-2 text-sm">
          <div class="flex gap-2"><input type="date" name="date" class="border p-1 w-1/2"><select name="gameType" class="border p-1 w-1/2"><option value="slot625">6.25スロ</option><option value="slot46">46枚スロ</option><option value="slot5">5円スロ</option><option value="pachi1">1円パチ</option><option value="pachi4">4円パチ</option></select></div>
          <input type="text" name="shop" class="border w-full p-1" placeholder="店名"><div class="flex gap-2"><input type="number" name="machineNo" class="border w-1/4 p-1" placeholder="台番"><input type="text" name="machineName" class="border w-3/4 p-1" placeholder="機種名"></div>
          <div class="grid grid-cols-2 gap-2"><label>開始G<input type="number" name="startGame" class="border w-full p-1"></label><label>開始玉<input type="number" name="startBall" class="border w-full p-1"></label><label>振替<input type="number" name="transfarBall" class="border w-full p-1"></label><label>現金<input type="number" name="cashBall" class="border w-full p-1"></label><label>当りG<input type="number" name="firstHitGame" class="border w-full p-1"></label><label>当り玉<input type="number" name="firstHitBall" class="border w-full p-1"></label></div>
          <div class="flex items-center justify-between"><label>単発<input type="checkbox" name="isSingleBonus" class="ml-1"></label><label class="w-2/3">終了玉<input type="number" name="endBall" class="border w-full p-1 bg-pink-50"></label></div>
          <input type="text" name="remarks" class="border w-full p-1" placeholder="備考">
          <div class="flex justify-end gap-2 mt-4"><button type="button" id="closeModal" class="bg-gray-300 px-4 py-1 rounded">キャンセル</button><button type="submit" class="bg-blue-500 text-white px-4 py-1 rounded">保存</button></div>
        </form>
      </div>
    </div>
    <div id="historyPopupModal" class="fixed inset-0 bg-black/60 hidden justify-center items-center z-[100]"><div class="bg-white p-4 rounded-xl shadow-2xl w-11/12 max-w-4xl max-h-[85vh] flex flex-col"><div class="flex justify-between items-center mb-3 border-b pb-2"><h2 id="popupTitle" class="font-bold text-gray-800 text-sm md:text-base">最新履歴</h2><button id="closePopup" class="text-3xl text-gray-400 hover:text-gray-800 leading-none">&times;</button></div><div class="overflow-x-auto flex-1 overflow-y-auto"><table class="border text-[10px] md:text-[11px] w-full table-auto"><thead class="bg-gray-100 sticky top-0"><tr><th class="border p-1">日付</th><th class="border p-1">店名</th><th class="border p-1">台番</th><th class="border p-1">初当(自)</th><th class="border p-1">B</th><th class="border p-1">回率</th><th class="border p-1">投資</th><th class="border p-1">出玉</th><th class="border p-1">収支</th><th class="border p-1">備考</th></tr></thead><tbody id="popupHistoryList"></tbody></table></div><div class="mt-3 text-right"><button id="closePopupBottom" class="bg-gray-200 px-6 py-1 rounded text-sm font-semibold">閉じる</button></div></div></div>

  </div>

<script>
const key = "pachi_records";
const rate = { pachi1: 0.8928, pachi4: 3.7143, slot46: 19.413, slot5: 4.4642, slot625: 5.625 };
const step = { pachi4: 125, pachi1: 100, slot46: 46, slot5: 100, slot625: 160 };
const investUnit = { pachi4: 250, pachi1: 200, slot46: 46, slot5: 50, slot625: 160 };
const addBallToYen = { pachi1: 1, pachi4: 4, slot5: 5, slot46: 1000/46, slot625: 6.25 };
const typeColors = { slot5: "bg-blue-200", slot625: "bg-purple-200", slot46: "bg-red-200", pachi1: "bg-green-200", pachi4: "bg-yellow-200" };
const typeLabels = { slot5: "5円S", slot625: "6.25S", slot46: "46枚S", pachi1: "1円P", pachi4: "4円P" };

const form = document.getElementById("recordForm");
const transfarInput = document.getElementById("transfarBall");
const cashInput = document.getElementById("cashBall");
const gameTypeSelect = document.getElementById("gameType");

function updateSelectColor() {
  gameTypeSelect.classList.remove("bg-blue-200", "bg-purple-200", "bg-red-200", "bg-green-200", "bg-yellow-200");
  const color = typeColors[gameTypeSelect.value];
  if(color) gameTypeSelect.classList.add(color);
}

document.getElementById("incTransfar").onclick = () => { transfarInput.value = Number(transfarInput.value||0) + step[gameTypeSelect.value]; updateIncome(); };
document.getElementById("decTransfar").onclick = () => { transfarInput.value = Math.max(0, Number(transfarInput.value||0) - step[gameTypeSelect.value]); updateIncome(); };
document.getElementById("incCash").onclick = () => { cashInput.value = Number(cashInput.value||0) + step[gameTypeSelect.value]; updateIncome(); };
document.getElementById("decCash").onclick = () => { cashInput.value = Math.max(0, Number(cashInput.value||0) - step[gameTypeSelect.value]); updateIncome(); };

function updateIncome() {
  const start = Number(form.startBall.value) || 0;
  const end = Number(form.endBall.value) || 0;
  const add = (Number(transfarInput.value) || 0) + (Number(cashInput.value) || 0);
  const firstBall = form.firstHitBall.value === "" ? null : Number(form.firstHitBall.value);
  const startG = Number(form.startGame.value) || 0;
  const endG = Number(form.firstHitGame.value) || 0;
  const type = gameTypeSelect.value;
  let used = (firstBall === null) ? (start + add - end) : (start + add - firstBall);
  if (used < 0) used = 0;
  const totalG = endG - startG;
  let rot = 0; if (used > 0 && totalG > 0) rot = (totalG * investUnit[type]) / used;
  document.getElementById("rotationDisplay").innerHTML = `回転率：<br>${rot ? rot.toFixed(1) + "回" : "0.00"}`;
  const diff = end - (start + add); const yen = Math.round(diff * (rate[type] || 0));
  document.getElementById("incomeDisplay").innerHTML = `現在収支：<br>${diff}（${yen.toLocaleString()}円）`;
}

["startBall","endBall","transfarBall","cashBall","startGame","firstHitBall","firstHitGame","gameType"].forEach(id => {
  const el = document.getElementById(id); if(el) el.addEventListener("input", () => { if(id==="gameType") updateSelectColor(); updateIncome(); });
});

// === クリアボタン修正 ===
document.getElementById("clearBtn").onclick = () => {
  if(!confirm("入力内容をすべてクリアしますか？")) return;
  form.reset();
  document.getElementById("date").value = new Date().toISOString().slice(0, 10);
  form.shop.value = "エスパス高田馬場";
  transfarInput.value = 0;
  cashInput.value = 0;
  updateSelectColor();
  updateIncome();
};

form.onsubmit = (e) => {
  e.preventDefault();
  if(!form.endBall.value) return alert("終了時玉数を入力してください");
  if(!confirm("登録しますか？")) return;
  const type = gameTypeSelect.value;
  const tBall = Number(transfarInput.value) || 0;
  const cBall = Number(cashInput.value) || 0;
  const startBall = Number(form.startBall.value) || 0;
  const endBall = Number(form.endBall.value) || 0
